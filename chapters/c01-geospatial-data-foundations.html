<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Building a GeoTIFF to Embeddings Pipeline</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/fontawesome6-1.2.0/all.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-1.2.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">GEOG 288KC</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">🏠 home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../Syllabus.html"> 
<span class="menu-text">📋 syllabus</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-weekly-sessions" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">💻 weekly sessions</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-weekly-sessions">    
        <li>
    <a class="dropdown-item" href="../chapters/c00a-foundation_model_architectures.html">
 <span class="dropdown-text">Session 0a - 🪜 Foundation Model Architectures</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c01-geospatial-data-foundations.html">
 <span class="dropdown-text">Session 1 - 📊 Geospatial Data Foundations</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c02-spatial-temporal-attention-mechanisms.html">
 <span class="dropdown-text">Session 2 - 🧠 Spatial-Temporal Attention Mechanisms</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c03-complete-gfm-architecture.html">
 <span class="dropdown-text">Session 3 - 🏗️ Complete GFM Architecture</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c04-pretraining-implementation.html">
 <span class="dropdown-text">Session 4 - 🔥 Pretraining Implementation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c05-training-loop-optimization.html">
 <span class="dropdown-text">Session 5 - ⚙️ Training Loop Optimization</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c06-model-evaluation-analysis.html">
 <span class="dropdown-text">Session 6 - 📈 Model Evaluation &amp; Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c07-integration-with-existing-models.html">
 <span class="dropdown-text">Session 7 - 🤝 Integration with Existing Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c08-task-specific-finetuning.html">
 <span class="dropdown-text">Session 8 - 🔧 Task-Specific Fine-tuning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c09-model-implementation-deployment.html">
 <span class="dropdown-text">Session 9 - ☁️ Model Implementation &amp; Deployment</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c10-project-presentations-synthesis.html">
 <span class="dropdown-text">Session 10 - 🎯 Project Presentations &amp; Synthesis</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-cheatsheets" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">👀 Cheatsheets</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-cheatsheets">    
        <li class="dropdown-header">🏗️ Foundation Models &amp; AI</li>
        <li>
    <a class="dropdown-item" href="../chapters/c00a-foundation_model_architectures.html">
 <span class="dropdown-text">Foundation Model Architectures</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/gfm_architecture.html">
 <span class="dropdown-text">GFM Architecture Cheatsheet</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/finetuning_basics.html">
 <span class="dropdown-text">Fine-tuning Basics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/multimodal_learning.html">
 <span class="dropdown-text">Multi-modal Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/model_evaluation_validation.html">
 <span class="dropdown-text">Model Evaluation &amp; Validation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/loading_models.html">
 <span class="dropdown-text">Loading Pre-trained Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/model_inference.html">
 <span class="dropdown-text">Model Inference &amp; Feature Extraction</span></a>
  </li>  
        <li class="dropdown-header">🗺️ Geospatial Data &amp; Remote Sensing</li>
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/geospatial_data_remote_sensing.html">
 <span class="dropdown-text">Geospatial Data &amp; Remote Sensing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/stac_apis.html">
 <span class="dropdown-text">STAC APIs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/rasterio_basics.html">
 <span class="dropdown-text">Rasterio Basics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/xarray_basics.html">
 <span class="dropdown-text">Xarray for Multi-dimensional Data</span></a>
  </li>  
        <li class="dropdown-header">🔥 PyTorch &amp; Deep Learning</li>
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/pytorch_tensors.html">
 <span class="dropdown-text">PyTorch Tensors</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/torchgeo_basics.html">
 <span class="dropdown-text">TorchGeo Datasets &amp; Transforms</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/dataloader_satellite.html">
 <span class="dropdown-text">Data Loading for Satellite Imagery</span></a>
  </li>  
        <li class="dropdown-header">📊 Visualization &amp; Analysis</li>
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/plotting_satellite.html">
 <span class="dropdown-text">Plotting Satellite Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/folium_basics.html">
 <span class="dropdown-text">Interactive Maps with Folium</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/matplotlib_geospatial.html">
 <span class="dropdown-text">Geospatial Plotting with Matplotlib</span></a>
  </li>  
        <li class="dropdown-header">☁️ Deployment &amp; Scaling</li>
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/cloud_scalable_computing.html">
 <span class="dropdown-text">Cloud &amp; Scalable Computing</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-extras" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">📖 extras</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-extras">    
        <li>
    <a class="dropdown-item" href="../extras/resources/course_resources.html">
 <span class="dropdown-text">📚 Reference Materials</span></a>
  </li>  
        <li class="dropdown-header">🎯 Practical Examples</li>
        <li>
    <a class="dropdown-item" href="../extras/examples/normalization_comparison.html">
 <span class="dropdown-text">Normalization Comparison</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/examples/resnet.html">
 <span class="dropdown-text">ResNet Implementation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/examples/text_encoder.html">
 <span class="dropdown-text">Text Encoder</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/examples/tiling-and-patches.html">
 <span class="dropdown-text">Tiling and Patches</span></a>
  </li>  
        <li class="dropdown-header">📁 Project Templates</li>
        <li>
    <a class="dropdown-item" href="../extras/projects/project-proposal-template.html">
 <span class="dropdown-text">Project Proposal Template</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/projects/mvp-template.html">
 <span class="dropdown-text">MVP Presentation Template</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/kcaylor/GEOG-288KC-geospatial-foundation-models" target="_blank"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-left">
      <div class="quarto-title-block"><div><h1 class="title">Building a GeoTIFF to Embeddings Pipeline</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
            <p class="subtitle lead">From raw satellite data to model-ready tensors</p>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta column-page-left">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#course-roadmap-mapping" id="toc-course-roadmap-mapping" class="nav-link" data-scroll-target="#course-roadmap-mapping">Course Roadmap Mapping</a>
  <ul class="collapse">
  <li><a href="#weekly-goals" id="toc-weekly-goals" class="nav-link" data-scroll-target="#weekly-goals">Weekly goals</a></li>
  </ul></li>
  <li><a href="#session-outline-and-tangled-code" id="toc-session-outline-and-tangled-code" class="nav-link" data-scroll-target="#session-outline-and-tangled-code">Session Outline (and Tangled Code)</a>
  <ul class="collapse">
  <li><a href="#package-inits" id="toc-package-inits" class="nav-link" data-scroll-target="#package-inits">Package inits</a></li>
  <li><a href="#typed-configs-geogfmcoreconfig.py" id="toc-typed-configs-geogfmcoreconfig.py" class="nav-link" data-scroll-target="#typed-configs-geogfmcoreconfig.py">1) Typed Configs → <code>geogfm/core/config.py</code></a></li>
  <li><a href="#normalization-transform-geogfmdatatransformsnormalization.py" id="toc-normalization-transform-geogfmdatatransformsnormalization.py" class="nav-link" data-scroll-target="#normalization-transform-geogfmdatatransformsnormalization.py">2) Normalization Transform → <code>geogfm/data/transforms/normalization.py</code></a></li>
  <li><a href="#minimal-stac-like-dataset-geogfmdatadatasetsstac_dataset.py" id="toc-minimal-stac-like-dataset-geogfmdatadatasetsstac_dataset.py" class="nav-link" data-scroll-target="#minimal-stac-like-dataset-geogfmdatadatasetsstac_dataset.py">4) Minimal STAC-like Dataset → <code>geogfm/data/datasets/stac_dataset.py</code></a></li>
  <li><a href="#dataloader-builders-geogfmdataloaders.py" id="toc-dataloader-builders-geogfmdataloaders.py" class="nav-link" data-scroll-target="#dataloader-builders-geogfmdataloaders.py">5) DataLoader Builders → <code>geogfm/data/loaders.py</code></a></li>
  </ul></li>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link" data-scroll-target="#learning-objectives">Learning Objectives</a></li>
  <li><a href="#session-roadmap" id="toc-session-roadmap" class="nav-link" data-scroll-target="#session-roadmap">Session Roadmap</a></li>
  <li><a href="#setting-up" id="toc-setting-up" class="nav-link" data-scroll-target="#setting-up">Setting Up</a>
  <ul class="collapse">
  <li><a href="#imports-and-configuration" id="toc-imports-and-configuration" class="nav-link" data-scroll-target="#imports-and-configuration">Imports and Configuration</a></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation">Data Preparation</a></li>
  </ul></li>
  <li><a href="#step-1-geotiff-loading-and-inspection" id="toc-step-1-geotiff-loading-and-inspection" class="nav-link" data-scroll-target="#step-1-geotiff-loading-and-inspection">Step 1: GeoTIFF Loading and Inspection</a>
  <ul class="collapse">
  <li><a href="#build-it-geotiff-loader-function" id="toc-build-it-geotiff-loader-function" class="nav-link" data-scroll-target="#build-it-geotiff-loader-function">🛠️ Build It: GeoTIFF Loader Function</a></li>
  <li><a href="#verify-it-inspect-your-data" id="toc-verify-it-inspect-your-data" class="nav-link" data-scroll-target="#verify-it-inspect-your-data">🔍 Verify It: Inspect Your Data</a></li>
  </ul></li>
  <li><a href="#step-2-geo-preprocessing-functions" id="toc-step-2-geo-preprocessing-functions" class="nav-link" data-scroll-target="#step-2-geo-preprocessing-functions">Step 2: Geo Preprocessing Functions</a>
  <ul class="collapse">
  <li><a href="#build-it-normalization-functions" id="toc-build-it-normalization-functions" class="nav-link" data-scroll-target="#build-it-normalization-functions">🛠️ Build It: Normalization Functions</a></li>
  <li><a href="#build-it-spatial-cropping-function" id="toc-build-it-spatial-cropping-function" class="nav-link" data-scroll-target="#build-it-spatial-cropping-function">🛠️ Build It: Spatial Cropping Function</a></li>
  </ul></li>
  <li><a href="#step-3-patch-extraction-with-metadata" id="toc-step-3-patch-extraction-with-metadata" class="nav-link" data-scroll-target="#step-3-patch-extraction-with-metadata">Step 3: Patch Extraction with Metadata</a>
  <ul class="collapse">
  <li><a href="#build-it-patch-extraction-function" id="toc-build-it-patch-extraction-function" class="nav-link" data-scroll-target="#build-it-patch-extraction-function">🛠️ Build It: Patch Extraction Function</a></li>
  </ul></li>
  <li><a href="#step-4-tensor-operations-metadata-encoding" id="toc-step-4-tensor-operations-metadata-encoding" class="nav-link" data-scroll-target="#step-4-tensor-operations-metadata-encoding">Step 4: Tensor Operations &amp; Metadata Encoding</a></li>
  <li><a href="#build-it-metadata-encoder" id="toc-build-it-metadata-encoder" class="nav-link" data-scroll-target="#build-it-metadata-encoder">🛠️ Build It: Metadata Encoder</a>
  <ul class="collapse">
  <li><a href="#build-it-tensor-conversion" id="toc-build-it-tensor-conversion" class="nav-link" data-scroll-target="#build-it-tensor-conversion">🛠️ Build It: Tensor Conversion</a></li>
  <li><a href="#step-5-dataloader-construction" id="toc-step-5-dataloader-construction" class="nav-link" data-scroll-target="#step-5-dataloader-construction">Step 5: DataLoader Construction</a>
  <ul class="collapse">
  <li><a href="#build-it-custom-dataset-class" id="toc-build-it-custom-dataset-class" class="nav-link" data-scroll-target="#build-it-custom-dataset-class">🛠️ Build It: Custom Dataset Class</a></li>
  <li><a href="#build-it-dataloader" id="toc-build-it-dataloader" class="nav-link" data-scroll-target="#build-it-dataloader">🛠️ Build It: DataLoader</a></li>
  </ul></li>
  <li><a href="#step-6-embedding-layer-integration" id="toc-step-6-embedding-layer-integration" class="nav-link" data-scroll-target="#step-6-embedding-layer-integration">Step 6: Embedding Layer Integration</a>
  <ul class="collapse">
  <li><a href="#build-it-simple-gfm-embedding-layer" id="toc-build-it-simple-gfm-embedding-layer" class="nav-link" data-scroll-target="#build-it-simple-gfm-embedding-layer">🛠️ Build It: Simple GFM Embedding Layer</a></li>
  </ul></li>
  <li><a href="#step-7-end-to-end-pipeline-test" id="toc-step-7-end-to-end-pipeline-test" class="nav-link" data-scroll-target="#step-7-end-to-end-pipeline-test">Step 7: End-to-End Pipeline Test</a>
  <ul class="collapse">
  <li><a href="#build-it-complete-pipeline-function" id="toc-build-it-complete-pipeline-function" class="nav-link" data-scroll-target="#build-it-complete-pipeline-function">🛠️ Build It: Complete Pipeline Function</a></li>
  <li><a href="#verify-it-pipeline-output-analysis" id="toc-verify-it-pipeline-output-analysis" class="nav-link" data-scroll-target="#verify-it-pipeline-output-analysis">🔍 Verify It: Pipeline Output Analysis</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a>
  <ul class="collapse">
  <li><a href="#what-you-built" id="toc-what-you-built" class="nav-link" data-scroll-target="#what-you-built">What You Built:</a></li>
  <li><a href="#key-insights" id="toc-key-insights" class="nav-link" data-scroll-target="#key-insights">Key Insights:</a></li>
  <li><a href="#whats-next" id="toc-whats-next" class="nav-link" data-scroll-target="#whats-next">What’s Next:</a></li>
  </ul></li>
  <li><a href="#resources" id="toc-resources" class="nav-link" data-scroll-target="#resources">Resources</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block column-page-left" id="quarto-document-content">





<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Today we’re building a complete pipeline that transforms raw satellite imagery into model-ready embeddings. This mirrors how Large Language Models process text: <strong>raw text → tokens → embeddings</strong>. Our geospatial version: <strong>raw GeoTIFF → patches → embeddings</strong>.</p>
</section>
<section id="course-roadmap-mapping" class="level2">
<h2 class="anchored" data-anchor-id="course-roadmap-mapping">Course Roadmap Mapping</h2>
<p>This week’s work in the broader GFM plan.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 37%">
<col style="width: 21%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th>Week</th>
<th>Stage</th>
<th>Focus</th>
<th>You will build (geogfm)</th>
<th>Library tools</th>
<th>Outcome</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Stage 1: Build GFM Architecture</td>
<td>Data Foundations</td>
<td><code>core/config.py</code>; <code>data/datasets/stac_dataset.py</code>; <code>data/transforms/{normalization.py, patchify.py}</code>; <code>data/loaders.py</code></td>
<td><code>torch.utils.data.Dataset</code>/<code>DataLoader</code>, <code>rasterio</code>, <code>numpy</code></td>
<td>Config-driven dataloaders that yield normalized patches</td>
</tr>
</tbody>
</table>
<section id="weekly-goals" class="level3">
<h3 class="anchored" data-anchor-id="weekly-goals">Weekly goals</h3>
<ul>
<li>Implement a minimal dataset, transforms, and dataloaders</li>
<li>Normalize channels; extract patches deterministically</li>
<li>Verify shapes/CRS/stats prints; run a tiny DataLoader</li>
</ul>
</section>
</section>
<section id="session-outline-and-tangled-code" class="level2">
<h2 class="anchored" data-anchor-id="session-outline-and-tangled-code">Session Outline (and Tangled Code)</h2>
<ul>
<li>Concepts → Components mapping
<ul>
<li>Configuration schemas → <code>core/config.py</code></li>
<li>Normalization and patchifying transforms → <code>data/transforms/{normalization.py, patchify.py}</code></li>
<li>Minimal STAC-like dataset → <code>data/datasets/stac_dataset.py</code></li>
<li>DataLoader builders → <code>data/loaders.py</code></li>
<li>Package init files → <code>geogfm/__init__.py</code> and subpackages</li>
</ul></li>
</ul>
<section id="package-inits" class="level3">
<h3 class="anchored" data-anchor-id="package-inits">Package inits</h3>
<div id="5a53baf3" class="cell" data-tangle="/geogfm/__init__.py" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># GeogFM package init (Week 1)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/__init__.py`</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Provides base package visibility for data + core modules</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c9e99b90" class="cell" data-tangle="geogfm/core/__init__.py" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Core subpackage init (Week 1)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/core/__init__.py`</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Exposes config schemas</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="071b7494" class="cell" data-tangle="geogfm/data/__init__.py" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data subpackage init (Week 1)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/data/__init__.py`</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Exposes datasets, loaders, and transforms</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="69f5e7f2" class="cell" data-tangle="geogfm/data/datasets/__init__.py" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Datasets init (Week 1)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/data/datasets/__init__.py`</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Exposes minimal STAC-like dataset</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d3832e20" class="cell" data-tangle="geogfm/data/transforms/__init__.py" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Transforms init (Week 1)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/data/transforms/__init__.py`</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Exposes normalization and patchify transforms</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="typed-configs-geogfmcoreconfig.py" class="level3">
<h3 class="anchored" data-anchor-id="typed-configs-geogfmcoreconfig.py">1) Typed Configs → <code>geogfm/core/config.py</code></h3>
<div id="112fdc9c" class="cell" data-tangle="geogfm/core/config.py" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Typed configuration schemas (Week 1)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/core/config.py`</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass, field</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, Any, Optional</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelConfig:</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    architecture: <span class="bu">str</span> <span class="op">=</span> <span class="st">"gfm_vit"</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    in_channels: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    image_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    patch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    embed_dim: <span class="bu">int</span> <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    depth: <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    num_heads: <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    mlp_ratio: <span class="bu">float</span> <span class="op">=</span> <span class="fl">4.0</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataConfig:</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    dataset: <span class="bu">str</span> <span class="op">=</span> <span class="st">"stac"</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    root_dir: <span class="bu">str</span> <span class="op">=</span> <span class="st">"data/out"</span>  <span class="co"># or a small sample dir</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    split: <span class="bu">str</span> <span class="op">=</span> <span class="st">"train"</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    image_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    in_channels: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    length: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span>  <span class="co"># synthetic length fallback</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    num_workers: <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    batch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    seed: <span class="bu">int</span> <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TrainConfig:</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    epochs: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    batch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    optimizer: Dict[<span class="bu">str</span>, Any] <span class="op">=</span> field(</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>        default_factory<span class="op">=</span><span class="kw">lambda</span>: {<span class="st">"name"</span>: <span class="st">"adamw"</span>, <span class="st">"lr"</span>: <span class="fl">2e-4</span>})</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    device: <span class="bu">str</span> <span class="op">=</span> <span class="st">"cpu"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="normalization-transform-geogfmdatatransformsnormalization.py" class="level3">
<h3 class="anchored" data-anchor-id="normalization-transform-geogfmdatatransformsnormalization.py">2) Normalization Transform → <code>geogfm/data/transforms/normalization.py</code></h3>
<div id="85ab3c69" class="cell" data-tangle="geogfm/data/transforms/normalization.py" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Channel-wise normalization utilities (Week 1)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/data/transforms/normalization.py`</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple, Dict, Any, Optional</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>Array <span class="op">=</span> np.ndarray</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> minmax_normalize(data: Array, global_min: Optional[Array] <span class="op">=</span> <span class="va">None</span>, global_max: Optional[Array] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">tuple</span>[Array, <span class="bu">dict</span>]:</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    bands, height, width <span class="op">=</span> data.shape</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    normalized <span class="op">=</span> np.zeros_like(data, dtype<span class="op">=</span>np.float32)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> global_min <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> global_max <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        mins <span class="op">=</span> np.array([data[i].<span class="bu">min</span>() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands)], dtype<span class="op">=</span>np.float32)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        maxs <span class="op">=</span> np.array([data[i].<span class="bu">max</span>() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands)], dtype<span class="op">=</span>np.float32)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        src <span class="op">=</span> <span class="st">"local"</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        mins, maxs, src <span class="op">=</span> global_min.astype(np.float32), global_max.astype(np.float32), <span class="st">"global"</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands):</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        rng <span class="op">=</span> maxs[i] <span class="op">-</span> mins[i]</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> rng <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>            normalized[i] <span class="op">=</span> (data[i] <span class="op">-</span> mins[i]) <span class="op">/</span> rng</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>            normalized[i] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> {<span class="st">"source"</span>: src, <span class="st">"mins"</span>: mins, <span class="st">"maxs"</span>: maxs, <span class="st">"output_range"</span>: (<span class="bu">float</span>(normalized.<span class="bu">min</span>()), <span class="bu">float</span>(normalized.<span class="bu">max</span>()))}</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> normalized, stats</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> zscore_normalize(data: Array, global_mean: Optional[Array] <span class="op">=</span> <span class="va">None</span>, global_std: Optional[Array] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">tuple</span>[Array, <span class="bu">dict</span>]:</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    bands, height, width <span class="op">=</span> data.shape</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    normalized <span class="op">=</span> np.zeros_like(data, dtype<span class="op">=</span>np.float32)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> global_mean <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> global_std <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>        means <span class="op">=</span> np.array([data[i].mean() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands)], dtype<span class="op">=</span>np.float32)</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>        stds <span class="op">=</span> np.array([data[i].std() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands)], dtype<span class="op">=</span>np.float32)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>        src <span class="op">=</span> <span class="st">"local"</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>        means, stds, src <span class="op">=</span> global_mean.astype(np.float32), global_std.astype(np.float32), <span class="st">"global"</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands):</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stds[i] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>            normalized[i] <span class="op">=</span> (data[i] <span class="op">-</span> means[i]) <span class="op">/</span> stds[i]</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>            normalized[i] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> {<span class="st">"source"</span>: src, <span class="st">"means"</span>: means, <span class="st">"stds"</span>: stds, <span class="st">"output_mean"</span>: <span class="bu">float</span>(normalized.mean()), <span class="st">"output_std"</span>: <span class="bu">float</span>(normalized.std())}</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> normalized, stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="minimal-stac-like-dataset-geogfmdatadatasetsstac_dataset.py" class="level3">
<h3 class="anchored" data-anchor-id="minimal-stac-like-dataset-geogfmdatadatasetsstac_dataset.py">4) Minimal STAC-like Dataset → <code>geogfm/data/datasets/stac_dataset.py</code></h3>
<div id="6156d080" class="cell" data-tangle="geogfm/data/datasets/stac_dataset.py" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Minimal STAC-like dataset (Week 1)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/data/datasets/stac_dataset.py`</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">#| auto-imports: true</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Optional</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio <span class="im">as</span> rio</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> StacLikeDataset(Dataset):</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Minimal dataset reading GeoTIFF files under a directory, or generating synthetic data.</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns images sized to (C, H, W) where H=W=image_size and divisible by patch size.</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, root_dir: <span class="bu">str</span>, split: <span class="bu">str</span> <span class="op">=</span> <span class="st">"train"</span>, image_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span>, in_channels: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span>, length: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span>, seed: <span class="bu">int</span> <span class="op">=</span> <span class="dv">42</span>):</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.root <span class="op">=</span> Path(root_dir)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.split <span class="op">=</span> split</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_size <span class="op">=</span> <span class="bu">int</span>(image_size)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.in_channels <span class="op">=</span> <span class="bu">int</span>(in_channels)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.length <span class="op">=</span> <span class="bu">int</span>(length)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rng <span class="op">=</span> random.Random(seed)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.files: List[Path] <span class="op">=</span> []</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.root.exists():</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> p <span class="kw">in</span> <span class="va">self</span>.root.rglob(<span class="st">"*.tif"</span>):</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.files.append(p)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> split <span class="op">==</span> <span class="st">"val"</span>:</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.files <span class="op">=</span> <span class="va">self</span>.files[::<span class="dv">5</span>]</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> split <span class="op">==</span> <span class="st">"train"</span>:</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.files <span class="op">=</span> [p <span class="cf">for</span> i, p <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.files) <span class="cf">if</span> i <span class="op">%</span> <span class="dv">5</span> <span class="op">!=</span> <span class="dv">0</span>]</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">max</span>(<span class="bu">len</span>(<span class="va">self</span>.files), <span class="va">self</span>.length)</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _load_or_synthesize(<span class="va">self</span>, idx: <span class="bu">int</span>) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.files:</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>            path <span class="op">=</span> <span class="va">self</span>.files[idx <span class="op">%</span> <span class="bu">len</span>(<span class="va">self</span>.files)]</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> rio.<span class="bu">open</span>(path) <span class="im">as</span> src:</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>                arr <span class="op">=</span> src.read(out_shape<span class="op">=</span>(<span class="bu">min</span>(<span class="va">self</span>.in_channels, src.count), <span class="va">self</span>.image_size, <span class="va">self</span>.image_size))</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> arr.shape[<span class="dv">0</span>] <span class="op">&lt;</span> <span class="va">self</span>.in_channels:</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>                    pad <span class="op">=</span> np.zeros((<span class="va">self</span>.in_channels <span class="op">-</span> arr.shape[<span class="dv">0</span>], <span class="va">self</span>.image_size, <span class="va">self</span>.image_size), dtype<span class="op">=</span>arr.dtype)</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>                    arr <span class="op">=</span> np.concatenate([arr, pad], axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> arr.astype(np.float32)</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># synthetic fallback</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rng.seed(idx)</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.random.rand(<span class="va">self</span>.in_channels, <span class="va">self</span>.image_size, <span class="va">self</span>.image_size).astype(np.float32)</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx: <span class="bu">int</span>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>        arr <span class="op">=</span> <span class="va">self</span>._load_or_synthesize(idx)</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.from_numpy(arr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dataloader-builders-geogfmdataloaders.py" class="level3">
<h3 class="anchored" data-anchor-id="dataloader-builders-geogfmdataloaders.py">5) DataLoader Builders → <code>geogfm/data/loaders.py</code></h3>
<div id="e9699b9d" class="cell" data-tangle="geogfm/data/loaders.py" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DataLoader builders (Week 1)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/data/loaders.py`</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geogfm.core.config <span class="im">import</span> DataConfig</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geogfm.data.datasets.stac_dataset <span class="im">import</span> StacLikeDataset</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_dataloader(cfg: DataConfig) <span class="op">-&gt;</span> Tuple[DataLoader, DataLoader]:</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    train_ds <span class="op">=</span> StacLikeDataset(cfg.root_dir, split<span class="op">=</span><span class="st">"train"</span>, image_size<span class="op">=</span>cfg.image_size, in_channels<span class="op">=</span>cfg.in_channels, length<span class="op">=</span>cfg.length, seed<span class="op">=</span>cfg.seed)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    val_ds <span class="op">=</span> StacLikeDataset(cfg.root_dir, split<span class="op">=</span><span class="st">"val"</span>, image_size<span class="op">=</span>cfg.image_size, in_channels<span class="op">=</span>cfg.in_channels, length<span class="op">=</span><span class="bu">max</span>(<span class="dv">8</span>, cfg.length <span class="op">//</span> <span class="dv">5</span>), seed<span class="op">=</span>cfg.seed)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    train_dl <span class="op">=</span> DataLoader(train_ds, batch_size<span class="op">=</span>cfg.batch_size, shuffle<span class="op">=</span><span class="va">True</span>, num_workers<span class="op">=</span>cfg.num_workers, pin_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    val_dl <span class="op">=</span> DataLoader(val_ds, batch_size<span class="op">=</span>cfg.batch_size, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span>cfg.num_workers, pin_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_dl, val_dl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="learning-objectives" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives">Learning Objectives</h2>
<p>By building this pipeline, you will: - <strong>Implement</strong> GeoTIFF loading and preprocessing functions - <strong>Create</strong> patch extraction with spatial metadata - <strong>Build</strong> tensor normalization and encoding functions<br>
- <strong>Construct</strong> a PyTorch DataLoader for model training - <strong>Connect</strong> to a simple embedding layer to verify end-to-end functionality</p>
</section>
<section id="session-roadmap" class="level2">
<h2 class="anchored" data-anchor-id="session-roadmap">Session Roadmap</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TD
    A["Setup &amp; GeoTIFF Loading"] --&gt; B["Geo Preprocessing Functions"]
    B --&gt; C["Patch Extraction with Metadata"] 
    C --&gt; D["Tensor Operations &amp; Normalization"]
    D --&gt; E["DataLoader Construction"]
    E --&gt; F["Embedding Layer Integration"]
    F --&gt; G["End-to-End Pipeline Test"]
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="setting-up" class="level2">
<h2 class="anchored" data-anchor-id="setting-up">Setting Up</h2>
<p>Let’s establish our development environment and define the core constants we’ll use throughout.</p>
<section id="imports-and-configuration" class="level3">
<h3 class="anchored" data-anchor-id="imports-and-configuration">Imports and Configuration</h3>
<div id="22503d4e" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset, DataLoader</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio <span class="im">as</span> rio</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple, Dict, Any</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Set seeds for reproducibility</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>SEED <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>random.seed(SEED)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>np.random.seed(SEED)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>torch.manual_seed(SEED)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline constants</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>PATCH_SIZE <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>STRIDE <span class="op">=</span> <span class="dv">32</span>  <span class="co"># 50% overlap</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>EMBEDDING_DIM <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Environment setup complete"</span>)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Patch size: </span><span class="sc">{</span>PATCH_SIZE<span class="sc">}</span><span class="ss">x</span><span class="sc">{</span>PATCH_SIZE<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Stride: </span><span class="sc">{</span>STRIDE<span class="sc">}</span><span class="ss"> (overlap: </span><span class="sc">{</span>(PATCH_SIZE<span class="op">-</span>STRIDE)<span class="op">/</span>PATCH_SIZE<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">%)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Environment setup complete
✓ Patch size: 64x64
✓ Stride: 32 (overlap: 50%)</code></pre>
</div>
</div>
</section>
<section id="data-preparation" class="level3">
<h3 class="anchored" data-anchor-id="data-preparation">Data Preparation</h3>
<div id="0efe0c04" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up data paths - use book/data for course sample data</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"__file__"</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># From chapters folder, go up 2 levels to book folder, then to data</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    DATA_DIR <span class="op">=</span> Path(<span class="va">__file__</span>).parent.parent <span class="op">/</span> <span class="st">"data"</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fallback for interactive environments - look for book folder</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    current <span class="op">=</span> Path.cwd()</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> current.name <span class="kw">not</span> <span class="kw">in</span> [<span class="st">"book"</span>, <span class="st">"geoAI"</span>] <span class="kw">and</span> current.parent <span class="op">!=</span> current:</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        current <span class="op">=</span> current.parent</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> current.name <span class="op">==</span> <span class="st">"book"</span>:</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        DATA_DIR <span class="op">=</span> current <span class="op">/</span> <span class="st">"data"</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> current.name <span class="op">==</span> <span class="st">"geoAI"</span>:</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        DATA_DIR <span class="op">=</span> current <span class="op">/</span> <span class="st">"book"</span> <span class="op">/</span> <span class="st">"data"</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        DATA_DIR <span class="op">=</span> Path(<span class="st">"data"</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>DATA_DIR.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>SAMPLE_PATH <span class="op">=</span> DATA_DIR <span class="op">/</span> <span class="st">"landcover_sample.tif"</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify data file exists</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> SAMPLE_PATH.exists():</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="ss">f"Data file not found at </span><span class="sc">{</span>SAMPLE_PATH<span class="sc">}</span><span class="ss">. Please ensure the landcover_sample.tif file is available in the data directory."</span>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Data ready: </span><span class="sc">{</span>SAMPLE_PATH<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ File size: </span><span class="sc">{</span>SAMPLE_PATH<span class="sc">.</span>stat()<span class="sc">.</span>st_size <span class="op">/</span> <span class="dv">1024</span><span class="sc">:.1f}</span><span class="ss"> KB"</span>)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Full path: </span><span class="sc">{</span>SAMPLE_PATH<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Data ready: landcover_sample.tif
✓ File size: 12.6 KB
✓ Full path: /Users/kellycaylor/dev/geoAI/book/data/landcover_sample.tif</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="step-1-geotiff-loading-and-inspection" class="level2">
<h2 class="anchored" data-anchor-id="step-1-geotiff-loading-and-inspection">Step 1: GeoTIFF Loading and Inspection</h2>
<p><strong>Goal</strong>: Build a function that loads and extracts essential information from any GeoTIFF.</p>
<section id="build-it-geotiff-loader-function" class="level3">
<h3 class="anchored" data-anchor-id="build-it-geotiff-loader-function">🛠️ Build It: GeoTIFF Loader Function</h3>
<p>Your task: Complete this function to load a GeoTIFF and return both the data and metadata.</p>
<div id="4138112a" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_geotiff(file_path: Path) <span class="op">-&gt;</span> Tuple[np.ndarray, Dict[<span class="bu">str</span>, Any]]:</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Load a GeoTIFF and extract data + metadata.</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">        data: (bands, height, width) array</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">        metadata: dict with CRS, transform, resolution, etc.</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> rio.<span class="bu">open</span>(file_path) <span class="im">as</span> src:</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: Load the data array</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> src.read()  <span class="co"># YOUR CODE: Load raster data</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: Extract metadata</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        metadata <span class="op">=</span> {</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">'crs'</span>: src.crs,  <span class="co"># YOUR CODE: Get coordinate reference system</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">'transform'</span>: src.transform,  <span class="co"># YOUR CODE: Get geospatial transform</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">'shape'</span>: data.shape,  <span class="co"># YOUR CODE: Get array dimensions</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">'dtype'</span>: data.dtype,  <span class="co"># YOUR CODE: Get data type</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">'resolution'</span>: src.res,  <span class="co"># YOUR CODE: Get pixel resolution</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">'bounds'</span>: src.bounds,  <span class="co"># YOUR CODE: Get spatial bounds</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data, metadata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3eacf076" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test your function</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>data, metadata <span class="op">=</span> load_geotiff(SAMPLE_PATH)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Loaded shape: </span><span class="sc">{</span>data<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Data type: </span><span class="sc">{</span>metadata[<span class="st">'dtype'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Resolution: </span><span class="sc">{</span>metadata[<span class="st">'resolution'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ CRS: </span><span class="sc">{</span>metadata[<span class="st">'crs'</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Loaded shape: (3, 64, 64)
✓ Data type: uint8
✓ Resolution: (0.25, 0.25)
✓ CRS: PROJCS["Projection: Transverse Mercator; Datum: WGS84; Ellipsoid: WGS84",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",19],PARAMETER["scale_factor",0.9993],PARAMETER["false_easting",500000],PARAMETER["false_northing",-5300000],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH]]</code></pre>
</div>
</div>
</section>
<section id="verify-it-inspect-your-data" class="level3">
<h3 class="anchored" data-anchor-id="verify-it-inspect-your-data">🔍 Verify It: Inspect Your Data</h3>
<div id="5d658a42" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine the data you loaded</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>bands, height, width <span class="op">=</span> data.shape</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Image dimensions: </span><span class="sc">{</span>height<span class="sc">}</span><span class="ss">×</span><span class="sc">{</span>width<span class="sc">}</span><span class="ss"> pixels"</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of bands: </span><span class="sc">{</span>bands<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Value ranges per band:"</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, band <span class="kw">in</span> <span class="bu">enumerate</span>(data):</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Band </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>band<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss"> to </span><span class="sc">{</span>band<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss">"</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick visualization</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, bands, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> bands <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    axes <span class="op">=</span> [axes]</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, band <span class="kw">in</span> <span class="bu">enumerate</span>(data):</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    axes[i].imshow(band, cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    axes[i].set_title(<span class="ss">f'Band </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    axes[i].axis(<span class="st">'off'</span>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">'Raw Satellite Bands'</span>)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Image dimensions: 64×64 pixels
Number of bands: 3
Value ranges per band:
  Band 1: 0 to 254
  Band 2: 0 to 254
  Band 3: 0 to 254</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="c01-geospatial-data-foundations_files/figure-html/cell-16-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="step-2-geo-preprocessing-functions" class="level2">
<h2 class="anchored" data-anchor-id="step-2-geo-preprocessing-functions">Step 2: Geo Preprocessing Functions</h2>
<p><strong>Goal</strong>: Build preprocessing functions that operate on the full image before patch extraction.</p>
<section id="build-it-normalization-functions" class="level3">
<h3 class="anchored" data-anchor-id="build-it-normalization-functions">🛠️ Build It: Normalization Functions</h3>
<p>We’ll create two normalization functions that can work with either <strong>local statistics</strong> (calculated from the input data) or <strong>global statistics</strong> (pre-computed from a training dataset). Global statistics ensure consistent normalization across different image tiles and are crucial for foundation model training.</p>
<p><strong>Why use global statistics?</strong> When training on multiple images, each tile might have different value ranges. Using global statistics ensures that the same pixel value represents the same relative intensity across all training data.</p>
<section id="min-max-normalization-function" class="level4">
<h4 class="anchored" data-anchor-id="min-max-normalization-function">Min-Max Normalization Function</h4>
<div id="47841ae2" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> minmax_normalize(data: np.ndarray, </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                    global_min: np.ndarray <span class="op">=</span> <span class="va">None</span>, </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                    global_max: np.ndarray <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">tuple</span>[np.ndarray, <span class="bu">dict</span>]:</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Min-max normalize spectral bands to [0,1] range.</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">        data: (bands, height, width) array</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">        global_min: Optional (bands,) array of global minimums per band</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">        global_max: Optional (bands,) array of global maximums per band</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">        normalized: (bands, height, width) array with values in [0,1]</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">        stats: Dictionary containing the min/max values used</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    bands, height, width <span class="op">=</span> data.shape</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    normalized <span class="op">=</span> np.zeros_like(data, dtype<span class="op">=</span>np.float32)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use global stats if provided, otherwise calculate from data</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> global_min <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> global_max <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate per-band statistics from this data</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>        mins <span class="op">=</span> np.array([data[i].<span class="bu">min</span>() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands)])</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>        maxs <span class="op">=</span> np.array([data[i].<span class="bu">max</span>() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands)])</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>        stats_source <span class="op">=</span> <span class="st">"local (calculated from input)"</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use provided global statistics</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>        mins <span class="op">=</span> global_min</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>        maxs <span class="op">=</span> global_max</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>        stats_source <span class="op">=</span> <span class="st">"global (provided)"</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply normalization per band</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands):</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>        band_range <span class="op">=</span> maxs[i] <span class="op">-</span> mins[i]</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> band_range <span class="op">&gt;</span> <span class="dv">0</span>:  <span class="co"># Avoid division by zero</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>            normalized[i] <span class="op">=</span> (data[i] <span class="op">-</span> mins[i]) <span class="op">/</span> band_range</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>            normalized[i] <span class="op">=</span> <span class="dv">0</span>  <span class="co"># Handle constant bands</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Package statistics for inspection</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> {</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">'source'</span>: stats_source,</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mins'</span>: mins,</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">'maxs'</span>: maxs,</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">'output_range'</span>: (normalized.<span class="bu">min</span>(), normalized.<span class="bu">max</span>())</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> normalized, stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="z-score-normalization-function" class="level4">
<h4 class="anchored" data-anchor-id="z-score-normalization-function">Z-Score Normalization Function</h4>
<div id="90395fc8" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> zscore_normalize(data: np.ndarray,</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                    global_mean: np.ndarray <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                    global_std: np.ndarray <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">tuple</span>[np.ndarray, <span class="bu">dict</span>]:</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Z-score normalize spectral bands to mean=0, std=1.</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co">        data: (bands, height, width) array</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co">        global_mean: Optional (bands,) array of global means per band</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">        global_std: Optional (bands,) array of global standard deviations per band</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co">        normalized: (bands, height, width) standardized array</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co">        stats: Dictionary containing the mean/std values used</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    bands, height, width <span class="op">=</span> data.shape</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    normalized <span class="op">=</span> np.zeros_like(data, dtype<span class="op">=</span>np.float32)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use global stats if provided, otherwise calculate from data</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> global_mean <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> global_std <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate per-band statistics from this data</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>        means <span class="op">=</span> np.array([data[i].mean() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands)])</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>        stds <span class="op">=</span> np.array([data[i].std() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands)])</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>        stats_source <span class="op">=</span> <span class="st">"local (calculated from input)"</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use provided global statistics</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>        means <span class="op">=</span> global_mean</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>        stds <span class="op">=</span> global_std</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>        stats_source <span class="op">=</span> <span class="st">"global (provided)"</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply normalization per band</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands):</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stds[i] <span class="op">&gt;</span> <span class="dv">0</span>:  <span class="co"># Avoid division by zero</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>            normalized[i] <span class="op">=</span> (data[i] <span class="op">-</span> means[i]) <span class="op">/</span> stds[i]</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>            normalized[i] <span class="op">=</span> <span class="dv">0</span>  <span class="co"># Handle constant bands</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Package statistics for inspection</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> {</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">'source'</span>: stats_source,</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">'means'</span>: means,</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">'stds'</span>: stds,</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">'output_mean'</span>: normalized.mean(),</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">'output_std'</span>: normalized.std()</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> normalized, stats</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ Normalization functions created"</span>)</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  - minmax_normalize: scales to [0,1] range"</span>)</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  - zscore_normalize: standardizes to mean=0, std=1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Normalization functions created
  - minmax_normalize: scales to [0,1] range
  - zscore_normalize: standardizes to mean=0, std=1</code></pre>
</div>
</div>
</section>
<section id="test-both-functions-with-local-statistics" class="level4">
<h4 class="anchored" data-anchor-id="test-both-functions-with-local-statistics">Test Both Functions with Local Statistics</h4>
<div id="91f7ac09" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test min-max normalization with local statistics</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>minmax_data, minmax_stats <span class="op">=</span> minmax_normalize(data)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"📊 Min-Max Normalization (local stats):"</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Source: </span><span class="sc">{</span>minmax_stats[<span class="st">'source'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Original range: </span><span class="sc">{</span>data<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss"> to </span><span class="sc">{</span>data<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss">"</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Normalized range: </span><span class="sc">{</span>minmax_stats[<span class="st">'output_range'</span>][<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss"> to </span><span class="sc">{</span>minmax_stats[<span class="st">'output_range'</span>][<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Per-band mins: </span><span class="sc">{</span>minmax_stats[<span class="st">'mins'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Per-band maxs: </span><span class="sc">{</span>minmax_stats[<span class="st">'maxs'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Test z-score normalization with local statistics  </span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>zscore_data, zscore_stats <span class="op">=</span> zscore_normalize(data)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"📊 Z-Score Normalization (local stats):"</span>)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Source: </span><span class="sc">{</span>zscore_stats[<span class="st">'source'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Output mean: </span><span class="sc">{</span>zscore_stats[<span class="st">'output_mean'</span>]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Output std: </span><span class="sc">{</span>zscore_stats[<span class="st">'output_std'</span>]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Per-band means: </span><span class="sc">{</span>zscore_stats[<span class="st">'means'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Per-band stds: </span><span class="sc">{</span>zscore_stats[<span class="st">'stds'</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>📊 Min-Max Normalization (local stats):
  Source: local (calculated from input)
  Original range: 0 to 254
  Normalized range: 0.000 to 1.000
  Per-band mins: [0 0 0]
  Per-band maxs: [254 254 254]

📊 Z-Score Normalization (local stats):
  Source: local (calculated from input)
  Output mean: 0.000000
  Output std: 1.000000
  Per-band means: [126.14306641 126.14306641 126.14306641]
  Per-band stds: [73.10237725 73.10237725 73.10237725]</code></pre>
</div>
</div>
</section>
<section id="test-with-global-statistics" class="level4">
<h4 class="anchored" data-anchor-id="test-with-global-statistics">Test with Global Statistics</h4>
<div id="6705fb7a" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate global statistics from a larger dataset</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># In practice, these would be pre-computed from your entire training corpus</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>global_mins <span class="op">=</span> np.array([<span class="dv">100</span>, <span class="dv">150</span>, <span class="dv">200</span>])  <span class="co"># Example global minimums per band</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>global_maxs <span class="op">=</span> np.array([<span class="dv">1500</span>, <span class="dv">2000</span>, <span class="dv">2500</span>])  <span class="co"># Example global maximums per band</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>global_means <span class="op">=</span> np.array([<span class="dv">800</span>, <span class="dv">1200</span>, <span class="dv">1600</span>])  <span class="co"># Example global means per band</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>global_stds <span class="op">=</span> np.array([<span class="dv">300</span>, <span class="dv">400</span>, <span class="dv">500</span>])  <span class="co"># Example global standard deviations per band</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"🌍 Testing with Global Statistics:"</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Global mins: </span><span class="sc">{</span>global_mins<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Global maxs: </span><span class="sc">{</span>global_maxs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Global means: </span><span class="sc">{</span>global_means<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Global stds: </span><span class="sc">{</span>global_stds<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with global statistics</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>minmax_global, minmax_global_stats <span class="op">=</span> minmax_normalize(data, global_mins, global_maxs)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>zscore_global, zscore_global_stats <span class="op">=</span> zscore_normalize(data, global_means, global_stds)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"📊 Min-Max with Global Stats:"</span>)</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Source: </span><span class="sc">{</span>minmax_global_stats[<span class="st">'source'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Output range: </span><span class="sc">{</span>minmax_global_stats[<span class="st">'output_range'</span>][<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss"> to </span><span class="sc">{</span>minmax_global_stats[<span class="st">'output_range'</span>][<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"📊 Z-Score with Global Stats:"</span>)</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Source: </span><span class="sc">{</span>zscore_global_stats[<span class="st">'source'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Output mean: </span><span class="sc">{</span>zscore_global_stats[<span class="st">'output_mean'</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Output std: </span><span class="sc">{</span>zscore_global_stats[<span class="st">'output_std'</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>🌍 Testing with Global Statistics:
  Global mins: [100 150 200]
  Global maxs: [1500 2000 2500]
  Global means: [ 800 1200 1600]
  Global stds: [300 400 500]

📊 Min-Max with Global Stats:
  Source: global (provided)
  Output range: 0.000 to 0.182

📊 Z-Score with Global Stats:
  Source: global (provided)
  Output mean: 168.496
  Output std: 36.333</code></pre>
</div>
</div>
<p><strong>What to notice:</strong> When using global statistics, the output ranges and distributions differ from local normalization. This is expected and ensures consistency across different image tiles in your dataset.</p>
</section>
</section>
<section id="build-it-spatial-cropping-function" class="level3">
<h3 class="anchored" data-anchor-id="build-it-spatial-cropping-function">🛠️ Build It: Spatial Cropping Function</h3>
<div id="9f5398a6" class="cell" data-tangle="geogfm/data/transforms/patchify.py" data-execution_count="20">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Patch extraction utilities (Week 1)</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/data/transforms/patchify.py`</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">#| auto-imports: true</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>Array <span class="op">=</span> np.ndarray</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> crop_to_patches(data: Array, patch_size: <span class="bu">int</span>, stride: <span class="bu">int</span>) <span class="op">-&gt;</span> Array:</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Crop image to dimensions that allow complete patch extraction.</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="co">        data: (bands, height, width) array</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="co">        patch_size: size of patches to extract</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="co">        stride: step size between patches</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="co">        cropped: (bands, new_height, new_width) array</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    bands, height, width <span class="op">=</span> data.shape</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: Calculate how many complete patches fit</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    patches_h <span class="op">=</span> (height <span class="op">-</span> patch_size) <span class="op">//</span> stride <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    patches_w <span class="op">=</span> (width <span class="op">-</span> patch_size) <span class="op">//</span> stride <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: Calculate the required dimensions</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    new_height <span class="op">=</span> (patches_h <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> stride <span class="op">+</span> patch_size</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    new_width <span class="op">=</span> (patches_w <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> stride <span class="op">+</span> patch_size</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: Crop the data</span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    cropped <span class="op">=</span> data[:, :new_height, :new_width]</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Cropped from </span><span class="sc">{</span>height<span class="sc">}</span><span class="ss">×</span><span class="sc">{</span>width<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>new_height<span class="sc">}</span><span class="ss">×</span><span class="sc">{</span>new_width<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"✓ Will generate </span><span class="sc">{</span>patches_h<span class="sc">}</span><span class="ss">×</span><span class="sc">{</span>patches_w<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span>patches_h<span class="op">*</span>patches_w<span class="sc">}</span><span class="ss"> patches"</span>)</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cropped</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6c3e0925" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test your cropping function</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>cropped_data <span class="op">=</span> crop_to_patches(data, <span class="dv">8</span>, STRIDE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Cropped from 64×64 to 40×40
✓ Will generate 2×2 = 4 patches</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="step-3-patch-extraction-with-metadata" class="level2">
<h2 class="anchored" data-anchor-id="step-3-patch-extraction-with-metadata">Step 3: Patch Extraction with Metadata</h2>
<p><strong>Goal</strong>: Extract patches while preserving spatial context information.</p>
<section id="build-it-patch-extraction-function" class="level3">
<h3 class="anchored" data-anchor-id="build-it-patch-extraction-function">🛠️ Build It: Patch Extraction Function</h3>
<div id="4411ad46" class="cell" data-tangle="geogfm/data/transforms/patchify.py" data-execution_count="22">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Patch extraction with spatial metadata (Week 1)</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles (append) to `geogfm/data/transforms/patchify.py`</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle-mode: append</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">#| auto-import: true</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_patches(</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    data: Array,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    patch_size: <span class="bu">int</span>,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    stride: <span class="bu">int</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Array:</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract patches.</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="co">        data: (bands, height, width) normalized array</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="co">        patch_size: size of patches</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="co">        stride: step between patches</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="co">        patches: (n_patches, bands, patch_size, patch_size) array</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    bands, height, width <span class="op">=</span> data.shape</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    patches <span class="op">=</span> []</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> r <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, height <span class="op">-</span> patch_size <span class="op">+</span> <span class="dv">1</span>, stride):</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, width <span class="op">-</span> patch_size <span class="op">+</span> <span class="dv">1</span>, stride):</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>            patches.append(data[:, r:r<span class="op">+</span>patch_size, c:c<span class="op">+</span>patch_size])</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.stack(patches, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_patches_with_metadata(</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    data: Array,</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>    patch_size: <span class="bu">int</span>,</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>    stride: <span class="bu">int</span>,</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>    transform</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[Array, Array]:</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract patches with their spatial coordinates.</span></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a><span class="co">        data: (bands, height, width) normalized array</span></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a><span class="co">        patch_size: size of patches</span></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a><span class="co">        stride: step between patches</span></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a><span class="co">        transform: rasterio transform object</span></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a><span class="co">        patches: (n_patches, bands, patch_size, patch_size) array</span></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a><span class="co">        coordinates: (n_patches, 4) array of [min_x, min_y, max_x, max_y]</span></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>    bands, height, width <span class="op">=</span> data.shape</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>    patches <span class="op">=</span> []</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>    coordinates <span class="op">=</span> []</span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: Iterate through patch positions</span></span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, height <span class="op">-</span> patch_size <span class="op">+</span> <span class="dv">1</span>, stride):</span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, width <span class="op">-</span> patch_size <span class="op">+</span> <span class="dv">1</span>, stride):</span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>            <span class="co"># </span><span class="al">TODO</span><span class="co">: Extract patch from all bands</span></span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>            patch <span class="op">=</span> data[:, row:row<span class="op">+</span>patch_size, col:col<span class="op">+</span>patch_size]</span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>            patches.append(patch)</span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>            <span class="co"># </span><span class="al">TODO</span><span class="co">: Calculate real-world coordinates using transform</span></span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>            min_x, max_y <span class="op">=</span> transform <span class="op">*</span> (col, row)  <span class="co"># Top-left</span></span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a>            max_x, min_y <span class="op">=</span> transform <span class="op">*</span> <span class="op">\</span></span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>                (col <span class="op">+</span> patch_size, row <span class="op">+</span> patch_size)  <span class="co"># Bottom-right</span></span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>            coordinates.append([min_x, min_y, max_x, max_y])</span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a>    patches <span class="op">=</span> np.array(patches)</span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>    coordinates <span class="op">=</span> np.array(coordinates)</span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Extracted </span><span class="sc">{</span><span class="bu">len</span>(patches)<span class="sc">}</span><span class="ss"> patches"</span>)</span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Patch shape: </span><span class="sc">{</span>patches<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Coordinate shape: </span><span class="sc">{</span>coordinates<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> patches, coordinates</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="7293dd56" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test your patch extraction</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>patches, coords <span class="op">=</span> extract_patches_with_metadata(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    data, <span class="dv">8</span>, <span class="dv">4</span>, metadata[<span class="st">'transform'</span>]</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize a few patches</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">8</span>):</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    row, col <span class="op">=</span> i <span class="op">//</span> <span class="dv">4</span>, i <span class="op">%</span> <span class="dv">4</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show first band of each patch</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    axes[row, col].imshow(patches[i, <span class="dv">0</span>], cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    axes[row, col].set_title(<span class="ss">f'Patch </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    axes[row, col].axis(<span class="st">'off'</span>)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">'Sample Extracted Patches (Band 1)'</span>)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Extracted 225 patches
✓ Patch shape: (225, 3, 8, 8)
✓ Coordinate shape: (225, 4)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="c01-geospatial-data-foundations_files/figure-html/cell-24-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="bcbd11dc" class="cell" data-tangle="geogfm/data/transforms/patchify.py" data-execution_count="24">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reconstruction from patches (Week 1)</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles (append) to `geogfm/data/transforms/patchify.py`</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle-mode: append</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> reconstruct_from_patches(</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    patches: Array,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    height: <span class="bu">int</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    width: <span class="bu">int</span>,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    patch_size: <span class="bu">int</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Array:</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Reassemble a (bands, H, W) image from non-overlapping square patches.</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co">    patches : Array</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Patches in row-major scan order with shape (N, bands, patch_size, patch_size),</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="co">        where N must equal (height // patch_size) * (width // patch_size).</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="co">    height : int</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Target image height in pixels.</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="co">    width : int</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Target image width in pixels.</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="co">    patch_size : int</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="co">        Size of each square patch in pixels. Assumes stride == patch_size (no overlap).</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="co">    Array</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a><span class="co">        Reconstructed image of shape (bands, height, width).</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a><span class="co">    Notes</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a><span class="co">    -----</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a><span class="co">    - Assumes patches are laid out left-to-right, top-to-bottom (row-major).</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a><span class="co">    - Ignores any remainder if `height` or `width` is not divisible by `patch_size`</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a><span class="co">      (i.e., only the `grid_h * patch_size` by `grid_w * patch_size` area is filled).</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a><span class="co">    - No blending is performed (because there is no overlap).</span></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a><span class="co">    Examples</span></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; # Suppose height=width=64, patch_size=32, bands=13</span></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; # patches.shape == (4, 13, 32, 32), ordered row-major</span></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; img = reconstruct_from_patches(patches, 64, 64, 32)</span></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; img.shape</span></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a><span class="co">    (13, 64, 64)</span></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> patches.shape[<span class="dv">1</span>]</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>    grid_h <span class="op">=</span> height <span class="op">//</span> patch_size</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>    grid_w <span class="op">=</span> width <span class="op">//</span> patch_size</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> np.zeros((bands, height, width), dtype<span class="op">=</span>patches.dtype)</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> r <span class="kw">in</span> <span class="bu">range</span>(grid_h):</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c <span class="kw">in</span> <span class="bu">range</span>(grid_w):</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>            out[:, r<span class="op">*</span>patch_size:(r<span class="op">+</span><span class="dv">1</span>)<span class="op">*</span>patch_size, c <span class="op">*</span></span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>                patch_size:(c<span class="op">+</span><span class="dv">1</span>)<span class="op">*</span>patch_size] <span class="op">=</span> patches[idx]</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>            idx <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d5c8a300" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's assume you have already defined reconstruct_from_patches from above</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Example parameters</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>bands <span class="op">=</span> <span class="dv">3</span>         <span class="co"># e.g., RGB</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>height <span class="op">=</span> <span class="dv">8</span>        <span class="co"># image height in pixels</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="dv">8</span>         <span class="co"># image width in pixels</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>patch_size <span class="op">=</span> <span class="dv">4</span>    <span class="co"># each patch is 4x4 pixels</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of patches needed to cover the image (row-major order)</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>grid_h <span class="op">=</span> height <span class="op">//</span> patch_size</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>grid_w <span class="op">=</span> width <span class="op">//</span> patch_size</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>num_patches <span class="op">=</span> grid_h <span class="op">*</span> grid_w</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create random patches (N, bands, patch_size, patch_size)</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>patches <span class="op">=</span> np.random.randint(</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    low<span class="op">=</span><span class="dv">0</span>, high<span class="op">=</span><span class="dv">256</span>,</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    size<span class="op">=</span>(num_patches, bands, patch_size, patch_size),</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    dtype<span class="op">=</span>np.uint8</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Patches shape:"</span>, patches.shape)</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"First patch (band 0):</span><span class="ch">\n</span><span class="st">"</span>, patches[<span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Reconstruct the image</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>reconstructed <span class="op">=</span> reconstruct_from_patches(patches, height, width, patch_size)</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Reconstructed image shape:"</span>, reconstructed.shape)</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Top-left 4x4 of reconstructed image, band 0:</span><span class="ch">\n</span><span class="st">"</span>,</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>      reconstructed[<span class="dv">0</span>, :<span class="dv">4</span>, :<span class="dv">4</span>])</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify reconstruction matches original patches in correct positions</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a><span class="co"># The top-left 4x4 region should be identical to the first patch (band 0)</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> np.array_equal(reconstructed[<span class="dv">0</span>, :<span class="dv">4</span>, :<span class="dv">4</span>], patches[<span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Verification passed: top-left patch matches the original."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Patches shape: (4, 3, 4, 4)
First patch (band 0):
 [[102 220 225  95]
 [179  61 234 203]
 [ 92   3  98 243]
 [ 14 149 245  46]]

Reconstructed image shape: (3, 8, 8)
Top-left 4x4 of reconstructed image, band 0:
 [[102 220 225  95]
 [179  61 234 203]
 [ 92   3  98 243]
 [ 14 149 245  46]]

Verification passed: top-left patch matches the original.</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="step-4-tensor-operations-metadata-encoding" class="level1">
<h1>Step 4: Tensor Operations &amp; Metadata Encoding</h1>
<p><strong>Goal</strong>: Convert numpy arrays to PyTorch tensors and encode metadata.</p>
</section>
<section id="build-it-metadata-encoder" class="level1">
<h1>🛠️ Build It: Metadata Encoder</h1>
<div id="6a699c5d" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> encode_metadata(coordinates: np.ndarray) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Encode spatial metadata as features.</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co">        coordinates: (n_patches, 4) array of [min_x, min_y, max_x, max_y]</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="co">        encoded: (n_patches, n_features) array</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: Calculate spatial features</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    center_x <span class="op">=</span> (coordinates[:, <span class="dv">0</span>] <span class="op">+</span> coordinates[:, <span class="dv">2</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    center_y <span class="op">=</span> (coordinates[:, <span class="dv">1</span>] <span class="op">+</span> coordinates[:, <span class="dv">3</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> coordinates[:, <span class="dv">2</span>] <span class="op">-</span> coordinates[:, <span class="dv">0</span>]</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> coordinates[:, <span class="dv">3</span>] <span class="op">-</span> coordinates[:, <span class="dv">1</span>]</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    area <span class="op">=</span> width <span class="op">*</span> height</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: Normalize spatial features (handle zero std to avoid divide by zero)</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> safe_normalize(values):</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Normalize values, handling zero standard deviation."""</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>        mean_val <span class="op">=</span> values.mean()</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>        std_val <span class="op">=</span> values.std()</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> std_val <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (values <span class="op">-</span> mean_val) <span class="op">/</span> std_val</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.zeros_like(values)  <span class="co"># All values are the same</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> np.column_stack([</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>        safe_normalize(center_x),     <span class="co"># Normalized center X</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>        safe_normalize(center_y),     <span class="co"># Normalized center Y</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>        safe_normalize(area),         <span class="co"># Normalized area (handles constant area)</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>        width <span class="op">/</span> height,               <span class="co"># Aspect ratio</span></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Encoded metadata shape: </span><span class="sc">{</span>features<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Feature statistics:"</span>)</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>    feature_names <span class="op">=</span> [<span class="st">'center_x'</span>, <span class="st">'center_y'</span>, <span class="st">'area'</span>, <span class="st">'aspect_ratio'</span>]</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(feature_names):</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"  </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: mean=</span><span class="sc">{</span>features[:, i]<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss">, std=</span><span class="sc">{</span>features[:, i]<span class="sc">.</span>std()<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> features.astype(np.float32)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="4ca9b71f" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test metadata encoding</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>encoded_metadata <span class="op">=</span> encode_metadata(coords)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Encoded metadata shape: (225, 4)
✓ Feature statistics:
  center_x: mean=0.000, std=1.000
  center_y: mean=0.000, std=1.000
  area: mean=0.000, std=0.000
  aspect_ratio: mean=1.000, std=0.000</code></pre>
</div>
</div>
<section id="build-it-tensor-conversion" class="level3">
<h3 class="anchored" data-anchor-id="build-it-tensor-conversion">🛠️ Build It: Tensor Conversion</h3>
<div id="29950fa9" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_tensors(patches: np.ndarray, metadata: np.ndarray) <span class="op">-&gt;</span> Tuple[torch.Tensor, torch.Tensor]:</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Convert numpy arrays to PyTorch tensors.</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co">        patches: (n_patches, bands, height, width) array</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co">        metadata: (n_patches, n_features) array</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="co">        patch_tensors: (n_patches, bands, height, width) tensor</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co">        metadata_tensors: (n_patches, n_features) tensor</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: Convert to tensors with appropriate dtypes</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    patch_tensors <span class="op">=</span> torch.from_numpy(patches).<span class="bu">float</span>()</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    metadata_tensors <span class="op">=</span> torch.from_numpy(metadata).<span class="bu">float</span>()</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Patch tensors: </span><span class="sc">{</span>patch_tensors<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, dtype: </span><span class="sc">{</span>patch_tensors<span class="sc">.</span>dtype<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Metadata tensors: </span><span class="sc">{</span>metadata_tensors<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, dtype: </span><span class="sc">{</span>metadata_tensors<span class="sc">.</span>dtype<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> patch_tensors, metadata_tensors</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a72cb6f1" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create tensors</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>patch_tensors, metadata_tensors <span class="op">=</span> create_tensors(patches, encoded_metadata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Patch tensors: torch.Size([4, 3, 4, 4]), dtype: torch.float32
✓ Metadata tensors: torch.Size([225, 4]), dtype: torch.float32</code></pre>
</div>
</div>
<hr>
</section>
<section id="step-5-dataloader-construction" class="level2">
<h2 class="anchored" data-anchor-id="step-5-dataloader-construction">Step 5: DataLoader Construction</h2>
<p><strong>Goal</strong>: Build a PyTorch Dataset and DataLoader for training.</p>
<section id="build-it-custom-dataset-class" class="level3">
<h3 class="anchored" data-anchor-id="build-it-custom-dataset-class">🛠️ Build It: Custom Dataset Class</h3>
<div id="fb948be0" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GeospatialDataset(Dataset):</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Dataset for geospatial patches with metadata."""</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, patch_tensors: torch.Tensor, metadata_tensors: torch.Tensor):</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="co">            patch_tensors: (n_patches, bands, height, width)</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="co">            metadata_tensors: (n_patches, n_features)</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.patches <span class="op">=</span> patch_tensors</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.metadata <span class="op">=</span> metadata_tensors</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: Create dummy labels for demonstration (in real use, load from file)</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.labels <span class="op">=</span> torch.randint(<span class="dv">0</span>, <span class="dv">5</span>, (<span class="bu">len</span>(patch_tensors),))  <span class="co"># 5 land cover classes</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Return number of patches."""</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.patches)</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx: <span class="bu">int</span>) <span class="op">-&gt;</span> Tuple[torch.Tensor, torch.Tensor, torch.Tensor]:</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Get a single item.</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="co">            patch: (bands, height, width) tensor</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="co">            metadata: (n_features,) tensor  </span></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a><span class="co">            label: scalar tensor</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.patches[idx], <span class="va">self</span>.metadata[idx], <span class="va">self</span>.labels[idx]</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Test your dataset</span></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> GeospatialDataset(patch_tensors, metadata_tensors)</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Dataset length: </span><span class="sc">{</span><span class="bu">len</span>(dataset)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Test getting an item</span></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>sample_patch, sample_metadata, sample_label <span class="op">=</span> dataset[<span class="dv">0</span>]</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Sample patch shape: </span><span class="sc">{</span>sample_patch<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Sample metadata shape: </span><span class="sc">{</span>sample_metadata<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Sample label: </span><span class="sc">{</span>sample_label<span class="sc">.</span>item()<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Dataset length: 4
✓ Sample patch shape: torch.Size([3, 4, 4])
✓ Sample metadata shape: torch.Size([4])
✓ Sample label: 2</code></pre>
</div>
</div>
</section>
<section id="build-it-dataloader" class="level3">
<h3 class="anchored" data-anchor-id="build-it-dataloader">🛠️ Build It: DataLoader</h3>
<div id="9c620668" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Create DataLoader with appropriate batch size and shuffling</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>dataloader <span class="op">=</span> DataLoader(</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    dataset, </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>BATCH_SIZE, </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    shuffle<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    num_workers<span class="op">=</span><span class="dv">0</span>,  <span class="co"># Set to 0 for compatibility</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    pin_memory<span class="op">=</span><span class="va">True</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="va">False</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ DataLoader created with batch size </span><span class="sc">{</span>BATCH_SIZE<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Number of batches: </span><span class="sc">{</span><span class="bu">len</span>(dataloader)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the DataLoader</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> batch_idx, (patches, metadata, labels) <span class="kw">in</span> <span class="bu">enumerate</span>(dataloader):</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Batch </span><span class="sc">{</span>batch_idx<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Patches: </span><span class="sc">{</span>patches<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Metadata: </span><span class="sc">{</span>metadata<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Labels: </span><span class="sc">{</span>labels<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> batch_idx <span class="op">==</span> <span class="dv">1</span>:  <span class="co"># Show first two batches</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ DataLoader created with batch size 8
✓ Number of batches: 1
✓ Batch 0:
  Patches: torch.Size([4, 3, 4, 4])
  Metadata: torch.Size([4, 4])
  Labels: torch.Size([4])</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="step-6-embedding-layer-integration" class="level2">
<h2 class="anchored" data-anchor-id="step-6-embedding-layer-integration">Step 6: Embedding Layer Integration</h2>
<p><strong>Goal</strong>: Connect to a simple embedding layer to verify end-to-end functionality.</p>
<section id="build-it-simple-gfm-embedding-layer" class="level3">
<h3 class="anchored" data-anchor-id="build-it-simple-gfm-embedding-layer">🛠️ Build It: Simple GFM Embedding Layer</h3>
<div id="fe94bb67" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SimpleGFMEmbedding(nn.Module):</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Simple embedding layer for geospatial patches."""</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, input_channels: <span class="bu">int</span>, metadata_features: <span class="bu">int</span>, embed_dim: <span class="bu">int</span>, patch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span>):</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: Build adaptive patch encoder based on patch size</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> patch_size <span class="op">&gt;=</span> <span class="dv">32</span>:</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Larger patches: multi-layer CNN</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>            kernel1 <span class="op">=</span> <span class="bu">min</span>(<span class="dv">8</span>, patch_size <span class="op">//</span> <span class="dv">4</span>)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>            kernel2 <span class="op">=</span> <span class="bu">min</span>(<span class="dv">4</span>, patch_size <span class="op">//</span> <span class="dv">8</span>)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.patch_encoder <span class="op">=</span> nn.Sequential(</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>                nn.Conv2d(input_channels, <span class="dv">32</span>, kernel_size<span class="op">=</span>kernel1, stride<span class="op">=</span>kernel1<span class="op">//</span><span class="dv">2</span>),</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>                nn.ReLU(),</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>                nn.Conv2d(<span class="dv">32</span>, <span class="dv">64</span>, kernel_size<span class="op">=</span>kernel2, stride<span class="op">=</span>kernel2<span class="op">//</span><span class="dv">2</span>), </span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>                nn.ReLU(),</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>                nn.AdaptiveAvgPool2d(<span class="dv">1</span>),</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>                nn.Flatten(),</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Smaller patches: simpler encoder</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>            kernel <span class="op">=</span> <span class="bu">min</span>(<span class="dv">4</span>, patch_size <span class="op">//</span> <span class="dv">2</span>)</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.patch_encoder <span class="op">=</span> nn.Sequential(</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>                nn.Conv2d(input_channels, <span class="dv">64</span>, kernel_size<span class="op">=</span>kernel, stride<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>                nn.ReLU(),</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>                nn.AdaptiveAvgPool2d(<span class="dv">1</span>),</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>                nn.Flatten(),</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: Build metadata encoder</span></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.metadata_encoder <span class="op">=</span> nn.Sequential(</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>            nn.Linear(metadata_features, <span class="dv">32</span>),</span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">32</span>, <span class="dv">32</span>),</span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: Build fusion layer</span></span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate patch encoder output size</span></span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>            dummy_patch <span class="op">=</span> torch.randn(<span class="dv">1</span>, input_channels, patch_size, patch_size)</span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>            patch_feat_size <span class="op">=</span> <span class="va">self</span>.patch_encoder(dummy_patch).shape[<span class="dv">1</span>]</span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fusion <span class="op">=</span> nn.Sequential(</span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a>            nn.Linear(patch_feat_size <span class="op">+</span> <span class="dv">32</span>, embed_dim),</span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a>            nn.Linear(embed_dim, embed_dim),</span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, patches: torch.Tensor, metadata: torch.Tensor) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a><span class="co">            patches: (batch, channels, height, width)</span></span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a><span class="co">            metadata: (batch, n_features)</span></span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a><span class="co">            embeddings: (batch, embed_dim)</span></span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: Encode patches and metadata</span></span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a>        patch_features <span class="op">=</span> <span class="va">self</span>.patch_encoder(patches)</span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a>        metadata_features <span class="op">=</span> <span class="va">self</span>.metadata_encoder(metadata)</span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-62"><a href="#cb45-62" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: Fuse features</span></span>
<span id="cb45-63"><a href="#cb45-63" aria-hidden="true" tabindex="-1"></a>        combined <span class="op">=</span> torch.cat([patch_features, metadata_features], dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb45-64"><a href="#cb45-64" aria-hidden="true" tabindex="-1"></a>        embeddings <span class="op">=</span> <span class="va">self</span>.fusion(combined)</span>
<span id="cb45-65"><a href="#cb45-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-66"><a href="#cb45-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> embeddings</span>
<span id="cb45-67"><a href="#cb45-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-68"><a href="#cb45-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and test the model</span></span>
<span id="cb45-69"><a href="#cb45-69" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> SimpleGFMEmbedding(</span>
<span id="cb45-70"><a href="#cb45-70" aria-hidden="true" tabindex="-1"></a>    input_channels<span class="op">=</span>bands, </span>
<span id="cb45-71"><a href="#cb45-71" aria-hidden="true" tabindex="-1"></a>    metadata_features<span class="op">=</span>encoded_metadata.shape[<span class="dv">1</span>], </span>
<span id="cb45-72"><a href="#cb45-72" aria-hidden="true" tabindex="-1"></a>    embed_dim<span class="op">=</span>EMBEDDING_DIM,</span>
<span id="cb45-73"><a href="#cb45-73" aria-hidden="true" tabindex="-1"></a>    patch_size<span class="op">=</span>PATCH_SIZE</span>
<span id="cb45-74"><a href="#cb45-74" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-75"><a href="#cb45-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-76"><a href="#cb45-76" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Model created"</span>)</span>
<span id="cb45-77"><a href="#cb45-77" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Model parameters: </span><span class="sc">{</span><span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> model.parameters())<span class="sc">:,}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Model created
✓ Model parameters: 130,848</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="step-7-end-to-end-pipeline-test" class="level2">
<h2 class="anchored" data-anchor-id="step-7-end-to-end-pipeline-test">Step 7: End-to-End Pipeline Test</h2>
<p><strong>Goal</strong>: Run the complete pipeline and verify everything works together.</p>
<section id="build-it-complete-pipeline-function" class="level3">
<h3 class="anchored" data-anchor-id="build-it-complete-pipeline-function">🛠️ Build It: Complete Pipeline Function</h3>
<div id="e8bee845" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> geotiff_to_embeddings_pipeline(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    file_path: Path,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    patch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span>,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    stride: <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span>,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    batch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span>,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    embed_dim: <span class="bu">int</span> <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Complete pipeline from GeoTIFF to embeddings.</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="co">        file_path: Path to GeoTIFF file</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="co">        patch_size: Size of patches to extract</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="co">        stride: Step between patches  </span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="co">        batch_size: Batch size for processing</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="co">        embed_dim: Embedding dimension</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="co">        all_embeddings: (n_patches, embed_dim) tensor</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"🚀 Starting GeoTIFF → Embeddings Pipeline"</span>)</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Load data</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"📁 Loading GeoTIFF..."</span>)</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>    data, metadata <span class="op">=</span> load_geotiff(file_path)</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Preprocess</span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"🔧 Preprocessing..."</span>)</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>    norm_data, norm_stats <span class="op">=</span> minmax_normalize(data)</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>    cropped_data <span class="op">=</span> crop_to_patches(norm_data, patch_size, stride)</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 3: Extract patches</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"✂️ Extracting patches..."</span>)</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>    patches, coords <span class="op">=</span> extract_patches_with_metadata(cropped_data, patch_size, stride, metadata[<span class="st">'transform'</span>])</span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 4: Encode metadata</span></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"📊 Encoding metadata..."</span>)</span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>    encoded_meta <span class="op">=</span> encode_metadata(coords)</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 5: Create tensors</span></span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"🔢 Creating tensors..."</span>)</span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a>    patch_tensors, meta_tensors <span class="op">=</span> create_tensors(patches, encoded_meta)</span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 6: Create dataset and dataloader</span></span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"📦 Creating DataLoader..."</span>)</span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> GeospatialDataset(patch_tensors, meta_tensors)</span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a>    dataloader <span class="op">=</span> DataLoader(dataset, batch_size<span class="op">=</span>batch_size, shuffle<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 7: Create model and generate embeddings</span></span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"🧠 Generating embeddings..."</span>)</span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> SimpleGFMEmbedding(</span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a>        input_channels<span class="op">=</span>data.shape[<span class="dv">0</span>],</span>
<span id="cb47-53"><a href="#cb47-53" aria-hidden="true" tabindex="-1"></a>        metadata_features<span class="op">=</span>encoded_meta.shape[<span class="dv">1</span>], </span>
<span id="cb47-54"><a href="#cb47-54" aria-hidden="true" tabindex="-1"></a>        embed_dim<span class="op">=</span>embed_dim,</span>
<span id="cb47-55"><a href="#cb47-55" aria-hidden="true" tabindex="-1"></a>        patch_size<span class="op">=</span>patch_size</span>
<span id="cb47-56"><a href="#cb47-56" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-57"><a href="#cb47-57" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb47-58"><a href="#cb47-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-59"><a href="#cb47-59" aria-hidden="true" tabindex="-1"></a>    all_embeddings <span class="op">=</span> []</span>
<span id="cb47-60"><a href="#cb47-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb47-61"><a href="#cb47-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> patches_batch, meta_batch, _ <span class="kw">in</span> dataloader:</span>
<span id="cb47-62"><a href="#cb47-62" aria-hidden="true" tabindex="-1"></a>            embeddings <span class="op">=</span> model(patches_batch, meta_batch)</span>
<span id="cb47-63"><a href="#cb47-63" aria-hidden="true" tabindex="-1"></a>            all_embeddings.append(embeddings)</span>
<span id="cb47-64"><a href="#cb47-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-65"><a href="#cb47-65" aria-hidden="true" tabindex="-1"></a>    all_embeddings <span class="op">=</span> torch.cat(all_embeddings, dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb47-66"><a href="#cb47-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✅ Pipeline complete! Generated </span><span class="sc">{</span><span class="bu">len</span>(all_embeddings)<span class="sc">}</span><span class="ss"> embeddings"</span>)</span>
<span id="cb47-67"><a href="#cb47-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-68"><a href="#cb47-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> all_embeddings</span>
<span id="cb47-69"><a href="#cb47-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-70"><a href="#cb47-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the complete pipeline</span></span>
<span id="cb47-71"><a href="#cb47-71" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> geotiff_to_embeddings_pipeline(SAMPLE_PATH)</span>
<span id="cb47-72"><a href="#cb47-72" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🎉 Final Result:"</span>)</span>
<span id="cb47-73"><a href="#cb47-73" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Embeddings shape: </span><span class="sc">{</span>embeddings<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb47-74"><a href="#cb47-74" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Embedding statistics:"</span>)</span>
<span id="cb47-75"><a href="#cb47-75" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Mean: </span><span class="sc">{</span>embeddings<span class="sc">.</span>mean()<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb47-76"><a href="#cb47-76" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Std: </span><span class="sc">{</span>embeddings<span class="sc">.</span>std()<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb47-77"><a href="#cb47-77" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Min: </span><span class="sc">{</span>embeddings<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb47-78"><a href="#cb47-78" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Max: </span><span class="sc">{</span>embeddings<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>🚀 Starting GeoTIFF → Embeddings Pipeline
📁 Loading GeoTIFF...
🔧 Preprocessing...
✓ Cropped from 64×64 to 64×64
✓ Will generate 15×15 = 225 patches
✂️ Extracting patches...
✓ Extracted 225 patches
✓ Patch shape: (225, 3, 8, 8)
✓ Coordinate shape: (225, 4)
📊 Encoding metadata...
✓ Encoded metadata shape: (225, 4)
✓ Feature statistics:
  center_x: mean=0.000, std=1.000
  center_y: mean=0.000, std=1.000
  area: mean=0.000, std=0.000
  aspect_ratio: mean=1.000, std=0.000
🔢 Creating tensors...
✓ Patch tensors: torch.Size([225, 3, 8, 8]), dtype: torch.float32
✓ Metadata tensors: torch.Size([225, 4]), dtype: torch.float32
📦 Creating DataLoader...
🧠 Generating embeddings...
✅ Pipeline complete! Generated 225 embeddings

🎉 Final Result:
✓ Embeddings shape: torch.Size([225, 256])
✓ Embedding statistics:
  Mean: -0.0052
  Std: 0.0725
  Min: -0.2700
  Max: 0.3388</code></pre>
</div>
</div>
</section>
<section id="verify-it-pipeline-output-analysis" class="level3">
<h3 class="anchored" data-anchor-id="verify-it-pipeline-output-analysis">🔍 Verify It: Pipeline Output Analysis</h3>
<div id="d1bdfa7c" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize embedding similarities</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"🔍 Analyzing embedding relationships..."</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if we have enough embeddings for analysis</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(embeddings) <span class="op">&lt;</span> <span class="dv">10</span>:</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"⚠️ Only </span><span class="sc">{</span><span class="bu">len</span>(embeddings)<span class="sc">}</span><span class="ss"> embeddings available, using all of them"</span>)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    sample_size <span class="op">=</span> <span class="bu">len</span>(embeddings)</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Using first 10 of </span><span class="sc">{</span><span class="bu">len</span>(embeddings)<span class="sc">}</span><span class="ss"> embeddings for similarity analysis"</span>)</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    sample_size <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> sample_size <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute pairwise cosine similarities</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> torch.nn.functional <span class="im">import</span> cosine_similarity</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    sample_embeddings <span class="op">=</span> embeddings[:sample_size]</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    similarity_matrix <span class="op">=</span> torch.zeros(sample_size, sample_size)</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(sample_size):</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(sample_size):</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">==</span> j:</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>                similarity_matrix[i, j] <span class="op">=</span> <span class="fl">1.0</span>  <span class="co"># Perfect self-similarity</span></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>                sim <span class="op">=</span> cosine_similarity(sample_embeddings[i:i<span class="op">+</span><span class="dv">1</span>], sample_embeddings[j:j<span class="op">+</span><span class="dv">1</span>], dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>                similarity_matrix[i, j] <span class="op">=</span> sim.item()</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot similarity matrix</span></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>    plt.imshow(similarity_matrix.numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>, vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>    plt.colorbar(label<span class="op">=</span><span class="st">'Cosine Similarity'</span>)</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f'Embedding Similarity Matrix (First </span><span class="sc">{</span>sample_size<span class="sc">}</span><span class="ss"> Patches)'</span>)</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Patch Index'</span>)</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'Patch Index'</span>)</span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Average similarity: </span><span class="sc">{</span>similarity_matrix<span class="sc">.</span>mean()<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Similarity range: </span><span class="sc">{</span>similarity_matrix<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss"> to </span><span class="sc">{</span>similarity_matrix<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"⚠️ Not enough embeddings for similarity analysis"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>🔍 Analyzing embedding relationships...
✓ Using first 10 of 225 embeddings for similarity analysis</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="c01-geospatial-data-foundations_files/figure-html/cell-35-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Average similarity: 0.9737
✓ Similarity range: 0.8781 to 1.0000</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>🎉 <strong>Congratulations!</strong> You’ve successfully built a complete pipeline that transforms raw satellite imagery into model-ready embeddings.</p>
<section id="what-you-built" class="level3">
<h3 class="anchored" data-anchor-id="what-you-built">What You Built:</h3>
<ol type="1">
<li><strong>GeoTIFF Loader</strong>: Extracts both pixel data and spatial metadata</li>
<li><strong>Preprocessing Functions</strong>: Normalization and spatial cropping<br>
</li>
<li><strong>Patch Extractor</strong>: Creates patches while preserving spatial context</li>
<li><strong>Metadata Encoder</strong>: Transforms coordinates into learned features</li>
<li><strong>PyTorch Integration</strong>: Dataset, DataLoader, and model components</li>
<li><strong>Embedding Generator</strong>: Simple CNN that produces vector representations</li>
</ol>
</section>
<section id="key-insights" class="level3">
<h3 class="anchored" data-anchor-id="key-insights">Key Insights:</h3>
<ul>
<li><strong>Spatial Context Matters</strong>: Each patch carries location information</li>
<li><strong>Preprocessing is Critical</strong>: Normalization ensures stable training<br>
</li>
<li><strong>Modular Design</strong>: Each step can be optimized independently</li>
<li><strong>End-to-End Testing</strong>: Verify the complete pipeline works</li>
</ul>
</section>
<section id="whats-next" class="level3">
<h3 class="anchored" data-anchor-id="whats-next">What’s Next:</h3>
<p>In the following sessions, you’ll enhance each component: - <strong>Week 2</strong>: Advanced attention mechanisms for spatial relationships - <strong>Week 3</strong>: Complete GFM architecture with transformer blocks - <strong>Week 4</strong>: Pretraining strategies and masked autoencoding</p>
<p>The pipeline you built today forms the foundation for everything that follows! 🚀</p>
</section>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">Resources</h2>
<ul>
<li><a href="https://pytorch.org/docs/stable/data.html">PyTorch DataLoader Documentation</a></li>
<li><a href="https://rasterio.readthedocs.io/">Rasterio User Guide</a></li>
<li><a href="../extras/examples/normalization_comparison.html">Geospatial Foundation Model Examples</a></li>
</ul>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/kellycaylor\.github\.io\/geoAI");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb52" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Building a GeoTIFF to Embeddings Pipeline"</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "From raw satellite data to model-ready tensors"</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> geoai</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>Today we're building a complete pipeline that transforms raw satellite imagery into model-ready embeddings. This mirrors how Large Language Models process text: **raw text → tokens → embeddings**. Our geospatial version: **raw GeoTIFF → patches → embeddings**.</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a><span class="fu">## Course Roadmap Mapping</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>This week’s work in the broader GFM plan.</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>| Week | Stage | Focus | You will build (geogfm) | Library tools | Outcome |</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>|------|-------|-------|--------------------------|---------------|---------|</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>| 1 | Stage 1: Build GFM Architecture | Data Foundations | <span class="in">`core/config.py`</span>; <span class="in">`data/datasets/stac_dataset.py`</span>; <span class="in">`data/transforms/{normalization.py, patchify.py}`</span>; <span class="in">`data/loaders.py`</span> | <span class="in">`torch.utils.data.Dataset`</span>/<span class="in">`DataLoader`</span>, <span class="in">`rasterio`</span>, <span class="in">`numpy`</span> | Config-driven dataloaders that yield normalized patches |</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a><span class="fu">### Weekly goals</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Implement a minimal dataset, transforms, and dataloaders</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Normalize channels; extract patches deterministically</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Verify shapes/CRS/stats prints; run a tiny DataLoader</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a><span class="fu">## Session Outline (and Tangled Code)</span></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Concepts → Components mapping</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Configuration schemas → <span class="in">`core/config.py`</span></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Normalization and patchifying transforms → <span class="in">`data/transforms/{normalization.py, patchify.py}`</span></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Minimal STAC-like dataset → <span class="in">`data/datasets/stac_dataset.py`</span></span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>DataLoader builders → <span class="in">`data/loaders.py`</span></span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Package init files → <span class="in">`geogfm/__init__.py`</span> and subpackages</span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a><span class="fu">### Package inits</span></span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle: /geogfm/__init__.py</span></span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a><span class="co"># GeogFM package init (Week 1)</span></span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/__init__.py`</span></span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Provides base package visibility for data + core modules</span></span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle: geogfm/core/__init__.py</span></span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Core subpackage init (Week 1)</span></span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/core/__init__.py`</span></span>
<span id="cb52-54"><a href="#cb52-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Exposes config schemas</span></span>
<span id="cb52-55"><a href="#cb52-55" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-56"><a href="#cb52-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-59"><a href="#cb52-59" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-60"><a href="#cb52-60" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle: geogfm/data/__init__.py</span></span>
<span id="cb52-61"><a href="#cb52-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Data subpackage init (Week 1)</span></span>
<span id="cb52-62"><a href="#cb52-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/data/__init__.py`</span></span>
<span id="cb52-63"><a href="#cb52-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Exposes datasets, loaders, and transforms</span></span>
<span id="cb52-64"><a href="#cb52-64" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-65"><a href="#cb52-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-68"><a href="#cb52-68" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-69"><a href="#cb52-69" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle: geogfm/data/datasets/__init__.py</span></span>
<span id="cb52-70"><a href="#cb52-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Datasets init (Week 1)</span></span>
<span id="cb52-71"><a href="#cb52-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/data/datasets/__init__.py`</span></span>
<span id="cb52-72"><a href="#cb52-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Exposes minimal STAC-like dataset</span></span>
<span id="cb52-73"><a href="#cb52-73" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-74"><a href="#cb52-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-77"><a href="#cb52-77" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-78"><a href="#cb52-78" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle: geogfm/data/transforms/__init__.py</span></span>
<span id="cb52-79"><a href="#cb52-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Transforms init (Week 1)</span></span>
<span id="cb52-80"><a href="#cb52-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/data/transforms/__init__.py`</span></span>
<span id="cb52-81"><a href="#cb52-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Exposes normalization and patchify transforms</span></span>
<span id="cb52-82"><a href="#cb52-82" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-83"><a href="#cb52-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-84"><a href="#cb52-84" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1) Typed Configs → `geogfm/core/config.py`</span></span>
<span id="cb52-85"><a href="#cb52-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-88"><a href="#cb52-88" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-89"><a href="#cb52-89" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle: geogfm/core/config.py</span></span>
<span id="cb52-90"><a href="#cb52-90" aria-hidden="true" tabindex="-1"></a><span class="co"># Typed configuration schemas (Week 1)</span></span>
<span id="cb52-91"><a href="#cb52-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/core/config.py`</span></span>
<span id="cb52-92"><a href="#cb52-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-93"><a href="#cb52-93" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb52-94"><a href="#cb52-94" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass, field</span>
<span id="cb52-95"><a href="#cb52-95" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, Any, Optional</span>
<span id="cb52-96"><a href="#cb52-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-97"><a href="#cb52-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-98"><a href="#cb52-98" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb52-99"><a href="#cb52-99" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelConfig:</span>
<span id="cb52-100"><a href="#cb52-100" aria-hidden="true" tabindex="-1"></a>    architecture: <span class="bu">str</span> <span class="op">=</span> <span class="st">"gfm_vit"</span></span>
<span id="cb52-101"><a href="#cb52-101" aria-hidden="true" tabindex="-1"></a>    in_channels: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb52-102"><a href="#cb52-102" aria-hidden="true" tabindex="-1"></a>    image_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb52-103"><a href="#cb52-103" aria-hidden="true" tabindex="-1"></a>    patch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb52-104"><a href="#cb52-104" aria-hidden="true" tabindex="-1"></a>    embed_dim: <span class="bu">int</span> <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb52-105"><a href="#cb52-105" aria-hidden="true" tabindex="-1"></a>    depth: <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb52-106"><a href="#cb52-106" aria-hidden="true" tabindex="-1"></a>    num_heads: <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb52-107"><a href="#cb52-107" aria-hidden="true" tabindex="-1"></a>    mlp_ratio: <span class="bu">float</span> <span class="op">=</span> <span class="fl">4.0</span></span>
<span id="cb52-108"><a href="#cb52-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-109"><a href="#cb52-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-110"><a href="#cb52-110" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb52-111"><a href="#cb52-111" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataConfig:</span>
<span id="cb52-112"><a href="#cb52-112" aria-hidden="true" tabindex="-1"></a>    dataset: <span class="bu">str</span> <span class="op">=</span> <span class="st">"stac"</span></span>
<span id="cb52-113"><a href="#cb52-113" aria-hidden="true" tabindex="-1"></a>    root_dir: <span class="bu">str</span> <span class="op">=</span> <span class="st">"data/out"</span>  <span class="co"># or a small sample dir</span></span>
<span id="cb52-114"><a href="#cb52-114" aria-hidden="true" tabindex="-1"></a>    split: <span class="bu">str</span> <span class="op">=</span> <span class="st">"train"</span></span>
<span id="cb52-115"><a href="#cb52-115" aria-hidden="true" tabindex="-1"></a>    image_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb52-116"><a href="#cb52-116" aria-hidden="true" tabindex="-1"></a>    in_channels: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb52-117"><a href="#cb52-117" aria-hidden="true" tabindex="-1"></a>    length: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span>  <span class="co"># synthetic length fallback</span></span>
<span id="cb52-118"><a href="#cb52-118" aria-hidden="true" tabindex="-1"></a>    num_workers: <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb52-119"><a href="#cb52-119" aria-hidden="true" tabindex="-1"></a>    batch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb52-120"><a href="#cb52-120" aria-hidden="true" tabindex="-1"></a>    seed: <span class="bu">int</span> <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb52-121"><a href="#cb52-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-122"><a href="#cb52-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-123"><a href="#cb52-123" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb52-124"><a href="#cb52-124" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TrainConfig:</span>
<span id="cb52-125"><a href="#cb52-125" aria-hidden="true" tabindex="-1"></a>    epochs: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb52-126"><a href="#cb52-126" aria-hidden="true" tabindex="-1"></a>    batch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb52-127"><a href="#cb52-127" aria-hidden="true" tabindex="-1"></a>    optimizer: Dict[<span class="bu">str</span>, Any] <span class="op">=</span> field(</span>
<span id="cb52-128"><a href="#cb52-128" aria-hidden="true" tabindex="-1"></a>        default_factory<span class="op">=</span><span class="kw">lambda</span>: {<span class="st">"name"</span>: <span class="st">"adamw"</span>, <span class="st">"lr"</span>: <span class="fl">2e-4</span>})</span>
<span id="cb52-129"><a href="#cb52-129" aria-hidden="true" tabindex="-1"></a>    device: <span class="bu">str</span> <span class="op">=</span> <span class="st">"cpu"</span></span>
<span id="cb52-130"><a href="#cb52-130" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-131"><a href="#cb52-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-132"><a href="#cb52-132" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2) Normalization Transform → `geogfm/data/transforms/normalization.py`</span></span>
<span id="cb52-133"><a href="#cb52-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-136"><a href="#cb52-136" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-137"><a href="#cb52-137" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle: geogfm/data/transforms/normalization.py</span></span>
<span id="cb52-138"><a href="#cb52-138" aria-hidden="true" tabindex="-1"></a><span class="co"># Channel-wise normalization utilities (Week 1)</span></span>
<span id="cb52-139"><a href="#cb52-139" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/data/transforms/normalization.py`</span></span>
<span id="cb52-140"><a href="#cb52-140" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb52-141"><a href="#cb52-141" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb52-142"><a href="#cb52-142" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple, Dict, Any, Optional</span>
<span id="cb52-143"><a href="#cb52-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-144"><a href="#cb52-144" aria-hidden="true" tabindex="-1"></a>Array <span class="op">=</span> np.ndarray</span>
<span id="cb52-145"><a href="#cb52-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-146"><a href="#cb52-146" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> minmax_normalize(data: Array, global_min: Optional[Array] <span class="op">=</span> <span class="va">None</span>, global_max: Optional[Array] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">tuple</span>[Array, <span class="bu">dict</span>]:</span>
<span id="cb52-147"><a href="#cb52-147" aria-hidden="true" tabindex="-1"></a>    bands, height, width <span class="op">=</span> data.shape</span>
<span id="cb52-148"><a href="#cb52-148" aria-hidden="true" tabindex="-1"></a>    normalized <span class="op">=</span> np.zeros_like(data, dtype<span class="op">=</span>np.float32)</span>
<span id="cb52-149"><a href="#cb52-149" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> global_min <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> global_max <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb52-150"><a href="#cb52-150" aria-hidden="true" tabindex="-1"></a>        mins <span class="op">=</span> np.array([data[i].<span class="bu">min</span>() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands)], dtype<span class="op">=</span>np.float32)</span>
<span id="cb52-151"><a href="#cb52-151" aria-hidden="true" tabindex="-1"></a>        maxs <span class="op">=</span> np.array([data[i].<span class="bu">max</span>() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands)], dtype<span class="op">=</span>np.float32)</span>
<span id="cb52-152"><a href="#cb52-152" aria-hidden="true" tabindex="-1"></a>        src <span class="op">=</span> <span class="st">"local"</span></span>
<span id="cb52-153"><a href="#cb52-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb52-154"><a href="#cb52-154" aria-hidden="true" tabindex="-1"></a>        mins, maxs, src <span class="op">=</span> global_min.astype(np.float32), global_max.astype(np.float32), <span class="st">"global"</span></span>
<span id="cb52-155"><a href="#cb52-155" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands):</span>
<span id="cb52-156"><a href="#cb52-156" aria-hidden="true" tabindex="-1"></a>        rng <span class="op">=</span> maxs[i] <span class="op">-</span> mins[i]</span>
<span id="cb52-157"><a href="#cb52-157" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> rng <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb52-158"><a href="#cb52-158" aria-hidden="true" tabindex="-1"></a>            normalized[i] <span class="op">=</span> (data[i] <span class="op">-</span> mins[i]) <span class="op">/</span> rng</span>
<span id="cb52-159"><a href="#cb52-159" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb52-160"><a href="#cb52-160" aria-hidden="true" tabindex="-1"></a>            normalized[i] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb52-161"><a href="#cb52-161" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> {<span class="st">"source"</span>: src, <span class="st">"mins"</span>: mins, <span class="st">"maxs"</span>: maxs, <span class="st">"output_range"</span>: (<span class="bu">float</span>(normalized.<span class="bu">min</span>()), <span class="bu">float</span>(normalized.<span class="bu">max</span>()))}</span>
<span id="cb52-162"><a href="#cb52-162" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> normalized, stats</span>
<span id="cb52-163"><a href="#cb52-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-164"><a href="#cb52-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-165"><a href="#cb52-165" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> zscore_normalize(data: Array, global_mean: Optional[Array] <span class="op">=</span> <span class="va">None</span>, global_std: Optional[Array] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">tuple</span>[Array, <span class="bu">dict</span>]:</span>
<span id="cb52-166"><a href="#cb52-166" aria-hidden="true" tabindex="-1"></a>    bands, height, width <span class="op">=</span> data.shape</span>
<span id="cb52-167"><a href="#cb52-167" aria-hidden="true" tabindex="-1"></a>    normalized <span class="op">=</span> np.zeros_like(data, dtype<span class="op">=</span>np.float32)</span>
<span id="cb52-168"><a href="#cb52-168" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> global_mean <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> global_std <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb52-169"><a href="#cb52-169" aria-hidden="true" tabindex="-1"></a>        means <span class="op">=</span> np.array([data[i].mean() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands)], dtype<span class="op">=</span>np.float32)</span>
<span id="cb52-170"><a href="#cb52-170" aria-hidden="true" tabindex="-1"></a>        stds <span class="op">=</span> np.array([data[i].std() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands)], dtype<span class="op">=</span>np.float32)</span>
<span id="cb52-171"><a href="#cb52-171" aria-hidden="true" tabindex="-1"></a>        src <span class="op">=</span> <span class="st">"local"</span></span>
<span id="cb52-172"><a href="#cb52-172" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb52-173"><a href="#cb52-173" aria-hidden="true" tabindex="-1"></a>        means, stds, src <span class="op">=</span> global_mean.astype(np.float32), global_std.astype(np.float32), <span class="st">"global"</span></span>
<span id="cb52-174"><a href="#cb52-174" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands):</span>
<span id="cb52-175"><a href="#cb52-175" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stds[i] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb52-176"><a href="#cb52-176" aria-hidden="true" tabindex="-1"></a>            normalized[i] <span class="op">=</span> (data[i] <span class="op">-</span> means[i]) <span class="op">/</span> stds[i]</span>
<span id="cb52-177"><a href="#cb52-177" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb52-178"><a href="#cb52-178" aria-hidden="true" tabindex="-1"></a>            normalized[i] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb52-179"><a href="#cb52-179" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> {<span class="st">"source"</span>: src, <span class="st">"means"</span>: means, <span class="st">"stds"</span>: stds, <span class="st">"output_mean"</span>: <span class="bu">float</span>(normalized.mean()), <span class="st">"output_std"</span>: <span class="bu">float</span>(normalized.std())}</span>
<span id="cb52-180"><a href="#cb52-180" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> normalized, stats</span>
<span id="cb52-181"><a href="#cb52-181" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-182"><a href="#cb52-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-183"><a href="#cb52-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-184"><a href="#cb52-184" aria-hidden="true" tabindex="-1"></a><span class="fu">### 4) Minimal STAC-like Dataset → `geogfm/data/datasets/stac_dataset.py`</span></span>
<span id="cb52-185"><a href="#cb52-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-188"><a href="#cb52-188" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-189"><a href="#cb52-189" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle: geogfm/data/datasets/stac_dataset.py</span></span>
<span id="cb52-190"><a href="#cb52-190" aria-hidden="true" tabindex="-1"></a><span class="co"># Minimal STAC-like dataset (Week 1)</span></span>
<span id="cb52-191"><a href="#cb52-191" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/data/datasets/stac_dataset.py`</span></span>
<span id="cb52-192"><a href="#cb52-192" aria-hidden="true" tabindex="-1"></a><span class="co">#| auto-imports: true</span></span>
<span id="cb52-193"><a href="#cb52-193" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb52-194"><a href="#cb52-194" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Optional</span>
<span id="cb52-195"><a href="#cb52-195" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb52-196"><a href="#cb52-196" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb52-197"><a href="#cb52-197" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb52-198"><a href="#cb52-198" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb52-199"><a href="#cb52-199" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset</span>
<span id="cb52-200"><a href="#cb52-200" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio <span class="im">as</span> rio</span>
<span id="cb52-201"><a href="#cb52-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-202"><a href="#cb52-202" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> StacLikeDataset(Dataset):</span>
<span id="cb52-203"><a href="#cb52-203" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Minimal dataset reading GeoTIFF files under a directory, or generating synthetic data.</span></span>
<span id="cb52-204"><a href="#cb52-204" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns images sized to (C, H, W) where H=W=image_size and divisible by patch size.</span></span>
<span id="cb52-205"><a href="#cb52-205" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-206"><a href="#cb52-206" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, root_dir: <span class="bu">str</span>, split: <span class="bu">str</span> <span class="op">=</span> <span class="st">"train"</span>, image_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span>, in_channels: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span>, length: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span>, seed: <span class="bu">int</span> <span class="op">=</span> <span class="dv">42</span>):</span>
<span id="cb52-207"><a href="#cb52-207" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.root <span class="op">=</span> Path(root_dir)</span>
<span id="cb52-208"><a href="#cb52-208" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.split <span class="op">=</span> split</span>
<span id="cb52-209"><a href="#cb52-209" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_size <span class="op">=</span> <span class="bu">int</span>(image_size)</span>
<span id="cb52-210"><a href="#cb52-210" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.in_channels <span class="op">=</span> <span class="bu">int</span>(in_channels)</span>
<span id="cb52-211"><a href="#cb52-211" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.length <span class="op">=</span> <span class="bu">int</span>(length)</span>
<span id="cb52-212"><a href="#cb52-212" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rng <span class="op">=</span> random.Random(seed)</span>
<span id="cb52-213"><a href="#cb52-213" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.files: List[Path] <span class="op">=</span> []</span>
<span id="cb52-214"><a href="#cb52-214" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.root.exists():</span>
<span id="cb52-215"><a href="#cb52-215" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> p <span class="kw">in</span> <span class="va">self</span>.root.rglob(<span class="st">"*.tif"</span>):</span>
<span id="cb52-216"><a href="#cb52-216" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.files.append(p)</span>
<span id="cb52-217"><a href="#cb52-217" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> split <span class="op">==</span> <span class="st">"val"</span>:</span>
<span id="cb52-218"><a href="#cb52-218" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.files <span class="op">=</span> <span class="va">self</span>.files[::<span class="dv">5</span>]</span>
<span id="cb52-219"><a href="#cb52-219" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> split <span class="op">==</span> <span class="st">"train"</span>:</span>
<span id="cb52-220"><a href="#cb52-220" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.files <span class="op">=</span> [p <span class="cf">for</span> i, p <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.files) <span class="cf">if</span> i <span class="op">%</span> <span class="dv">5</span> <span class="op">!=</span> <span class="dv">0</span>]</span>
<span id="cb52-221"><a href="#cb52-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-222"><a href="#cb52-222" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb52-223"><a href="#cb52-223" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">max</span>(<span class="bu">len</span>(<span class="va">self</span>.files), <span class="va">self</span>.length)</span>
<span id="cb52-224"><a href="#cb52-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-225"><a href="#cb52-225" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _load_or_synthesize(<span class="va">self</span>, idx: <span class="bu">int</span>) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb52-226"><a href="#cb52-226" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.files:</span>
<span id="cb52-227"><a href="#cb52-227" aria-hidden="true" tabindex="-1"></a>            path <span class="op">=</span> <span class="va">self</span>.files[idx <span class="op">%</span> <span class="bu">len</span>(<span class="va">self</span>.files)]</span>
<span id="cb52-228"><a href="#cb52-228" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> rio.<span class="bu">open</span>(path) <span class="im">as</span> src:</span>
<span id="cb52-229"><a href="#cb52-229" aria-hidden="true" tabindex="-1"></a>                arr <span class="op">=</span> src.read(out_shape<span class="op">=</span>(<span class="bu">min</span>(<span class="va">self</span>.in_channels, src.count), <span class="va">self</span>.image_size, <span class="va">self</span>.image_size))</span>
<span id="cb52-230"><a href="#cb52-230" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> arr.shape[<span class="dv">0</span>] <span class="op">&lt;</span> <span class="va">self</span>.in_channels:</span>
<span id="cb52-231"><a href="#cb52-231" aria-hidden="true" tabindex="-1"></a>                    pad <span class="op">=</span> np.zeros((<span class="va">self</span>.in_channels <span class="op">-</span> arr.shape[<span class="dv">0</span>], <span class="va">self</span>.image_size, <span class="va">self</span>.image_size), dtype<span class="op">=</span>arr.dtype)</span>
<span id="cb52-232"><a href="#cb52-232" aria-hidden="true" tabindex="-1"></a>                    arr <span class="op">=</span> np.concatenate([arr, pad], axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb52-233"><a href="#cb52-233" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> arr.astype(np.float32)</span>
<span id="cb52-234"><a href="#cb52-234" aria-hidden="true" tabindex="-1"></a>        <span class="co"># synthetic fallback</span></span>
<span id="cb52-235"><a href="#cb52-235" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rng.seed(idx)</span>
<span id="cb52-236"><a href="#cb52-236" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.random.rand(<span class="va">self</span>.in_channels, <span class="va">self</span>.image_size, <span class="va">self</span>.image_size).astype(np.float32)</span>
<span id="cb52-237"><a href="#cb52-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-238"><a href="#cb52-238" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx: <span class="bu">int</span>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb52-239"><a href="#cb52-239" aria-hidden="true" tabindex="-1"></a>        arr <span class="op">=</span> <span class="va">self</span>._load_or_synthesize(idx)</span>
<span id="cb52-240"><a href="#cb52-240" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.from_numpy(arr)</span>
<span id="cb52-241"><a href="#cb52-241" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-242"><a href="#cb52-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-243"><a href="#cb52-243" aria-hidden="true" tabindex="-1"></a><span class="fu">### 5) DataLoader Builders → `geogfm/data/loaders.py`</span></span>
<span id="cb52-244"><a href="#cb52-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-247"><a href="#cb52-247" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-248"><a href="#cb52-248" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle: geogfm/data/loaders.py</span></span>
<span id="cb52-249"><a href="#cb52-249" aria-hidden="true" tabindex="-1"></a><span class="co"># DataLoader builders (Week 1)</span></span>
<span id="cb52-250"><a href="#cb52-250" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/data/loaders.py`</span></span>
<span id="cb52-251"><a href="#cb52-251" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb52-252"><a href="#cb52-252" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb52-253"><a href="#cb52-253" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple</span>
<span id="cb52-254"><a href="#cb52-254" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb52-255"><a href="#cb52-255" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geogfm.core.config <span class="im">import</span> DataConfig</span>
<span id="cb52-256"><a href="#cb52-256" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geogfm.data.datasets.stac_dataset <span class="im">import</span> StacLikeDataset</span>
<span id="cb52-257"><a href="#cb52-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-258"><a href="#cb52-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-259"><a href="#cb52-259" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_dataloader(cfg: DataConfig) <span class="op">-&gt;</span> Tuple[DataLoader, DataLoader]:</span>
<span id="cb52-260"><a href="#cb52-260" aria-hidden="true" tabindex="-1"></a>    train_ds <span class="op">=</span> StacLikeDataset(cfg.root_dir, split<span class="op">=</span><span class="st">"train"</span>, image_size<span class="op">=</span>cfg.image_size, in_channels<span class="op">=</span>cfg.in_channels, length<span class="op">=</span>cfg.length, seed<span class="op">=</span>cfg.seed)</span>
<span id="cb52-261"><a href="#cb52-261" aria-hidden="true" tabindex="-1"></a>    val_ds <span class="op">=</span> StacLikeDataset(cfg.root_dir, split<span class="op">=</span><span class="st">"val"</span>, image_size<span class="op">=</span>cfg.image_size, in_channels<span class="op">=</span>cfg.in_channels, length<span class="op">=</span><span class="bu">max</span>(<span class="dv">8</span>, cfg.length <span class="op">//</span> <span class="dv">5</span>), seed<span class="op">=</span>cfg.seed)</span>
<span id="cb52-262"><a href="#cb52-262" aria-hidden="true" tabindex="-1"></a>    train_dl <span class="op">=</span> DataLoader(train_ds, batch_size<span class="op">=</span>cfg.batch_size, shuffle<span class="op">=</span><span class="va">True</span>, num_workers<span class="op">=</span>cfg.num_workers, pin_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb52-263"><a href="#cb52-263" aria-hidden="true" tabindex="-1"></a>    val_dl <span class="op">=</span> DataLoader(val_ds, batch_size<span class="op">=</span>cfg.batch_size, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span>cfg.num_workers, pin_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb52-264"><a href="#cb52-264" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_dl, val_dl</span>
<span id="cb52-265"><a href="#cb52-265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-266"><a href="#cb52-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-269"><a href="#cb52-269" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-270"><a href="#cb52-270" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb52-271"><a href="#cb52-271" aria-hidden="true" tabindex="-1"></a><span class="co"># Executable local version for this session (no geogfm imports)</span></span>
<span id="cb52-272"><a href="#cb52-272" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb52-273"><a href="#cb52-273" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple</span>
<span id="cb52-274"><a href="#cb52-274" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb52-275"><a href="#cb52-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-276"><a href="#cb52-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-277"><a href="#cb52-277" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_dataloader(cfg: DataConfig) <span class="op">-&gt;</span> Tuple[DataLoader, DataLoader]:</span>
<span id="cb52-278"><a href="#cb52-278" aria-hidden="true" tabindex="-1"></a>    train_ds <span class="op">=</span> StacLikeDataset(cfg.root_dir, split<span class="op">=</span><span class="st">"train"</span>, image_size<span class="op">=</span>cfg.image_size, in_channels<span class="op">=</span>cfg.in_channels, length<span class="op">=</span>cfg.length, seed<span class="op">=</span>cfg.seed)</span>
<span id="cb52-279"><a href="#cb52-279" aria-hidden="true" tabindex="-1"></a>    val_ds <span class="op">=</span> StacLikeDataset(cfg.root_dir, split<span class="op">=</span><span class="st">"val"</span>, image_size<span class="op">=</span>cfg.image_size, in_channels<span class="op">=</span>cfg.in_channels, length<span class="op">=</span><span class="bu">max</span>(<span class="dv">8</span>, cfg.length <span class="op">//</span> <span class="dv">5</span>), seed<span class="op">=</span>cfg.seed)</span>
<span id="cb52-280"><a href="#cb52-280" aria-hidden="true" tabindex="-1"></a>    train_dl <span class="op">=</span> DataLoader(train_ds, batch_size<span class="op">=</span>cfg.batch_size, shuffle<span class="op">=</span><span class="va">True</span>, num_workers<span class="op">=</span>cfg.num_workers, pin_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb52-281"><a href="#cb52-281" aria-hidden="true" tabindex="-1"></a>    val_dl <span class="op">=</span> DataLoader(val_ds, batch_size<span class="op">=</span>cfg.batch_size, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span>cfg.num_workers, pin_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb52-282"><a href="#cb52-282" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_dl, val_dl</span>
<span id="cb52-283"><a href="#cb52-283" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-284"><a href="#cb52-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-285"><a href="#cb52-285" aria-hidden="true" tabindex="-1"></a><span class="fu">## Learning Objectives</span></span>
<span id="cb52-286"><a href="#cb52-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-287"><a href="#cb52-287" aria-hidden="true" tabindex="-1"></a>By building this pipeline, you will:</span>
<span id="cb52-288"><a href="#cb52-288" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Implement** GeoTIFF loading and preprocessing functions</span>
<span id="cb52-289"><a href="#cb52-289" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Create** patch extraction with spatial metadata</span>
<span id="cb52-290"><a href="#cb52-290" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Build** tensor normalization and encoding functions  </span>
<span id="cb52-291"><a href="#cb52-291" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Construct** a PyTorch DataLoader for model training</span>
<span id="cb52-292"><a href="#cb52-292" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Connect** to a simple embedding layer to verify end-to-end functionality</span>
<span id="cb52-293"><a href="#cb52-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-294"><a href="#cb52-294" aria-hidden="true" tabindex="-1"></a><span class="fu">## Session Roadmap</span></span>
<span id="cb52-295"><a href="#cb52-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-298"><a href="#cb52-298" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb52-299"><a href="#cb52-299" aria-hidden="true" tabindex="-1"></a><span class="in">flowchart TD</span></span>
<span id="cb52-300"><a href="#cb52-300" aria-hidden="true" tabindex="-1"></a><span class="in">    A["Setup &amp; GeoTIFF Loading"] --&gt; B["Geo Preprocessing Functions"]</span></span>
<span id="cb52-301"><a href="#cb52-301" aria-hidden="true" tabindex="-1"></a><span class="in">    B --&gt; C["Patch Extraction with Metadata"] </span></span>
<span id="cb52-302"><a href="#cb52-302" aria-hidden="true" tabindex="-1"></a><span class="in">    C --&gt; D["Tensor Operations &amp; Normalization"]</span></span>
<span id="cb52-303"><a href="#cb52-303" aria-hidden="true" tabindex="-1"></a><span class="in">    D --&gt; E["DataLoader Construction"]</span></span>
<span id="cb52-304"><a href="#cb52-304" aria-hidden="true" tabindex="-1"></a><span class="in">    E --&gt; F["Embedding Layer Integration"]</span></span>
<span id="cb52-305"><a href="#cb52-305" aria-hidden="true" tabindex="-1"></a><span class="in">    F --&gt; G["End-to-End Pipeline Test"]</span></span>
<span id="cb52-306"><a href="#cb52-306" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-307"><a href="#cb52-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-308"><a href="#cb52-308" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setting Up</span></span>
<span id="cb52-309"><a href="#cb52-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-310"><a href="#cb52-310" aria-hidden="true" tabindex="-1"></a>Let's establish our development environment and define the core constants we'll use throughout.</span>
<span id="cb52-311"><a href="#cb52-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-312"><a href="#cb52-312" aria-hidden="true" tabindex="-1"></a><span class="fu">### Imports and Configuration</span></span>
<span id="cb52-313"><a href="#cb52-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-316"><a href="#cb52-316" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-317"><a href="#cb52-317" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb52-318"><a href="#cb52-318" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb52-319"><a href="#cb52-319" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb52-320"><a href="#cb52-320" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb52-321"><a href="#cb52-321" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb52-322"><a href="#cb52-322" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb52-323"><a href="#cb52-323" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset, DataLoader</span>
<span id="cb52-324"><a href="#cb52-324" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio <span class="im">as</span> rio</span>
<span id="cb52-325"><a href="#cb52-325" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb52-326"><a href="#cb52-326" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple, Dict, Any</span>
<span id="cb52-327"><a href="#cb52-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-328"><a href="#cb52-328" aria-hidden="true" tabindex="-1"></a><span class="co"># Set seeds for reproducibility</span></span>
<span id="cb52-329"><a href="#cb52-329" aria-hidden="true" tabindex="-1"></a>SEED <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb52-330"><a href="#cb52-330" aria-hidden="true" tabindex="-1"></a>random.seed(SEED)</span>
<span id="cb52-331"><a href="#cb52-331" aria-hidden="true" tabindex="-1"></a>np.random.seed(SEED)</span>
<span id="cb52-332"><a href="#cb52-332" aria-hidden="true" tabindex="-1"></a>torch.manual_seed(SEED)</span>
<span id="cb52-333"><a href="#cb52-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-334"><a href="#cb52-334" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline constants</span></span>
<span id="cb52-335"><a href="#cb52-335" aria-hidden="true" tabindex="-1"></a>PATCH_SIZE <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb52-336"><a href="#cb52-336" aria-hidden="true" tabindex="-1"></a>STRIDE <span class="op">=</span> <span class="dv">32</span>  <span class="co"># 50% overlap</span></span>
<span id="cb52-337"><a href="#cb52-337" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb52-338"><a href="#cb52-338" aria-hidden="true" tabindex="-1"></a>EMBEDDING_DIM <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb52-339"><a href="#cb52-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-340"><a href="#cb52-340" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Environment setup complete"</span>)</span>
<span id="cb52-341"><a href="#cb52-341" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Patch size: </span><span class="sc">{</span>PATCH_SIZE<span class="sc">}</span><span class="ss">x</span><span class="sc">{</span>PATCH_SIZE<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-342"><a href="#cb52-342" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Stride: </span><span class="sc">{</span>STRIDE<span class="sc">}</span><span class="ss"> (overlap: </span><span class="sc">{</span>(PATCH_SIZE<span class="op">-</span>STRIDE)<span class="op">/</span>PATCH_SIZE<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">%)"</span>)</span>
<span id="cb52-343"><a href="#cb52-343" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-344"><a href="#cb52-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-345"><a href="#cb52-345" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data Preparation</span></span>
<span id="cb52-346"><a href="#cb52-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-349"><a href="#cb52-349" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-350"><a href="#cb52-350" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up data paths - use book/data for course sample data</span></span>
<span id="cb52-351"><a href="#cb52-351" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"__file__"</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb52-352"><a href="#cb52-352" aria-hidden="true" tabindex="-1"></a>    <span class="co"># From chapters folder, go up 2 levels to book folder, then to data</span></span>
<span id="cb52-353"><a href="#cb52-353" aria-hidden="true" tabindex="-1"></a>    DATA_DIR <span class="op">=</span> Path(<span class="va">__file__</span>).parent.parent <span class="op">/</span> <span class="st">"data"</span></span>
<span id="cb52-354"><a href="#cb52-354" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb52-355"><a href="#cb52-355" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fallback for interactive environments - look for book folder</span></span>
<span id="cb52-356"><a href="#cb52-356" aria-hidden="true" tabindex="-1"></a>    current <span class="op">=</span> Path.cwd()</span>
<span id="cb52-357"><a href="#cb52-357" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> current.name <span class="kw">not</span> <span class="kw">in</span> [<span class="st">"book"</span>, <span class="st">"geoAI"</span>] <span class="kw">and</span> current.parent <span class="op">!=</span> current:</span>
<span id="cb52-358"><a href="#cb52-358" aria-hidden="true" tabindex="-1"></a>        current <span class="op">=</span> current.parent</span>
<span id="cb52-359"><a href="#cb52-359" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> current.name <span class="op">==</span> <span class="st">"book"</span>:</span>
<span id="cb52-360"><a href="#cb52-360" aria-hidden="true" tabindex="-1"></a>        DATA_DIR <span class="op">=</span> current <span class="op">/</span> <span class="st">"data"</span></span>
<span id="cb52-361"><a href="#cb52-361" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> current.name <span class="op">==</span> <span class="st">"geoAI"</span>:</span>
<span id="cb52-362"><a href="#cb52-362" aria-hidden="true" tabindex="-1"></a>        DATA_DIR <span class="op">=</span> current <span class="op">/</span> <span class="st">"book"</span> <span class="op">/</span> <span class="st">"data"</span></span>
<span id="cb52-363"><a href="#cb52-363" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb52-364"><a href="#cb52-364" aria-hidden="true" tabindex="-1"></a>        DATA_DIR <span class="op">=</span> Path(<span class="st">"data"</span>)</span>
<span id="cb52-365"><a href="#cb52-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-366"><a href="#cb52-366" aria-hidden="true" tabindex="-1"></a>DATA_DIR.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb52-367"><a href="#cb52-367" aria-hidden="true" tabindex="-1"></a>SAMPLE_PATH <span class="op">=</span> DATA_DIR <span class="op">/</span> <span class="st">"landcover_sample.tif"</span></span>
<span id="cb52-368"><a href="#cb52-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-369"><a href="#cb52-369" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify data file exists</span></span>
<span id="cb52-370"><a href="#cb52-370" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> SAMPLE_PATH.exists():</span>
<span id="cb52-371"><a href="#cb52-371" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="ss">f"Data file not found at </span><span class="sc">{</span>SAMPLE_PATH<span class="sc">}</span><span class="ss">. Please ensure the landcover_sample.tif file is available in the data directory."</span>)</span>
<span id="cb52-372"><a href="#cb52-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-373"><a href="#cb52-373" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Data ready: </span><span class="sc">{</span>SAMPLE_PATH<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-374"><a href="#cb52-374" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ File size: </span><span class="sc">{</span>SAMPLE_PATH<span class="sc">.</span>stat()<span class="sc">.</span>st_size <span class="op">/</span> <span class="dv">1024</span><span class="sc">:.1f}</span><span class="ss"> KB"</span>)</span>
<span id="cb52-375"><a href="#cb52-375" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Full path: </span><span class="sc">{</span>SAMPLE_PATH<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-376"><a href="#cb52-376" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-377"><a href="#cb52-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-378"><a href="#cb52-378" aria-hidden="true" tabindex="-1"></a>***</span>
<span id="cb52-379"><a href="#cb52-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-380"><a href="#cb52-380" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: GeoTIFF Loading and Inspection</span></span>
<span id="cb52-381"><a href="#cb52-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-382"><a href="#cb52-382" aria-hidden="true" tabindex="-1"></a>**Goal**: Build a function that loads and extracts essential information from any GeoTIFF.</span>
<span id="cb52-383"><a href="#cb52-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-384"><a href="#cb52-384" aria-hidden="true" tabindex="-1"></a><span class="fu">### 🛠️ Build It: GeoTIFF Loader Function</span></span>
<span id="cb52-385"><a href="#cb52-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-386"><a href="#cb52-386" aria-hidden="true" tabindex="-1"></a>Your task: Complete this function to load a GeoTIFF and return both the data and metadata.</span>
<span id="cb52-387"><a href="#cb52-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-390"><a href="#cb52-390" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-391"><a href="#cb52-391" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_geotiff(file_path: Path) <span class="op">-&gt;</span> Tuple[np.ndarray, Dict[<span class="bu">str</span>, Any]]:</span>
<span id="cb52-392"><a href="#cb52-392" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-393"><a href="#cb52-393" aria-hidden="true" tabindex="-1"></a><span class="co">    Load a GeoTIFF and extract data + metadata.</span></span>
<span id="cb52-394"><a href="#cb52-394" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb52-395"><a href="#cb52-395" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb52-396"><a href="#cb52-396" aria-hidden="true" tabindex="-1"></a><span class="co">        data: (bands, height, width) array</span></span>
<span id="cb52-397"><a href="#cb52-397" aria-hidden="true" tabindex="-1"></a><span class="co">        metadata: dict with CRS, transform, resolution, etc.</span></span>
<span id="cb52-398"><a href="#cb52-398" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-399"><a href="#cb52-399" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> rio.<span class="bu">open</span>(file_path) <span class="im">as</span> src:</span>
<span id="cb52-400"><a href="#cb52-400" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: Load the data array</span></span>
<span id="cb52-401"><a href="#cb52-401" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> src.read()  <span class="co"># YOUR CODE: Load raster data</span></span>
<span id="cb52-402"><a href="#cb52-402" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb52-403"><a href="#cb52-403" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: Extract metadata</span></span>
<span id="cb52-404"><a href="#cb52-404" aria-hidden="true" tabindex="-1"></a>        metadata <span class="op">=</span> {</span>
<span id="cb52-405"><a href="#cb52-405" aria-hidden="true" tabindex="-1"></a>            <span class="st">'crs'</span>: src.crs,  <span class="co"># YOUR CODE: Get coordinate reference system</span></span>
<span id="cb52-406"><a href="#cb52-406" aria-hidden="true" tabindex="-1"></a>            <span class="st">'transform'</span>: src.transform,  <span class="co"># YOUR CODE: Get geospatial transform</span></span>
<span id="cb52-407"><a href="#cb52-407" aria-hidden="true" tabindex="-1"></a>            <span class="st">'shape'</span>: data.shape,  <span class="co"># YOUR CODE: Get array dimensions</span></span>
<span id="cb52-408"><a href="#cb52-408" aria-hidden="true" tabindex="-1"></a>            <span class="st">'dtype'</span>: data.dtype,  <span class="co"># YOUR CODE: Get data type</span></span>
<span id="cb52-409"><a href="#cb52-409" aria-hidden="true" tabindex="-1"></a>            <span class="st">'resolution'</span>: src.res,  <span class="co"># YOUR CODE: Get pixel resolution</span></span>
<span id="cb52-410"><a href="#cb52-410" aria-hidden="true" tabindex="-1"></a>            <span class="st">'bounds'</span>: src.bounds,  <span class="co"># YOUR CODE: Get spatial bounds</span></span>
<span id="cb52-411"><a href="#cb52-411" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb52-412"><a href="#cb52-412" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-413"><a href="#cb52-413" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data, metadata</span>
<span id="cb52-414"><a href="#cb52-414" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-415"><a href="#cb52-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-418"><a href="#cb52-418" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-419"><a href="#cb52-419" aria-hidden="true" tabindex="-1"></a><span class="co"># Test your function</span></span>
<span id="cb52-420"><a href="#cb52-420" aria-hidden="true" tabindex="-1"></a>data, metadata <span class="op">=</span> load_geotiff(SAMPLE_PATH)</span>
<span id="cb52-421"><a href="#cb52-421" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Loaded shape: </span><span class="sc">{</span>data<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-422"><a href="#cb52-422" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Data type: </span><span class="sc">{</span>metadata[<span class="st">'dtype'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-423"><a href="#cb52-423" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Resolution: </span><span class="sc">{</span>metadata[<span class="st">'resolution'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-424"><a href="#cb52-424" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ CRS: </span><span class="sc">{</span>metadata[<span class="st">'crs'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-425"><a href="#cb52-425" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-426"><a href="#cb52-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-427"><a href="#cb52-427" aria-hidden="true" tabindex="-1"></a><span class="fu">### 🔍 Verify It: Inspect Your Data</span></span>
<span id="cb52-428"><a href="#cb52-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-431"><a href="#cb52-431" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-432"><a href="#cb52-432" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine the data you loaded</span></span>
<span id="cb52-433"><a href="#cb52-433" aria-hidden="true" tabindex="-1"></a>bands, height, width <span class="op">=</span> data.shape</span>
<span id="cb52-434"><a href="#cb52-434" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Image dimensions: </span><span class="sc">{</span>height<span class="sc">}</span><span class="ss">×</span><span class="sc">{</span>width<span class="sc">}</span><span class="ss"> pixels"</span>)</span>
<span id="cb52-435"><a href="#cb52-435" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of bands: </span><span class="sc">{</span>bands<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-436"><a href="#cb52-436" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Value ranges per band:"</span>)</span>
<span id="cb52-437"><a href="#cb52-437" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, band <span class="kw">in</span> <span class="bu">enumerate</span>(data):</span>
<span id="cb52-438"><a href="#cb52-438" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Band </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>band<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss"> to </span><span class="sc">{</span>band<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss">"</span>)</span>
<span id="cb52-439"><a href="#cb52-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-440"><a href="#cb52-440" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick visualization</span></span>
<span id="cb52-441"><a href="#cb52-441" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, bands, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb52-442"><a href="#cb52-442" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> bands <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb52-443"><a href="#cb52-443" aria-hidden="true" tabindex="-1"></a>    axes <span class="op">=</span> [axes]</span>
<span id="cb52-444"><a href="#cb52-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-445"><a href="#cb52-445" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, band <span class="kw">in</span> <span class="bu">enumerate</span>(data):</span>
<span id="cb52-446"><a href="#cb52-446" aria-hidden="true" tabindex="-1"></a>    axes[i].imshow(band, cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb52-447"><a href="#cb52-447" aria-hidden="true" tabindex="-1"></a>    axes[i].set_title(<span class="ss">f'Band </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb52-448"><a href="#cb52-448" aria-hidden="true" tabindex="-1"></a>    axes[i].axis(<span class="st">'off'</span>)</span>
<span id="cb52-449"><a href="#cb52-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-450"><a href="#cb52-450" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">'Raw Satellite Bands'</span>)</span>
<span id="cb52-451"><a href="#cb52-451" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb52-452"><a href="#cb52-452" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb52-453"><a href="#cb52-453" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-454"><a href="#cb52-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-455"><a href="#cb52-455" aria-hidden="true" tabindex="-1"></a>***</span>
<span id="cb52-456"><a href="#cb52-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-457"><a href="#cb52-457" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 2: Geo Preprocessing Functions</span></span>
<span id="cb52-458"><a href="#cb52-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-459"><a href="#cb52-459" aria-hidden="true" tabindex="-1"></a>**Goal**: Build preprocessing functions that operate on the full image before patch extraction.</span>
<span id="cb52-460"><a href="#cb52-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-461"><a href="#cb52-461" aria-hidden="true" tabindex="-1"></a><span class="fu">### 🛠️ Build It: Normalization Functions</span></span>
<span id="cb52-462"><a href="#cb52-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-463"><a href="#cb52-463" aria-hidden="true" tabindex="-1"></a>We'll create two normalization functions that can work with either **local statistics** (calculated from the input data) or **global statistics** (pre-computed from a training dataset). Global statistics ensure consistent normalization across different image tiles and are crucial for foundation model training.</span>
<span id="cb52-464"><a href="#cb52-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-465"><a href="#cb52-465" aria-hidden="true" tabindex="-1"></a>**Why use global statistics?** When training on multiple images, each tile might have different value ranges. Using global statistics ensures that the same pixel value represents the same relative intensity across all training data.</span>
<span id="cb52-466"><a href="#cb52-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-467"><a href="#cb52-467" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Min-Max Normalization Function</span></span>
<span id="cb52-468"><a href="#cb52-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-471"><a href="#cb52-471" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-472"><a href="#cb52-472" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> minmax_normalize(data: np.ndarray, </span>
<span id="cb52-473"><a href="#cb52-473" aria-hidden="true" tabindex="-1"></a>                    global_min: np.ndarray <span class="op">=</span> <span class="va">None</span>, </span>
<span id="cb52-474"><a href="#cb52-474" aria-hidden="true" tabindex="-1"></a>                    global_max: np.ndarray <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">tuple</span>[np.ndarray, <span class="bu">dict</span>]:</span>
<span id="cb52-475"><a href="#cb52-475" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-476"><a href="#cb52-476" aria-hidden="true" tabindex="-1"></a><span class="co">    Min-max normalize spectral bands to [0,1] range.</span></span>
<span id="cb52-477"><a href="#cb52-477" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb52-478"><a href="#cb52-478" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb52-479"><a href="#cb52-479" aria-hidden="true" tabindex="-1"></a><span class="co">        data: (bands, height, width) array</span></span>
<span id="cb52-480"><a href="#cb52-480" aria-hidden="true" tabindex="-1"></a><span class="co">        global_min: Optional (bands,) array of global minimums per band</span></span>
<span id="cb52-481"><a href="#cb52-481" aria-hidden="true" tabindex="-1"></a><span class="co">        global_max: Optional (bands,) array of global maximums per band</span></span>
<span id="cb52-482"><a href="#cb52-482" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb52-483"><a href="#cb52-483" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb52-484"><a href="#cb52-484" aria-hidden="true" tabindex="-1"></a><span class="co">        normalized: (bands, height, width) array with values in [0,1]</span></span>
<span id="cb52-485"><a href="#cb52-485" aria-hidden="true" tabindex="-1"></a><span class="co">        stats: Dictionary containing the min/max values used</span></span>
<span id="cb52-486"><a href="#cb52-486" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-487"><a href="#cb52-487" aria-hidden="true" tabindex="-1"></a>    bands, height, width <span class="op">=</span> data.shape</span>
<span id="cb52-488"><a href="#cb52-488" aria-hidden="true" tabindex="-1"></a>    normalized <span class="op">=</span> np.zeros_like(data, dtype<span class="op">=</span>np.float32)</span>
<span id="cb52-489"><a href="#cb52-489" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-490"><a href="#cb52-490" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use global stats if provided, otherwise calculate from data</span></span>
<span id="cb52-491"><a href="#cb52-491" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> global_min <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> global_max <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb52-492"><a href="#cb52-492" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate per-band statistics from this data</span></span>
<span id="cb52-493"><a href="#cb52-493" aria-hidden="true" tabindex="-1"></a>        mins <span class="op">=</span> np.array([data[i].<span class="bu">min</span>() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands)])</span>
<span id="cb52-494"><a href="#cb52-494" aria-hidden="true" tabindex="-1"></a>        maxs <span class="op">=</span> np.array([data[i].<span class="bu">max</span>() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands)])</span>
<span id="cb52-495"><a href="#cb52-495" aria-hidden="true" tabindex="-1"></a>        stats_source <span class="op">=</span> <span class="st">"local (calculated from input)"</span></span>
<span id="cb52-496"><a href="#cb52-496" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb52-497"><a href="#cb52-497" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use provided global statistics</span></span>
<span id="cb52-498"><a href="#cb52-498" aria-hidden="true" tabindex="-1"></a>        mins <span class="op">=</span> global_min</span>
<span id="cb52-499"><a href="#cb52-499" aria-hidden="true" tabindex="-1"></a>        maxs <span class="op">=</span> global_max</span>
<span id="cb52-500"><a href="#cb52-500" aria-hidden="true" tabindex="-1"></a>        stats_source <span class="op">=</span> <span class="st">"global (provided)"</span></span>
<span id="cb52-501"><a href="#cb52-501" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-502"><a href="#cb52-502" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply normalization per band</span></span>
<span id="cb52-503"><a href="#cb52-503" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands):</span>
<span id="cb52-504"><a href="#cb52-504" aria-hidden="true" tabindex="-1"></a>        band_range <span class="op">=</span> maxs[i] <span class="op">-</span> mins[i]</span>
<span id="cb52-505"><a href="#cb52-505" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> band_range <span class="op">&gt;</span> <span class="dv">0</span>:  <span class="co"># Avoid division by zero</span></span>
<span id="cb52-506"><a href="#cb52-506" aria-hidden="true" tabindex="-1"></a>            normalized[i] <span class="op">=</span> (data[i] <span class="op">-</span> mins[i]) <span class="op">/</span> band_range</span>
<span id="cb52-507"><a href="#cb52-507" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb52-508"><a href="#cb52-508" aria-hidden="true" tabindex="-1"></a>            normalized[i] <span class="op">=</span> <span class="dv">0</span>  <span class="co"># Handle constant bands</span></span>
<span id="cb52-509"><a href="#cb52-509" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-510"><a href="#cb52-510" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Package statistics for inspection</span></span>
<span id="cb52-511"><a href="#cb52-511" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> {</span>
<span id="cb52-512"><a href="#cb52-512" aria-hidden="true" tabindex="-1"></a>        <span class="st">'source'</span>: stats_source,</span>
<span id="cb52-513"><a href="#cb52-513" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mins'</span>: mins,</span>
<span id="cb52-514"><a href="#cb52-514" aria-hidden="true" tabindex="-1"></a>        <span class="st">'maxs'</span>: maxs,</span>
<span id="cb52-515"><a href="#cb52-515" aria-hidden="true" tabindex="-1"></a>        <span class="st">'output_range'</span>: (normalized.<span class="bu">min</span>(), normalized.<span class="bu">max</span>())</span>
<span id="cb52-516"><a href="#cb52-516" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb52-517"><a href="#cb52-517" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-518"><a href="#cb52-518" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> normalized, stats</span>
<span id="cb52-519"><a href="#cb52-519" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-520"><a href="#cb52-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-521"><a href="#cb52-521" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Z-Score Normalization Function</span></span>
<span id="cb52-522"><a href="#cb52-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-525"><a href="#cb52-525" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-526"><a href="#cb52-526" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> zscore_normalize(data: np.ndarray,</span>
<span id="cb52-527"><a href="#cb52-527" aria-hidden="true" tabindex="-1"></a>                    global_mean: np.ndarray <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb52-528"><a href="#cb52-528" aria-hidden="true" tabindex="-1"></a>                    global_std: np.ndarray <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">tuple</span>[np.ndarray, <span class="bu">dict</span>]:</span>
<span id="cb52-529"><a href="#cb52-529" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-530"><a href="#cb52-530" aria-hidden="true" tabindex="-1"></a><span class="co">    Z-score normalize spectral bands to mean=0, std=1.</span></span>
<span id="cb52-531"><a href="#cb52-531" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb52-532"><a href="#cb52-532" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb52-533"><a href="#cb52-533" aria-hidden="true" tabindex="-1"></a><span class="co">        data: (bands, height, width) array</span></span>
<span id="cb52-534"><a href="#cb52-534" aria-hidden="true" tabindex="-1"></a><span class="co">        global_mean: Optional (bands,) array of global means per band</span></span>
<span id="cb52-535"><a href="#cb52-535" aria-hidden="true" tabindex="-1"></a><span class="co">        global_std: Optional (bands,) array of global standard deviations per band</span></span>
<span id="cb52-536"><a href="#cb52-536" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb52-537"><a href="#cb52-537" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb52-538"><a href="#cb52-538" aria-hidden="true" tabindex="-1"></a><span class="co">        normalized: (bands, height, width) standardized array</span></span>
<span id="cb52-539"><a href="#cb52-539" aria-hidden="true" tabindex="-1"></a><span class="co">        stats: Dictionary containing the mean/std values used</span></span>
<span id="cb52-540"><a href="#cb52-540" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-541"><a href="#cb52-541" aria-hidden="true" tabindex="-1"></a>    bands, height, width <span class="op">=</span> data.shape</span>
<span id="cb52-542"><a href="#cb52-542" aria-hidden="true" tabindex="-1"></a>    normalized <span class="op">=</span> np.zeros_like(data, dtype<span class="op">=</span>np.float32)</span>
<span id="cb52-543"><a href="#cb52-543" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-544"><a href="#cb52-544" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use global stats if provided, otherwise calculate from data</span></span>
<span id="cb52-545"><a href="#cb52-545" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> global_mean <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> global_std <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb52-546"><a href="#cb52-546" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate per-band statistics from this data</span></span>
<span id="cb52-547"><a href="#cb52-547" aria-hidden="true" tabindex="-1"></a>        means <span class="op">=</span> np.array([data[i].mean() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands)])</span>
<span id="cb52-548"><a href="#cb52-548" aria-hidden="true" tabindex="-1"></a>        stds <span class="op">=</span> np.array([data[i].std() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands)])</span>
<span id="cb52-549"><a href="#cb52-549" aria-hidden="true" tabindex="-1"></a>        stats_source <span class="op">=</span> <span class="st">"local (calculated from input)"</span></span>
<span id="cb52-550"><a href="#cb52-550" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb52-551"><a href="#cb52-551" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use provided global statistics</span></span>
<span id="cb52-552"><a href="#cb52-552" aria-hidden="true" tabindex="-1"></a>        means <span class="op">=</span> global_mean</span>
<span id="cb52-553"><a href="#cb52-553" aria-hidden="true" tabindex="-1"></a>        stds <span class="op">=</span> global_std</span>
<span id="cb52-554"><a href="#cb52-554" aria-hidden="true" tabindex="-1"></a>        stats_source <span class="op">=</span> <span class="st">"global (provided)"</span></span>
<span id="cb52-555"><a href="#cb52-555" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-556"><a href="#cb52-556" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply normalization per band</span></span>
<span id="cb52-557"><a href="#cb52-557" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(bands):</span>
<span id="cb52-558"><a href="#cb52-558" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stds[i] <span class="op">&gt;</span> <span class="dv">0</span>:  <span class="co"># Avoid division by zero</span></span>
<span id="cb52-559"><a href="#cb52-559" aria-hidden="true" tabindex="-1"></a>            normalized[i] <span class="op">=</span> (data[i] <span class="op">-</span> means[i]) <span class="op">/</span> stds[i]</span>
<span id="cb52-560"><a href="#cb52-560" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb52-561"><a href="#cb52-561" aria-hidden="true" tabindex="-1"></a>            normalized[i] <span class="op">=</span> <span class="dv">0</span>  <span class="co"># Handle constant bands</span></span>
<span id="cb52-562"><a href="#cb52-562" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-563"><a href="#cb52-563" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Package statistics for inspection</span></span>
<span id="cb52-564"><a href="#cb52-564" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> {</span>
<span id="cb52-565"><a href="#cb52-565" aria-hidden="true" tabindex="-1"></a>        <span class="st">'source'</span>: stats_source,</span>
<span id="cb52-566"><a href="#cb52-566" aria-hidden="true" tabindex="-1"></a>        <span class="st">'means'</span>: means,</span>
<span id="cb52-567"><a href="#cb52-567" aria-hidden="true" tabindex="-1"></a>        <span class="st">'stds'</span>: stds,</span>
<span id="cb52-568"><a href="#cb52-568" aria-hidden="true" tabindex="-1"></a>        <span class="st">'output_mean'</span>: normalized.mean(),</span>
<span id="cb52-569"><a href="#cb52-569" aria-hidden="true" tabindex="-1"></a>        <span class="st">'output_std'</span>: normalized.std()</span>
<span id="cb52-570"><a href="#cb52-570" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb52-571"><a href="#cb52-571" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-572"><a href="#cb52-572" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> normalized, stats</span>
<span id="cb52-573"><a href="#cb52-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-574"><a href="#cb52-574" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ Normalization functions created"</span>)</span>
<span id="cb52-575"><a href="#cb52-575" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  - minmax_normalize: scales to [0,1] range"</span>)</span>
<span id="cb52-576"><a href="#cb52-576" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  - zscore_normalize: standardizes to mean=0, std=1"</span>)</span>
<span id="cb52-577"><a href="#cb52-577" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-578"><a href="#cb52-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-579"><a href="#cb52-579" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Test Both Functions with Local Statistics</span></span>
<span id="cb52-580"><a href="#cb52-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-583"><a href="#cb52-583" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-584"><a href="#cb52-584" aria-hidden="true" tabindex="-1"></a><span class="co"># Test min-max normalization with local statistics</span></span>
<span id="cb52-585"><a href="#cb52-585" aria-hidden="true" tabindex="-1"></a>minmax_data, minmax_stats <span class="op">=</span> minmax_normalize(data)</span>
<span id="cb52-586"><a href="#cb52-586" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"📊 Min-Max Normalization (local stats):"</span>)</span>
<span id="cb52-587"><a href="#cb52-587" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Source: </span><span class="sc">{</span>minmax_stats[<span class="st">'source'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-588"><a href="#cb52-588" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Original range: </span><span class="sc">{</span>data<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss"> to </span><span class="sc">{</span>data<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss">"</span>)</span>
<span id="cb52-589"><a href="#cb52-589" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Normalized range: </span><span class="sc">{</span>minmax_stats[<span class="st">'output_range'</span>][<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss"> to </span><span class="sc">{</span>minmax_stats[<span class="st">'output_range'</span>][<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb52-590"><a href="#cb52-590" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Per-band mins: </span><span class="sc">{</span>minmax_stats[<span class="st">'mins'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-591"><a href="#cb52-591" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Per-band maxs: </span><span class="sc">{</span>minmax_stats[<span class="st">'maxs'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-592"><a href="#cb52-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-593"><a href="#cb52-593" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb52-594"><a href="#cb52-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-595"><a href="#cb52-595" aria-hidden="true" tabindex="-1"></a><span class="co"># Test z-score normalization with local statistics  </span></span>
<span id="cb52-596"><a href="#cb52-596" aria-hidden="true" tabindex="-1"></a>zscore_data, zscore_stats <span class="op">=</span> zscore_normalize(data)</span>
<span id="cb52-597"><a href="#cb52-597" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"📊 Z-Score Normalization (local stats):"</span>)</span>
<span id="cb52-598"><a href="#cb52-598" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Source: </span><span class="sc">{</span>zscore_stats[<span class="st">'source'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-599"><a href="#cb52-599" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Output mean: </span><span class="sc">{</span>zscore_stats[<span class="st">'output_mean'</span>]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb52-600"><a href="#cb52-600" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Output std: </span><span class="sc">{</span>zscore_stats[<span class="st">'output_std'</span>]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb52-601"><a href="#cb52-601" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Per-band means: </span><span class="sc">{</span>zscore_stats[<span class="st">'means'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-602"><a href="#cb52-602" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Per-band stds: </span><span class="sc">{</span>zscore_stats[<span class="st">'stds'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-603"><a href="#cb52-603" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-604"><a href="#cb52-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-605"><a href="#cb52-605" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Test with Global Statistics</span></span>
<span id="cb52-606"><a href="#cb52-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-609"><a href="#cb52-609" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-610"><a href="#cb52-610" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate global statistics from a larger dataset</span></span>
<span id="cb52-611"><a href="#cb52-611" aria-hidden="true" tabindex="-1"></a><span class="co"># In practice, these would be pre-computed from your entire training corpus</span></span>
<span id="cb52-612"><a href="#cb52-612" aria-hidden="true" tabindex="-1"></a>global_mins <span class="op">=</span> np.array([<span class="dv">100</span>, <span class="dv">150</span>, <span class="dv">200</span>])  <span class="co"># Example global minimums per band</span></span>
<span id="cb52-613"><a href="#cb52-613" aria-hidden="true" tabindex="-1"></a>global_maxs <span class="op">=</span> np.array([<span class="dv">1500</span>, <span class="dv">2000</span>, <span class="dv">2500</span>])  <span class="co"># Example global maximums per band</span></span>
<span id="cb52-614"><a href="#cb52-614" aria-hidden="true" tabindex="-1"></a>global_means <span class="op">=</span> np.array([<span class="dv">800</span>, <span class="dv">1200</span>, <span class="dv">1600</span>])  <span class="co"># Example global means per band</span></span>
<span id="cb52-615"><a href="#cb52-615" aria-hidden="true" tabindex="-1"></a>global_stds <span class="op">=</span> np.array([<span class="dv">300</span>, <span class="dv">400</span>, <span class="dv">500</span>])  <span class="co"># Example global standard deviations per band</span></span>
<span id="cb52-616"><a href="#cb52-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-617"><a href="#cb52-617" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"🌍 Testing with Global Statistics:"</span>)</span>
<span id="cb52-618"><a href="#cb52-618" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Global mins: </span><span class="sc">{</span>global_mins<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-619"><a href="#cb52-619" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Global maxs: </span><span class="sc">{</span>global_maxs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-620"><a href="#cb52-620" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Global means: </span><span class="sc">{</span>global_means<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-621"><a href="#cb52-621" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Global stds: </span><span class="sc">{</span>global_stds<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-622"><a href="#cb52-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-623"><a href="#cb52-623" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb52-624"><a href="#cb52-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-625"><a href="#cb52-625" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with global statistics</span></span>
<span id="cb52-626"><a href="#cb52-626" aria-hidden="true" tabindex="-1"></a>minmax_global, minmax_global_stats <span class="op">=</span> minmax_normalize(data, global_mins, global_maxs)</span>
<span id="cb52-627"><a href="#cb52-627" aria-hidden="true" tabindex="-1"></a>zscore_global, zscore_global_stats <span class="op">=</span> zscore_normalize(data, global_means, global_stds)</span>
<span id="cb52-628"><a href="#cb52-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-629"><a href="#cb52-629" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"📊 Min-Max with Global Stats:"</span>)</span>
<span id="cb52-630"><a href="#cb52-630" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Source: </span><span class="sc">{</span>minmax_global_stats[<span class="st">'source'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-631"><a href="#cb52-631" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Output range: </span><span class="sc">{</span>minmax_global_stats[<span class="st">'output_range'</span>][<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss"> to </span><span class="sc">{</span>minmax_global_stats[<span class="st">'output_range'</span>][<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb52-632"><a href="#cb52-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-633"><a href="#cb52-633" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb52-634"><a href="#cb52-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-635"><a href="#cb52-635" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"📊 Z-Score with Global Stats:"</span>)</span>
<span id="cb52-636"><a href="#cb52-636" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Source: </span><span class="sc">{</span>zscore_global_stats[<span class="st">'source'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-637"><a href="#cb52-637" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Output mean: </span><span class="sc">{</span>zscore_global_stats[<span class="st">'output_mean'</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb52-638"><a href="#cb52-638" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Output std: </span><span class="sc">{</span>zscore_global_stats[<span class="st">'output_std'</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb52-639"><a href="#cb52-639" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-640"><a href="#cb52-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-641"><a href="#cb52-641" aria-hidden="true" tabindex="-1"></a>**What to notice:** When using global statistics, the output ranges and distributions differ from local normalization. This is expected and ensures consistency across different image tiles in your dataset.</span>
<span id="cb52-642"><a href="#cb52-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-643"><a href="#cb52-643" aria-hidden="true" tabindex="-1"></a><span class="fu">### 🛠️ Build It: Spatial Cropping Function</span></span>
<span id="cb52-644"><a href="#cb52-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-647"><a href="#cb52-647" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-648"><a href="#cb52-648" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle: geogfm/data/transforms/patchify.py</span></span>
<span id="cb52-649"><a href="#cb52-649" aria-hidden="true" tabindex="-1"></a><span class="co"># Patch extraction utilities (Week 1)</span></span>
<span id="cb52-650"><a href="#cb52-650" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles to `geogfm/data/transforms/patchify.py`</span></span>
<span id="cb52-651"><a href="#cb52-651" aria-hidden="true" tabindex="-1"></a><span class="co">#| auto-imports: true</span></span>
<span id="cb52-652"><a href="#cb52-652" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb52-653"><a href="#cb52-653" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb52-654"><a href="#cb52-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-655"><a href="#cb52-655" aria-hidden="true" tabindex="-1"></a>Array <span class="op">=</span> np.ndarray</span>
<span id="cb52-656"><a href="#cb52-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-657"><a href="#cb52-657" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> crop_to_patches(data: Array, patch_size: <span class="bu">int</span>, stride: <span class="bu">int</span>) <span class="op">-&gt;</span> Array:</span>
<span id="cb52-658"><a href="#cb52-658" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-659"><a href="#cb52-659" aria-hidden="true" tabindex="-1"></a><span class="co">    Crop image to dimensions that allow complete patch extraction.</span></span>
<span id="cb52-660"><a href="#cb52-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-661"><a href="#cb52-661" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb52-662"><a href="#cb52-662" aria-hidden="true" tabindex="-1"></a><span class="co">        data: (bands, height, width) array</span></span>
<span id="cb52-663"><a href="#cb52-663" aria-hidden="true" tabindex="-1"></a><span class="co">        patch_size: size of patches to extract</span></span>
<span id="cb52-664"><a href="#cb52-664" aria-hidden="true" tabindex="-1"></a><span class="co">        stride: step size between patches</span></span>
<span id="cb52-665"><a href="#cb52-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-666"><a href="#cb52-666" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb52-667"><a href="#cb52-667" aria-hidden="true" tabindex="-1"></a><span class="co">        cropped: (bands, new_height, new_width) array</span></span>
<span id="cb52-668"><a href="#cb52-668" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-669"><a href="#cb52-669" aria-hidden="true" tabindex="-1"></a>    bands, height, width <span class="op">=</span> data.shape</span>
<span id="cb52-670"><a href="#cb52-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-671"><a href="#cb52-671" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: Calculate how many complete patches fit</span></span>
<span id="cb52-672"><a href="#cb52-672" aria-hidden="true" tabindex="-1"></a>    patches_h <span class="op">=</span> (height <span class="op">-</span> patch_size) <span class="op">//</span> stride <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb52-673"><a href="#cb52-673" aria-hidden="true" tabindex="-1"></a>    patches_w <span class="op">=</span> (width <span class="op">-</span> patch_size) <span class="op">//</span> stride <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb52-674"><a href="#cb52-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-675"><a href="#cb52-675" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: Calculate the required dimensions</span></span>
<span id="cb52-676"><a href="#cb52-676" aria-hidden="true" tabindex="-1"></a>    new_height <span class="op">=</span> (patches_h <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> stride <span class="op">+</span> patch_size</span>
<span id="cb52-677"><a href="#cb52-677" aria-hidden="true" tabindex="-1"></a>    new_width <span class="op">=</span> (patches_w <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> stride <span class="op">+</span> patch_size</span>
<span id="cb52-678"><a href="#cb52-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-679"><a href="#cb52-679" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: Crop the data</span></span>
<span id="cb52-680"><a href="#cb52-680" aria-hidden="true" tabindex="-1"></a>    cropped <span class="op">=</span> data[:, :new_height, :new_width]</span>
<span id="cb52-681"><a href="#cb52-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-682"><a href="#cb52-682" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Cropped from </span><span class="sc">{</span>height<span class="sc">}</span><span class="ss">×</span><span class="sc">{</span>width<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>new_height<span class="sc">}</span><span class="ss">×</span><span class="sc">{</span>new_width<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-683"><a href="#cb52-683" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb52-684"><a href="#cb52-684" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"✓ Will generate </span><span class="sc">{</span>patches_h<span class="sc">}</span><span class="ss">×</span><span class="sc">{</span>patches_w<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span>patches_h<span class="op">*</span>patches_w<span class="sc">}</span><span class="ss"> patches"</span>)</span>
<span id="cb52-685"><a href="#cb52-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-686"><a href="#cb52-686" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cropped</span>
<span id="cb52-687"><a href="#cb52-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-688"><a href="#cb52-688" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-689"><a href="#cb52-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-692"><a href="#cb52-692" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-693"><a href="#cb52-693" aria-hidden="true" tabindex="-1"></a><span class="co"># Test your cropping function</span></span>
<span id="cb52-694"><a href="#cb52-694" aria-hidden="true" tabindex="-1"></a>cropped_data <span class="op">=</span> crop_to_patches(data, <span class="dv">8</span>, STRIDE)</span>
<span id="cb52-695"><a href="#cb52-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-696"><a href="#cb52-696" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-697"><a href="#cb52-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-698"><a href="#cb52-698" aria-hidden="true" tabindex="-1"></a>***</span>
<span id="cb52-699"><a href="#cb52-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-700"><a href="#cb52-700" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3: Patch Extraction with Metadata</span></span>
<span id="cb52-701"><a href="#cb52-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-702"><a href="#cb52-702" aria-hidden="true" tabindex="-1"></a>**Goal**: Extract patches while preserving spatial context information.</span>
<span id="cb52-703"><a href="#cb52-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-704"><a href="#cb52-704" aria-hidden="true" tabindex="-1"></a><span class="fu">### 🛠️ Build It: Patch Extraction Function</span></span>
<span id="cb52-705"><a href="#cb52-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-708"><a href="#cb52-708" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-709"><a href="#cb52-709" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle: geogfm/data/transforms/patchify.py</span></span>
<span id="cb52-710"><a href="#cb52-710" aria-hidden="true" tabindex="-1"></a><span class="co"># Patch extraction with spatial metadata (Week 1)</span></span>
<span id="cb52-711"><a href="#cb52-711" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles (append) to `geogfm/data/transforms/patchify.py`</span></span>
<span id="cb52-712"><a href="#cb52-712" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle-mode: append</span></span>
<span id="cb52-713"><a href="#cb52-713" aria-hidden="true" tabindex="-1"></a><span class="co">#| auto-import: true</span></span>
<span id="cb52-714"><a href="#cb52-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-715"><a href="#cb52-715" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_patches(</span>
<span id="cb52-716"><a href="#cb52-716" aria-hidden="true" tabindex="-1"></a>    data: Array,</span>
<span id="cb52-717"><a href="#cb52-717" aria-hidden="true" tabindex="-1"></a>    patch_size: <span class="bu">int</span>,</span>
<span id="cb52-718"><a href="#cb52-718" aria-hidden="true" tabindex="-1"></a>    stride: <span class="bu">int</span></span>
<span id="cb52-719"><a href="#cb52-719" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Array:</span>
<span id="cb52-720"><a href="#cb52-720" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-721"><a href="#cb52-721" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract patches.</span></span>
<span id="cb52-722"><a href="#cb52-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-723"><a href="#cb52-723" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb52-724"><a href="#cb52-724" aria-hidden="true" tabindex="-1"></a><span class="co">        data: (bands, height, width) normalized array</span></span>
<span id="cb52-725"><a href="#cb52-725" aria-hidden="true" tabindex="-1"></a><span class="co">        patch_size: size of patches</span></span>
<span id="cb52-726"><a href="#cb52-726" aria-hidden="true" tabindex="-1"></a><span class="co">        stride: step between patches</span></span>
<span id="cb52-727"><a href="#cb52-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-728"><a href="#cb52-728" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb52-729"><a href="#cb52-729" aria-hidden="true" tabindex="-1"></a><span class="co">        patches: (n_patches, bands, patch_size, patch_size) array</span></span>
<span id="cb52-730"><a href="#cb52-730" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-731"><a href="#cb52-731" aria-hidden="true" tabindex="-1"></a>    bands, height, width <span class="op">=</span> data.shape</span>
<span id="cb52-732"><a href="#cb52-732" aria-hidden="true" tabindex="-1"></a>    patches <span class="op">=</span> []</span>
<span id="cb52-733"><a href="#cb52-733" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> r <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, height <span class="op">-</span> patch_size <span class="op">+</span> <span class="dv">1</span>, stride):</span>
<span id="cb52-734"><a href="#cb52-734" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, width <span class="op">-</span> patch_size <span class="op">+</span> <span class="dv">1</span>, stride):</span>
<span id="cb52-735"><a href="#cb52-735" aria-hidden="true" tabindex="-1"></a>            patches.append(data[:, r:r<span class="op">+</span>patch_size, c:c<span class="op">+</span>patch_size])</span>
<span id="cb52-736"><a href="#cb52-736" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.stack(patches, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb52-737"><a href="#cb52-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-738"><a href="#cb52-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-739"><a href="#cb52-739" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_patches_with_metadata(</span>
<span id="cb52-740"><a href="#cb52-740" aria-hidden="true" tabindex="-1"></a>    data: Array,</span>
<span id="cb52-741"><a href="#cb52-741" aria-hidden="true" tabindex="-1"></a>    patch_size: <span class="bu">int</span>,</span>
<span id="cb52-742"><a href="#cb52-742" aria-hidden="true" tabindex="-1"></a>    stride: <span class="bu">int</span>,</span>
<span id="cb52-743"><a href="#cb52-743" aria-hidden="true" tabindex="-1"></a>    transform</span>
<span id="cb52-744"><a href="#cb52-744" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[Array, Array]:</span>
<span id="cb52-745"><a href="#cb52-745" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-746"><a href="#cb52-746" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract patches with their spatial coordinates.</span></span>
<span id="cb52-747"><a href="#cb52-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-748"><a href="#cb52-748" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb52-749"><a href="#cb52-749" aria-hidden="true" tabindex="-1"></a><span class="co">        data: (bands, height, width) normalized array</span></span>
<span id="cb52-750"><a href="#cb52-750" aria-hidden="true" tabindex="-1"></a><span class="co">        patch_size: size of patches</span></span>
<span id="cb52-751"><a href="#cb52-751" aria-hidden="true" tabindex="-1"></a><span class="co">        stride: step between patches</span></span>
<span id="cb52-752"><a href="#cb52-752" aria-hidden="true" tabindex="-1"></a><span class="co">        transform: rasterio transform object</span></span>
<span id="cb52-753"><a href="#cb52-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-754"><a href="#cb52-754" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb52-755"><a href="#cb52-755" aria-hidden="true" tabindex="-1"></a><span class="co">        patches: (n_patches, bands, patch_size, patch_size) array</span></span>
<span id="cb52-756"><a href="#cb52-756" aria-hidden="true" tabindex="-1"></a><span class="co">        coordinates: (n_patches, 4) array of [min_x, min_y, max_x, max_y]</span></span>
<span id="cb52-757"><a href="#cb52-757" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-758"><a href="#cb52-758" aria-hidden="true" tabindex="-1"></a>    bands, height, width <span class="op">=</span> data.shape</span>
<span id="cb52-759"><a href="#cb52-759" aria-hidden="true" tabindex="-1"></a>    patches <span class="op">=</span> []</span>
<span id="cb52-760"><a href="#cb52-760" aria-hidden="true" tabindex="-1"></a>    coordinates <span class="op">=</span> []</span>
<span id="cb52-761"><a href="#cb52-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-762"><a href="#cb52-762" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: Iterate through patch positions</span></span>
<span id="cb52-763"><a href="#cb52-763" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, height <span class="op">-</span> patch_size <span class="op">+</span> <span class="dv">1</span>, stride):</span>
<span id="cb52-764"><a href="#cb52-764" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, width <span class="op">-</span> patch_size <span class="op">+</span> <span class="dv">1</span>, stride):</span>
<span id="cb52-765"><a href="#cb52-765" aria-hidden="true" tabindex="-1"></a>            <span class="co"># </span><span class="al">TODO</span><span class="co">: Extract patch from all bands</span></span>
<span id="cb52-766"><a href="#cb52-766" aria-hidden="true" tabindex="-1"></a>            patch <span class="op">=</span> data[:, row:row<span class="op">+</span>patch_size, col:col<span class="op">+</span>patch_size]</span>
<span id="cb52-767"><a href="#cb52-767" aria-hidden="true" tabindex="-1"></a>            patches.append(patch)</span>
<span id="cb52-768"><a href="#cb52-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-769"><a href="#cb52-769" aria-hidden="true" tabindex="-1"></a>            <span class="co"># </span><span class="al">TODO</span><span class="co">: Calculate real-world coordinates using transform</span></span>
<span id="cb52-770"><a href="#cb52-770" aria-hidden="true" tabindex="-1"></a>            min_x, max_y <span class="op">=</span> transform <span class="op">*</span> (col, row)  <span class="co"># Top-left</span></span>
<span id="cb52-771"><a href="#cb52-771" aria-hidden="true" tabindex="-1"></a>            max_x, min_y <span class="op">=</span> transform <span class="op">*</span> <span class="op">\</span></span>
<span id="cb52-772"><a href="#cb52-772" aria-hidden="true" tabindex="-1"></a>                (col <span class="op">+</span> patch_size, row <span class="op">+</span> patch_size)  <span class="co"># Bottom-right</span></span>
<span id="cb52-773"><a href="#cb52-773" aria-hidden="true" tabindex="-1"></a>            coordinates.append([min_x, min_y, max_x, max_y])</span>
<span id="cb52-774"><a href="#cb52-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-775"><a href="#cb52-775" aria-hidden="true" tabindex="-1"></a>    patches <span class="op">=</span> np.array(patches)</span>
<span id="cb52-776"><a href="#cb52-776" aria-hidden="true" tabindex="-1"></a>    coordinates <span class="op">=</span> np.array(coordinates)</span>
<span id="cb52-777"><a href="#cb52-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-778"><a href="#cb52-778" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Extracted </span><span class="sc">{</span><span class="bu">len</span>(patches)<span class="sc">}</span><span class="ss"> patches"</span>)</span>
<span id="cb52-779"><a href="#cb52-779" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Patch shape: </span><span class="sc">{</span>patches<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-780"><a href="#cb52-780" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Coordinate shape: </span><span class="sc">{</span>coordinates<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-781"><a href="#cb52-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-782"><a href="#cb52-782" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> patches, coordinates</span>
<span id="cb52-783"><a href="#cb52-783" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-784"><a href="#cb52-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-787"><a href="#cb52-787" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-788"><a href="#cb52-788" aria-hidden="true" tabindex="-1"></a><span class="co"># Test your patch extraction</span></span>
<span id="cb52-789"><a href="#cb52-789" aria-hidden="true" tabindex="-1"></a>patches, coords <span class="op">=</span> extract_patches_with_metadata(</span>
<span id="cb52-790"><a href="#cb52-790" aria-hidden="true" tabindex="-1"></a>    data, <span class="dv">8</span>, <span class="dv">4</span>, metadata[<span class="st">'transform'</span>]</span>
<span id="cb52-791"><a href="#cb52-791" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-792"><a href="#cb52-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-793"><a href="#cb52-793" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize a few patches</span></span>
<span id="cb52-794"><a href="#cb52-794" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb52-795"><a href="#cb52-795" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">8</span>):</span>
<span id="cb52-796"><a href="#cb52-796" aria-hidden="true" tabindex="-1"></a>    row, col <span class="op">=</span> i <span class="op">//</span> <span class="dv">4</span>, i <span class="op">%</span> <span class="dv">4</span></span>
<span id="cb52-797"><a href="#cb52-797" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show first band of each patch</span></span>
<span id="cb52-798"><a href="#cb52-798" aria-hidden="true" tabindex="-1"></a>    axes[row, col].imshow(patches[i, <span class="dv">0</span>], cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb52-799"><a href="#cb52-799" aria-hidden="true" tabindex="-1"></a>    axes[row, col].set_title(<span class="ss">f'Patch </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb52-800"><a href="#cb52-800" aria-hidden="true" tabindex="-1"></a>    axes[row, col].axis(<span class="st">'off'</span>)</span>
<span id="cb52-801"><a href="#cb52-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-802"><a href="#cb52-802" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">'Sample Extracted Patches (Band 1)'</span>)</span>
<span id="cb52-803"><a href="#cb52-803" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb52-804"><a href="#cb52-804" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb52-805"><a href="#cb52-805" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-806"><a href="#cb52-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-807"><a href="#cb52-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-810"><a href="#cb52-810" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-811"><a href="#cb52-811" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle: geogfm/data/transforms/patchify.py</span></span>
<span id="cb52-812"><a href="#cb52-812" aria-hidden="true" tabindex="-1"></a><span class="co"># Reconstruction from patches (Week 1)</span></span>
<span id="cb52-813"><a href="#cb52-813" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangles (append) to `geogfm/data/transforms/patchify.py`</span></span>
<span id="cb52-814"><a href="#cb52-814" aria-hidden="true" tabindex="-1"></a><span class="co">#| tangle-mode: append</span></span>
<span id="cb52-815"><a href="#cb52-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-816"><a href="#cb52-816" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> reconstruct_from_patches(</span>
<span id="cb52-817"><a href="#cb52-817" aria-hidden="true" tabindex="-1"></a>    patches: Array,</span>
<span id="cb52-818"><a href="#cb52-818" aria-hidden="true" tabindex="-1"></a>    height: <span class="bu">int</span>,</span>
<span id="cb52-819"><a href="#cb52-819" aria-hidden="true" tabindex="-1"></a>    width: <span class="bu">int</span>,</span>
<span id="cb52-820"><a href="#cb52-820" aria-hidden="true" tabindex="-1"></a>    patch_size: <span class="bu">int</span></span>
<span id="cb52-821"><a href="#cb52-821" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Array:</span>
<span id="cb52-822"><a href="#cb52-822" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-823"><a href="#cb52-823" aria-hidden="true" tabindex="-1"></a><span class="co">    Reassemble a (bands, H, W) image from non-overlapping square patches.</span></span>
<span id="cb52-824"><a href="#cb52-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-825"><a href="#cb52-825" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb52-826"><a href="#cb52-826" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb52-827"><a href="#cb52-827" aria-hidden="true" tabindex="-1"></a><span class="co">    patches : Array</span></span>
<span id="cb52-828"><a href="#cb52-828" aria-hidden="true" tabindex="-1"></a><span class="co">        Patches in row-major scan order with shape (N, bands, patch_size, patch_size),</span></span>
<span id="cb52-829"><a href="#cb52-829" aria-hidden="true" tabindex="-1"></a><span class="co">        where N must equal (height // patch_size) * (width // patch_size).</span></span>
<span id="cb52-830"><a href="#cb52-830" aria-hidden="true" tabindex="-1"></a><span class="co">    height : int</span></span>
<span id="cb52-831"><a href="#cb52-831" aria-hidden="true" tabindex="-1"></a><span class="co">        Target image height in pixels.</span></span>
<span id="cb52-832"><a href="#cb52-832" aria-hidden="true" tabindex="-1"></a><span class="co">    width : int</span></span>
<span id="cb52-833"><a href="#cb52-833" aria-hidden="true" tabindex="-1"></a><span class="co">        Target image width in pixels.</span></span>
<span id="cb52-834"><a href="#cb52-834" aria-hidden="true" tabindex="-1"></a><span class="co">    patch_size : int</span></span>
<span id="cb52-835"><a href="#cb52-835" aria-hidden="true" tabindex="-1"></a><span class="co">        Size of each square patch in pixels. Assumes stride == patch_size (no overlap).</span></span>
<span id="cb52-836"><a href="#cb52-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-837"><a href="#cb52-837" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb52-838"><a href="#cb52-838" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb52-839"><a href="#cb52-839" aria-hidden="true" tabindex="-1"></a><span class="co">    Array</span></span>
<span id="cb52-840"><a href="#cb52-840" aria-hidden="true" tabindex="-1"></a><span class="co">        Reconstructed image of shape (bands, height, width).</span></span>
<span id="cb52-841"><a href="#cb52-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-842"><a href="#cb52-842" aria-hidden="true" tabindex="-1"></a><span class="co">    Notes</span></span>
<span id="cb52-843"><a href="#cb52-843" aria-hidden="true" tabindex="-1"></a><span class="co">    -----</span></span>
<span id="cb52-844"><a href="#cb52-844" aria-hidden="true" tabindex="-1"></a><span class="co">    - Assumes patches are laid out left-to-right, top-to-bottom (row-major).</span></span>
<span id="cb52-845"><a href="#cb52-845" aria-hidden="true" tabindex="-1"></a><span class="co">    - Ignores any remainder if `height` or `width` is not divisible by `patch_size`</span></span>
<span id="cb52-846"><a href="#cb52-846" aria-hidden="true" tabindex="-1"></a><span class="co">      (i.e., only the `grid_h * patch_size` by `grid_w * patch_size` area is filled).</span></span>
<span id="cb52-847"><a href="#cb52-847" aria-hidden="true" tabindex="-1"></a><span class="co">    - No blending is performed (because there is no overlap).</span></span>
<span id="cb52-848"><a href="#cb52-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-849"><a href="#cb52-849" aria-hidden="true" tabindex="-1"></a><span class="co">    Examples</span></span>
<span id="cb52-850"><a href="#cb52-850" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb52-851"><a href="#cb52-851" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; # Suppose height=width=64, patch_size=32, bands=13</span></span>
<span id="cb52-852"><a href="#cb52-852" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; # patches.shape == (4, 13, 32, 32), ordered row-major</span></span>
<span id="cb52-853"><a href="#cb52-853" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; img = reconstruct_from_patches(patches, 64, 64, 32)</span></span>
<span id="cb52-854"><a href="#cb52-854" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; img.shape</span></span>
<span id="cb52-855"><a href="#cb52-855" aria-hidden="true" tabindex="-1"></a><span class="co">    (13, 64, 64)</span></span>
<span id="cb52-856"><a href="#cb52-856" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-857"><a href="#cb52-857" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> patches.shape[<span class="dv">1</span>]</span>
<span id="cb52-858"><a href="#cb52-858" aria-hidden="true" tabindex="-1"></a>    grid_h <span class="op">=</span> height <span class="op">//</span> patch_size</span>
<span id="cb52-859"><a href="#cb52-859" aria-hidden="true" tabindex="-1"></a>    grid_w <span class="op">=</span> width <span class="op">//</span> patch_size</span>
<span id="cb52-860"><a href="#cb52-860" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> np.zeros((bands, height, width), dtype<span class="op">=</span>patches.dtype)</span>
<span id="cb52-861"><a href="#cb52-861" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb52-862"><a href="#cb52-862" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> r <span class="kw">in</span> <span class="bu">range</span>(grid_h):</span>
<span id="cb52-863"><a href="#cb52-863" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c <span class="kw">in</span> <span class="bu">range</span>(grid_w):</span>
<span id="cb52-864"><a href="#cb52-864" aria-hidden="true" tabindex="-1"></a>            out[:, r<span class="op">*</span>patch_size:(r<span class="op">+</span><span class="dv">1</span>)<span class="op">*</span>patch_size, c <span class="op">*</span></span>
<span id="cb52-865"><a href="#cb52-865" aria-hidden="true" tabindex="-1"></a>                patch_size:(c<span class="op">+</span><span class="dv">1</span>)<span class="op">*</span>patch_size] <span class="op">=</span> patches[idx]</span>
<span id="cb52-866"><a href="#cb52-866" aria-hidden="true" tabindex="-1"></a>            idx <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb52-867"><a href="#cb52-867" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out</span>
<span id="cb52-868"><a href="#cb52-868" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-869"><a href="#cb52-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-872"><a href="#cb52-872" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-873"><a href="#cb52-873" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb52-874"><a href="#cb52-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-875"><a href="#cb52-875" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's assume you have already defined reconstruct_from_patches from above</span></span>
<span id="cb52-876"><a href="#cb52-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-877"><a href="#cb52-877" aria-hidden="true" tabindex="-1"></a><span class="co"># Example parameters</span></span>
<span id="cb52-878"><a href="#cb52-878" aria-hidden="true" tabindex="-1"></a>bands <span class="op">=</span> <span class="dv">3</span>         <span class="co"># e.g., RGB</span></span>
<span id="cb52-879"><a href="#cb52-879" aria-hidden="true" tabindex="-1"></a>height <span class="op">=</span> <span class="dv">8</span>        <span class="co"># image height in pixels</span></span>
<span id="cb52-880"><a href="#cb52-880" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="dv">8</span>         <span class="co"># image width in pixels</span></span>
<span id="cb52-881"><a href="#cb52-881" aria-hidden="true" tabindex="-1"></a>patch_size <span class="op">=</span> <span class="dv">4</span>    <span class="co"># each patch is 4x4 pixels</span></span>
<span id="cb52-882"><a href="#cb52-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-883"><a href="#cb52-883" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of patches needed to cover the image (row-major order)</span></span>
<span id="cb52-884"><a href="#cb52-884" aria-hidden="true" tabindex="-1"></a>grid_h <span class="op">=</span> height <span class="op">//</span> patch_size</span>
<span id="cb52-885"><a href="#cb52-885" aria-hidden="true" tabindex="-1"></a>grid_w <span class="op">=</span> width <span class="op">//</span> patch_size</span>
<span id="cb52-886"><a href="#cb52-886" aria-hidden="true" tabindex="-1"></a>num_patches <span class="op">=</span> grid_h <span class="op">*</span> grid_w</span>
<span id="cb52-887"><a href="#cb52-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-888"><a href="#cb52-888" aria-hidden="true" tabindex="-1"></a><span class="co"># Create random patches (N, bands, patch_size, patch_size)</span></span>
<span id="cb52-889"><a href="#cb52-889" aria-hidden="true" tabindex="-1"></a>patches <span class="op">=</span> np.random.randint(</span>
<span id="cb52-890"><a href="#cb52-890" aria-hidden="true" tabindex="-1"></a>    low<span class="op">=</span><span class="dv">0</span>, high<span class="op">=</span><span class="dv">256</span>,</span>
<span id="cb52-891"><a href="#cb52-891" aria-hidden="true" tabindex="-1"></a>    size<span class="op">=</span>(num_patches, bands, patch_size, patch_size),</span>
<span id="cb52-892"><a href="#cb52-892" aria-hidden="true" tabindex="-1"></a>    dtype<span class="op">=</span>np.uint8</span>
<span id="cb52-893"><a href="#cb52-893" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-894"><a href="#cb52-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-895"><a href="#cb52-895" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Patches shape:"</span>, patches.shape)</span>
<span id="cb52-896"><a href="#cb52-896" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"First patch (band 0):</span><span class="ch">\n</span><span class="st">"</span>, patches[<span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb52-897"><a href="#cb52-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-898"><a href="#cb52-898" aria-hidden="true" tabindex="-1"></a><span class="co"># Reconstruct the image</span></span>
<span id="cb52-899"><a href="#cb52-899" aria-hidden="true" tabindex="-1"></a>reconstructed <span class="op">=</span> reconstruct_from_patches(patches, height, width, patch_size)</span>
<span id="cb52-900"><a href="#cb52-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-901"><a href="#cb52-901" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Reconstructed image shape:"</span>, reconstructed.shape)</span>
<span id="cb52-902"><a href="#cb52-902" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Top-left 4x4 of reconstructed image, band 0:</span><span class="ch">\n</span><span class="st">"</span>,</span>
<span id="cb52-903"><a href="#cb52-903" aria-hidden="true" tabindex="-1"></a>      reconstructed[<span class="dv">0</span>, :<span class="dv">4</span>, :<span class="dv">4</span>])</span>
<span id="cb52-904"><a href="#cb52-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-905"><a href="#cb52-905" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify reconstruction matches original patches in correct positions</span></span>
<span id="cb52-906"><a href="#cb52-906" aria-hidden="true" tabindex="-1"></a><span class="co"># The top-left 4x4 region should be identical to the first patch (band 0)</span></span>
<span id="cb52-907"><a href="#cb52-907" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> np.array_equal(reconstructed[<span class="dv">0</span>, :<span class="dv">4</span>, :<span class="dv">4</span>], patches[<span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb52-908"><a href="#cb52-908" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Verification passed: top-left patch matches the original."</span>)</span>
<span id="cb52-909"><a href="#cb52-909" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-910"><a href="#cb52-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-911"><a href="#cb52-911" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb52-912"><a href="#cb52-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-913"><a href="#cb52-913" aria-hidden="true" tabindex="-1"></a><span class="fu"># Step 4: Tensor Operations &amp; Metadata Encoding</span></span>
<span id="cb52-914"><a href="#cb52-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-915"><a href="#cb52-915" aria-hidden="true" tabindex="-1"></a>**Goal**: Convert numpy arrays to PyTorch tensors and encode metadata.</span>
<span id="cb52-916"><a href="#cb52-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-917"><a href="#cb52-917" aria-hidden="true" tabindex="-1"></a><span class="fu"># 🛠️ Build It: Metadata Encoder</span></span>
<span id="cb52-918"><a href="#cb52-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-921"><a href="#cb52-921" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-922"><a href="#cb52-922" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> encode_metadata(coordinates: np.ndarray) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb52-923"><a href="#cb52-923" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-924"><a href="#cb52-924" aria-hidden="true" tabindex="-1"></a><span class="co">    Encode spatial metadata as features.</span></span>
<span id="cb52-925"><a href="#cb52-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-926"><a href="#cb52-926" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb52-927"><a href="#cb52-927" aria-hidden="true" tabindex="-1"></a><span class="co">        coordinates: (n_patches, 4) array of [min_x, min_y, max_x, max_y]</span></span>
<span id="cb52-928"><a href="#cb52-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-929"><a href="#cb52-929" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb52-930"><a href="#cb52-930" aria-hidden="true" tabindex="-1"></a><span class="co">        encoded: (n_patches, n_features) array</span></span>
<span id="cb52-931"><a href="#cb52-931" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-932"><a href="#cb52-932" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: Calculate spatial features</span></span>
<span id="cb52-933"><a href="#cb52-933" aria-hidden="true" tabindex="-1"></a>    center_x <span class="op">=</span> (coordinates[:, <span class="dv">0</span>] <span class="op">+</span> coordinates[:, <span class="dv">2</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb52-934"><a href="#cb52-934" aria-hidden="true" tabindex="-1"></a>    center_y <span class="op">=</span> (coordinates[:, <span class="dv">1</span>] <span class="op">+</span> coordinates[:, <span class="dv">3</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb52-935"><a href="#cb52-935" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> coordinates[:, <span class="dv">2</span>] <span class="op">-</span> coordinates[:, <span class="dv">0</span>]</span>
<span id="cb52-936"><a href="#cb52-936" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> coordinates[:, <span class="dv">3</span>] <span class="op">-</span> coordinates[:, <span class="dv">1</span>]</span>
<span id="cb52-937"><a href="#cb52-937" aria-hidden="true" tabindex="-1"></a>    area <span class="op">=</span> width <span class="op">*</span> height</span>
<span id="cb52-938"><a href="#cb52-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-939"><a href="#cb52-939" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: Normalize spatial features (handle zero std to avoid divide by zero)</span></span>
<span id="cb52-940"><a href="#cb52-940" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> safe_normalize(values):</span>
<span id="cb52-941"><a href="#cb52-941" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Normalize values, handling zero standard deviation."""</span></span>
<span id="cb52-942"><a href="#cb52-942" aria-hidden="true" tabindex="-1"></a>        mean_val <span class="op">=</span> values.mean()</span>
<span id="cb52-943"><a href="#cb52-943" aria-hidden="true" tabindex="-1"></a>        std_val <span class="op">=</span> values.std()</span>
<span id="cb52-944"><a href="#cb52-944" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> std_val <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb52-945"><a href="#cb52-945" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (values <span class="op">-</span> mean_val) <span class="op">/</span> std_val</span>
<span id="cb52-946"><a href="#cb52-946" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb52-947"><a href="#cb52-947" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.zeros_like(values)  <span class="co"># All values are the same</span></span>
<span id="cb52-948"><a href="#cb52-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-949"><a href="#cb52-949" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> np.column_stack([</span>
<span id="cb52-950"><a href="#cb52-950" aria-hidden="true" tabindex="-1"></a>        safe_normalize(center_x),     <span class="co"># Normalized center X</span></span>
<span id="cb52-951"><a href="#cb52-951" aria-hidden="true" tabindex="-1"></a>        safe_normalize(center_y),     <span class="co"># Normalized center Y</span></span>
<span id="cb52-952"><a href="#cb52-952" aria-hidden="true" tabindex="-1"></a>        safe_normalize(area),         <span class="co"># Normalized area (handles constant area)</span></span>
<span id="cb52-953"><a href="#cb52-953" aria-hidden="true" tabindex="-1"></a>        width <span class="op">/</span> height,               <span class="co"># Aspect ratio</span></span>
<span id="cb52-954"><a href="#cb52-954" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb52-955"><a href="#cb52-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-956"><a href="#cb52-956" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Encoded metadata shape: </span><span class="sc">{</span>features<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-957"><a href="#cb52-957" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Feature statistics:"</span>)</span>
<span id="cb52-958"><a href="#cb52-958" aria-hidden="true" tabindex="-1"></a>    feature_names <span class="op">=</span> [<span class="st">'center_x'</span>, <span class="st">'center_y'</span>, <span class="st">'area'</span>, <span class="st">'aspect_ratio'</span>]</span>
<span id="cb52-959"><a href="#cb52-959" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(feature_names):</span>
<span id="cb52-960"><a href="#cb52-960" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(</span>
<span id="cb52-961"><a href="#cb52-961" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"  </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: mean=</span><span class="sc">{</span>features[:, i]<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss">, std=</span><span class="sc">{</span>features[:, i]<span class="sc">.</span>std()<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb52-962"><a href="#cb52-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-963"><a href="#cb52-963" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> features.astype(np.float32)</span>
<span id="cb52-964"><a href="#cb52-964" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-965"><a href="#cb52-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-968"><a href="#cb52-968" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-969"><a href="#cb52-969" aria-hidden="true" tabindex="-1"></a><span class="co"># Test metadata encoding</span></span>
<span id="cb52-970"><a href="#cb52-970" aria-hidden="true" tabindex="-1"></a>encoded_metadata <span class="op">=</span> encode_metadata(coords)</span>
<span id="cb52-971"><a href="#cb52-971" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-972"><a href="#cb52-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-973"><a href="#cb52-973" aria-hidden="true" tabindex="-1"></a><span class="fu">### 🛠️ Build It: Tensor Conversion</span></span>
<span id="cb52-974"><a href="#cb52-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-977"><a href="#cb52-977" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-978"><a href="#cb52-978" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_tensors(patches: np.ndarray, metadata: np.ndarray) <span class="op">-&gt;</span> Tuple[torch.Tensor, torch.Tensor]:</span>
<span id="cb52-979"><a href="#cb52-979" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-980"><a href="#cb52-980" aria-hidden="true" tabindex="-1"></a><span class="co">    Convert numpy arrays to PyTorch tensors.</span></span>
<span id="cb52-981"><a href="#cb52-981" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb52-982"><a href="#cb52-982" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb52-983"><a href="#cb52-983" aria-hidden="true" tabindex="-1"></a><span class="co">        patches: (n_patches, bands, height, width) array</span></span>
<span id="cb52-984"><a href="#cb52-984" aria-hidden="true" tabindex="-1"></a><span class="co">        metadata: (n_patches, n_features) array</span></span>
<span id="cb52-985"><a href="#cb52-985" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb52-986"><a href="#cb52-986" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb52-987"><a href="#cb52-987" aria-hidden="true" tabindex="-1"></a><span class="co">        patch_tensors: (n_patches, bands, height, width) tensor</span></span>
<span id="cb52-988"><a href="#cb52-988" aria-hidden="true" tabindex="-1"></a><span class="co">        metadata_tensors: (n_patches, n_features) tensor</span></span>
<span id="cb52-989"><a href="#cb52-989" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-990"><a href="#cb52-990" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: Convert to tensors with appropriate dtypes</span></span>
<span id="cb52-991"><a href="#cb52-991" aria-hidden="true" tabindex="-1"></a>    patch_tensors <span class="op">=</span> torch.from_numpy(patches).<span class="bu">float</span>()</span>
<span id="cb52-992"><a href="#cb52-992" aria-hidden="true" tabindex="-1"></a>    metadata_tensors <span class="op">=</span> torch.from_numpy(metadata).<span class="bu">float</span>()</span>
<span id="cb52-993"><a href="#cb52-993" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-994"><a href="#cb52-994" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Patch tensors: </span><span class="sc">{</span>patch_tensors<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, dtype: </span><span class="sc">{</span>patch_tensors<span class="sc">.</span>dtype<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-995"><a href="#cb52-995" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Metadata tensors: </span><span class="sc">{</span>metadata_tensors<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, dtype: </span><span class="sc">{</span>metadata_tensors<span class="sc">.</span>dtype<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-996"><a href="#cb52-996" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-997"><a href="#cb52-997" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> patch_tensors, metadata_tensors</span>
<span id="cb52-998"><a href="#cb52-998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-999"><a href="#cb52-999" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-1000"><a href="#cb52-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1001"><a href="#cb52-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1004"><a href="#cb52-1004" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-1005"><a href="#cb52-1005" aria-hidden="true" tabindex="-1"></a><span class="co"># Create tensors</span></span>
<span id="cb52-1006"><a href="#cb52-1006" aria-hidden="true" tabindex="-1"></a>patch_tensors, metadata_tensors <span class="op">=</span> create_tensors(patches, encoded_metadata)</span>
<span id="cb52-1007"><a href="#cb52-1007" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-1008"><a href="#cb52-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1009"><a href="#cb52-1009" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb52-1010"><a href="#cb52-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1011"><a href="#cb52-1011" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 5: DataLoader Construction</span></span>
<span id="cb52-1012"><a href="#cb52-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1013"><a href="#cb52-1013" aria-hidden="true" tabindex="-1"></a>**Goal**: Build a PyTorch Dataset and DataLoader for training.</span>
<span id="cb52-1014"><a href="#cb52-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1015"><a href="#cb52-1015" aria-hidden="true" tabindex="-1"></a><span class="fu">### 🛠️ Build It: Custom Dataset Class</span></span>
<span id="cb52-1016"><a href="#cb52-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1019"><a href="#cb52-1019" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-1020"><a href="#cb52-1020" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GeospatialDataset(Dataset):</span>
<span id="cb52-1021"><a href="#cb52-1021" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Dataset for geospatial patches with metadata."""</span></span>
<span id="cb52-1022"><a href="#cb52-1022" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1023"><a href="#cb52-1023" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, patch_tensors: torch.Tensor, metadata_tensors: torch.Tensor):</span>
<span id="cb52-1024"><a href="#cb52-1024" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb52-1025"><a href="#cb52-1025" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb52-1026"><a href="#cb52-1026" aria-hidden="true" tabindex="-1"></a><span class="co">            patch_tensors: (n_patches, bands, height, width)</span></span>
<span id="cb52-1027"><a href="#cb52-1027" aria-hidden="true" tabindex="-1"></a><span class="co">            metadata_tensors: (n_patches, n_features)</span></span>
<span id="cb52-1028"><a href="#cb52-1028" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb52-1029"><a href="#cb52-1029" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.patches <span class="op">=</span> patch_tensors</span>
<span id="cb52-1030"><a href="#cb52-1030" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.metadata <span class="op">=</span> metadata_tensors</span>
<span id="cb52-1031"><a href="#cb52-1031" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb52-1032"><a href="#cb52-1032" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: Create dummy labels for demonstration (in real use, load from file)</span></span>
<span id="cb52-1033"><a href="#cb52-1033" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.labels <span class="op">=</span> torch.randint(<span class="dv">0</span>, <span class="dv">5</span>, (<span class="bu">len</span>(patch_tensors),))  <span class="co"># 5 land cover classes</span></span>
<span id="cb52-1034"><a href="#cb52-1034" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb52-1035"><a href="#cb52-1035" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb52-1036"><a href="#cb52-1036" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Return number of patches."""</span></span>
<span id="cb52-1037"><a href="#cb52-1037" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.patches)</span>
<span id="cb52-1038"><a href="#cb52-1038" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1039"><a href="#cb52-1039" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx: <span class="bu">int</span>) <span class="op">-&gt;</span> Tuple[torch.Tensor, torch.Tensor, torch.Tensor]:</span>
<span id="cb52-1040"><a href="#cb52-1040" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb52-1041"><a href="#cb52-1041" aria-hidden="true" tabindex="-1"></a><span class="co">        Get a single item.</span></span>
<span id="cb52-1042"><a href="#cb52-1042" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb52-1043"><a href="#cb52-1043" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb52-1044"><a href="#cb52-1044" aria-hidden="true" tabindex="-1"></a><span class="co">            patch: (bands, height, width) tensor</span></span>
<span id="cb52-1045"><a href="#cb52-1045" aria-hidden="true" tabindex="-1"></a><span class="co">            metadata: (n_features,) tensor  </span></span>
<span id="cb52-1046"><a href="#cb52-1046" aria-hidden="true" tabindex="-1"></a><span class="co">            label: scalar tensor</span></span>
<span id="cb52-1047"><a href="#cb52-1047" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb52-1048"><a href="#cb52-1048" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.patches[idx], <span class="va">self</span>.metadata[idx], <span class="va">self</span>.labels[idx]</span>
<span id="cb52-1049"><a href="#cb52-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1050"><a href="#cb52-1050" aria-hidden="true" tabindex="-1"></a><span class="co"># Test your dataset</span></span>
<span id="cb52-1051"><a href="#cb52-1051" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> GeospatialDataset(patch_tensors, metadata_tensors)</span>
<span id="cb52-1052"><a href="#cb52-1052" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Dataset length: </span><span class="sc">{</span><span class="bu">len</span>(dataset)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1053"><a href="#cb52-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1054"><a href="#cb52-1054" aria-hidden="true" tabindex="-1"></a><span class="co"># Test getting an item</span></span>
<span id="cb52-1055"><a href="#cb52-1055" aria-hidden="true" tabindex="-1"></a>sample_patch, sample_metadata, sample_label <span class="op">=</span> dataset[<span class="dv">0</span>]</span>
<span id="cb52-1056"><a href="#cb52-1056" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Sample patch shape: </span><span class="sc">{</span>sample_patch<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1057"><a href="#cb52-1057" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Sample metadata shape: </span><span class="sc">{</span>sample_metadata<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1058"><a href="#cb52-1058" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Sample label: </span><span class="sc">{</span>sample_label<span class="sc">.</span>item()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1059"><a href="#cb52-1059" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-1060"><a href="#cb52-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1061"><a href="#cb52-1061" aria-hidden="true" tabindex="-1"></a><span class="fu">### 🛠️ Build It: DataLoader</span></span>
<span id="cb52-1062"><a href="#cb52-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1065"><a href="#cb52-1065" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-1066"><a href="#cb52-1066" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Create DataLoader with appropriate batch size and shuffling</span></span>
<span id="cb52-1067"><a href="#cb52-1067" aria-hidden="true" tabindex="-1"></a>dataloader <span class="op">=</span> DataLoader(</span>
<span id="cb52-1068"><a href="#cb52-1068" aria-hidden="true" tabindex="-1"></a>    dataset, </span>
<span id="cb52-1069"><a href="#cb52-1069" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>BATCH_SIZE, </span>
<span id="cb52-1070"><a href="#cb52-1070" aria-hidden="true" tabindex="-1"></a>    shuffle<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb52-1071"><a href="#cb52-1071" aria-hidden="true" tabindex="-1"></a>    num_workers<span class="op">=</span><span class="dv">0</span>,  <span class="co"># Set to 0 for compatibility</span></span>
<span id="cb52-1072"><a href="#cb52-1072" aria-hidden="true" tabindex="-1"></a>    pin_memory<span class="op">=</span><span class="va">True</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="va">False</span></span>
<span id="cb52-1073"><a href="#cb52-1073" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-1074"><a href="#cb52-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1075"><a href="#cb52-1075" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ DataLoader created with batch size </span><span class="sc">{</span>BATCH_SIZE<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1076"><a href="#cb52-1076" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Number of batches: </span><span class="sc">{</span><span class="bu">len</span>(dataloader)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1077"><a href="#cb52-1077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1078"><a href="#cb52-1078" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the DataLoader</span></span>
<span id="cb52-1079"><a href="#cb52-1079" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> batch_idx, (patches, metadata, labels) <span class="kw">in</span> <span class="bu">enumerate</span>(dataloader):</span>
<span id="cb52-1080"><a href="#cb52-1080" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Batch </span><span class="sc">{</span>batch_idx<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb52-1081"><a href="#cb52-1081" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Patches: </span><span class="sc">{</span>patches<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1082"><a href="#cb52-1082" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Metadata: </span><span class="sc">{</span>metadata<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1083"><a href="#cb52-1083" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Labels: </span><span class="sc">{</span>labels<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1084"><a href="#cb52-1084" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> batch_idx <span class="op">==</span> <span class="dv">1</span>:  <span class="co"># Show first two batches</span></span>
<span id="cb52-1085"><a href="#cb52-1085" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb52-1086"><a href="#cb52-1086" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-1087"><a href="#cb52-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1088"><a href="#cb52-1088" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb52-1089"><a href="#cb52-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1090"><a href="#cb52-1090" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 6: Embedding Layer Integration</span></span>
<span id="cb52-1091"><a href="#cb52-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1092"><a href="#cb52-1092" aria-hidden="true" tabindex="-1"></a>**Goal**: Connect to a simple embedding layer to verify end-to-end functionality.</span>
<span id="cb52-1093"><a href="#cb52-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1094"><a href="#cb52-1094" aria-hidden="true" tabindex="-1"></a><span class="fu">### 🛠️ Build It: Simple GFM Embedding Layer</span></span>
<span id="cb52-1095"><a href="#cb52-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1098"><a href="#cb52-1098" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-1099"><a href="#cb52-1099" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SimpleGFMEmbedding(nn.Module):</span>
<span id="cb52-1100"><a href="#cb52-1100" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Simple embedding layer for geospatial patches."""</span></span>
<span id="cb52-1101"><a href="#cb52-1101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1102"><a href="#cb52-1102" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, input_channels: <span class="bu">int</span>, metadata_features: <span class="bu">int</span>, embed_dim: <span class="bu">int</span>, patch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span>):</span>
<span id="cb52-1103"><a href="#cb52-1103" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb52-1104"><a href="#cb52-1104" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb52-1105"><a href="#cb52-1105" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: Build adaptive patch encoder based on patch size</span></span>
<span id="cb52-1106"><a href="#cb52-1106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> patch_size <span class="op">&gt;=</span> <span class="dv">32</span>:</span>
<span id="cb52-1107"><a href="#cb52-1107" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Larger patches: multi-layer CNN</span></span>
<span id="cb52-1108"><a href="#cb52-1108" aria-hidden="true" tabindex="-1"></a>            kernel1 <span class="op">=</span> <span class="bu">min</span>(<span class="dv">8</span>, patch_size <span class="op">//</span> <span class="dv">4</span>)</span>
<span id="cb52-1109"><a href="#cb52-1109" aria-hidden="true" tabindex="-1"></a>            kernel2 <span class="op">=</span> <span class="bu">min</span>(<span class="dv">4</span>, patch_size <span class="op">//</span> <span class="dv">8</span>)</span>
<span id="cb52-1110"><a href="#cb52-1110" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.patch_encoder <span class="op">=</span> nn.Sequential(</span>
<span id="cb52-1111"><a href="#cb52-1111" aria-hidden="true" tabindex="-1"></a>                nn.Conv2d(input_channels, <span class="dv">32</span>, kernel_size<span class="op">=</span>kernel1, stride<span class="op">=</span>kernel1<span class="op">//</span><span class="dv">2</span>),</span>
<span id="cb52-1112"><a href="#cb52-1112" aria-hidden="true" tabindex="-1"></a>                nn.ReLU(),</span>
<span id="cb52-1113"><a href="#cb52-1113" aria-hidden="true" tabindex="-1"></a>                nn.Conv2d(<span class="dv">32</span>, <span class="dv">64</span>, kernel_size<span class="op">=</span>kernel2, stride<span class="op">=</span>kernel2<span class="op">//</span><span class="dv">2</span>), </span>
<span id="cb52-1114"><a href="#cb52-1114" aria-hidden="true" tabindex="-1"></a>                nn.ReLU(),</span>
<span id="cb52-1115"><a href="#cb52-1115" aria-hidden="true" tabindex="-1"></a>                nn.AdaptiveAvgPool2d(<span class="dv">1</span>),</span>
<span id="cb52-1116"><a href="#cb52-1116" aria-hidden="true" tabindex="-1"></a>                nn.Flatten(),</span>
<span id="cb52-1117"><a href="#cb52-1117" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb52-1118"><a href="#cb52-1118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb52-1119"><a href="#cb52-1119" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Smaller patches: simpler encoder</span></span>
<span id="cb52-1120"><a href="#cb52-1120" aria-hidden="true" tabindex="-1"></a>            kernel <span class="op">=</span> <span class="bu">min</span>(<span class="dv">4</span>, patch_size <span class="op">//</span> <span class="dv">2</span>)</span>
<span id="cb52-1121"><a href="#cb52-1121" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.patch_encoder <span class="op">=</span> nn.Sequential(</span>
<span id="cb52-1122"><a href="#cb52-1122" aria-hidden="true" tabindex="-1"></a>                nn.Conv2d(input_channels, <span class="dv">64</span>, kernel_size<span class="op">=</span>kernel, stride<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb52-1123"><a href="#cb52-1123" aria-hidden="true" tabindex="-1"></a>                nn.ReLU(),</span>
<span id="cb52-1124"><a href="#cb52-1124" aria-hidden="true" tabindex="-1"></a>                nn.AdaptiveAvgPool2d(<span class="dv">1</span>),</span>
<span id="cb52-1125"><a href="#cb52-1125" aria-hidden="true" tabindex="-1"></a>                nn.Flatten(),</span>
<span id="cb52-1126"><a href="#cb52-1126" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb52-1127"><a href="#cb52-1127" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb52-1128"><a href="#cb52-1128" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: Build metadata encoder</span></span>
<span id="cb52-1129"><a href="#cb52-1129" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.metadata_encoder <span class="op">=</span> nn.Sequential(</span>
<span id="cb52-1130"><a href="#cb52-1130" aria-hidden="true" tabindex="-1"></a>            nn.Linear(metadata_features, <span class="dv">32</span>),</span>
<span id="cb52-1131"><a href="#cb52-1131" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb52-1132"><a href="#cb52-1132" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">32</span>, <span class="dv">32</span>),</span>
<span id="cb52-1133"><a href="#cb52-1133" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb52-1134"><a href="#cb52-1134" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb52-1135"><a href="#cb52-1135" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: Build fusion layer</span></span>
<span id="cb52-1136"><a href="#cb52-1136" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate patch encoder output size</span></span>
<span id="cb52-1137"><a href="#cb52-1137" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb52-1138"><a href="#cb52-1138" aria-hidden="true" tabindex="-1"></a>            dummy_patch <span class="op">=</span> torch.randn(<span class="dv">1</span>, input_channels, patch_size, patch_size)</span>
<span id="cb52-1139"><a href="#cb52-1139" aria-hidden="true" tabindex="-1"></a>            patch_feat_size <span class="op">=</span> <span class="va">self</span>.patch_encoder(dummy_patch).shape[<span class="dv">1</span>]</span>
<span id="cb52-1140"><a href="#cb52-1140" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb52-1141"><a href="#cb52-1141" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fusion <span class="op">=</span> nn.Sequential(</span>
<span id="cb52-1142"><a href="#cb52-1142" aria-hidden="true" tabindex="-1"></a>            nn.Linear(patch_feat_size <span class="op">+</span> <span class="dv">32</span>, embed_dim),</span>
<span id="cb52-1143"><a href="#cb52-1143" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb52-1144"><a href="#cb52-1144" aria-hidden="true" tabindex="-1"></a>            nn.Linear(embed_dim, embed_dim),</span>
<span id="cb52-1145"><a href="#cb52-1145" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb52-1146"><a href="#cb52-1146" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb52-1147"><a href="#cb52-1147" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, patches: torch.Tensor, metadata: torch.Tensor) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb52-1148"><a href="#cb52-1148" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb52-1149"><a href="#cb52-1149" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb52-1150"><a href="#cb52-1150" aria-hidden="true" tabindex="-1"></a><span class="co">            patches: (batch, channels, height, width)</span></span>
<span id="cb52-1151"><a href="#cb52-1151" aria-hidden="true" tabindex="-1"></a><span class="co">            metadata: (batch, n_features)</span></span>
<span id="cb52-1152"><a href="#cb52-1152" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb52-1153"><a href="#cb52-1153" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb52-1154"><a href="#cb52-1154" aria-hidden="true" tabindex="-1"></a><span class="co">            embeddings: (batch, embed_dim)</span></span>
<span id="cb52-1155"><a href="#cb52-1155" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb52-1156"><a href="#cb52-1156" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: Encode patches and metadata</span></span>
<span id="cb52-1157"><a href="#cb52-1157" aria-hidden="true" tabindex="-1"></a>        patch_features <span class="op">=</span> <span class="va">self</span>.patch_encoder(patches)</span>
<span id="cb52-1158"><a href="#cb52-1158" aria-hidden="true" tabindex="-1"></a>        metadata_features <span class="op">=</span> <span class="va">self</span>.metadata_encoder(metadata)</span>
<span id="cb52-1159"><a href="#cb52-1159" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb52-1160"><a href="#cb52-1160" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: Fuse features</span></span>
<span id="cb52-1161"><a href="#cb52-1161" aria-hidden="true" tabindex="-1"></a>        combined <span class="op">=</span> torch.cat([patch_features, metadata_features], dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb52-1162"><a href="#cb52-1162" aria-hidden="true" tabindex="-1"></a>        embeddings <span class="op">=</span> <span class="va">self</span>.fusion(combined)</span>
<span id="cb52-1163"><a href="#cb52-1163" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb52-1164"><a href="#cb52-1164" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> embeddings</span>
<span id="cb52-1165"><a href="#cb52-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1166"><a href="#cb52-1166" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and test the model</span></span>
<span id="cb52-1167"><a href="#cb52-1167" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> SimpleGFMEmbedding(</span>
<span id="cb52-1168"><a href="#cb52-1168" aria-hidden="true" tabindex="-1"></a>    input_channels<span class="op">=</span>bands, </span>
<span id="cb52-1169"><a href="#cb52-1169" aria-hidden="true" tabindex="-1"></a>    metadata_features<span class="op">=</span>encoded_metadata.shape[<span class="dv">1</span>], </span>
<span id="cb52-1170"><a href="#cb52-1170" aria-hidden="true" tabindex="-1"></a>    embed_dim<span class="op">=</span>EMBEDDING_DIM,</span>
<span id="cb52-1171"><a href="#cb52-1171" aria-hidden="true" tabindex="-1"></a>    patch_size<span class="op">=</span>PATCH_SIZE</span>
<span id="cb52-1172"><a href="#cb52-1172" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-1173"><a href="#cb52-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1174"><a href="#cb52-1174" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Model created"</span>)</span>
<span id="cb52-1175"><a href="#cb52-1175" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Model parameters: </span><span class="sc">{</span><span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> model.parameters())<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb52-1176"><a href="#cb52-1176" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-1177"><a href="#cb52-1177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1178"><a href="#cb52-1178" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb52-1179"><a href="#cb52-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1180"><a href="#cb52-1180" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 7: End-to-End Pipeline Test</span></span>
<span id="cb52-1181"><a href="#cb52-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1182"><a href="#cb52-1182" aria-hidden="true" tabindex="-1"></a>**Goal**: Run the complete pipeline and verify everything works together.</span>
<span id="cb52-1183"><a href="#cb52-1183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1184"><a href="#cb52-1184" aria-hidden="true" tabindex="-1"></a><span class="fu">### 🛠️ Build It: Complete Pipeline Function</span></span>
<span id="cb52-1185"><a href="#cb52-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1188"><a href="#cb52-1188" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-1189"><a href="#cb52-1189" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> geotiff_to_embeddings_pipeline(</span>
<span id="cb52-1190"><a href="#cb52-1190" aria-hidden="true" tabindex="-1"></a>    file_path: Path,</span>
<span id="cb52-1191"><a href="#cb52-1191" aria-hidden="true" tabindex="-1"></a>    patch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span>,</span>
<span id="cb52-1192"><a href="#cb52-1192" aria-hidden="true" tabindex="-1"></a>    stride: <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span>,</span>
<span id="cb52-1193"><a href="#cb52-1193" aria-hidden="true" tabindex="-1"></a>    batch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span>,</span>
<span id="cb52-1194"><a href="#cb52-1194" aria-hidden="true" tabindex="-1"></a>    embed_dim: <span class="bu">int</span> <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb52-1195"><a href="#cb52-1195" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb52-1196"><a href="#cb52-1196" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-1197"><a href="#cb52-1197" aria-hidden="true" tabindex="-1"></a><span class="co">    Complete pipeline from GeoTIFF to embeddings.</span></span>
<span id="cb52-1198"><a href="#cb52-1198" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb52-1199"><a href="#cb52-1199" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb52-1200"><a href="#cb52-1200" aria-hidden="true" tabindex="-1"></a><span class="co">        file_path: Path to GeoTIFF file</span></span>
<span id="cb52-1201"><a href="#cb52-1201" aria-hidden="true" tabindex="-1"></a><span class="co">        patch_size: Size of patches to extract</span></span>
<span id="cb52-1202"><a href="#cb52-1202" aria-hidden="true" tabindex="-1"></a><span class="co">        stride: Step between patches  </span></span>
<span id="cb52-1203"><a href="#cb52-1203" aria-hidden="true" tabindex="-1"></a><span class="co">        batch_size: Batch size for processing</span></span>
<span id="cb52-1204"><a href="#cb52-1204" aria-hidden="true" tabindex="-1"></a><span class="co">        embed_dim: Embedding dimension</span></span>
<span id="cb52-1205"><a href="#cb52-1205" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb52-1206"><a href="#cb52-1206" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb52-1207"><a href="#cb52-1207" aria-hidden="true" tabindex="-1"></a><span class="co">        all_embeddings: (n_patches, embed_dim) tensor</span></span>
<span id="cb52-1208"><a href="#cb52-1208" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-1209"><a href="#cb52-1209" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"🚀 Starting GeoTIFF → Embeddings Pipeline"</span>)</span>
<span id="cb52-1210"><a href="#cb52-1210" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1211"><a href="#cb52-1211" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Load data</span></span>
<span id="cb52-1212"><a href="#cb52-1212" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"📁 Loading GeoTIFF..."</span>)</span>
<span id="cb52-1213"><a href="#cb52-1213" aria-hidden="true" tabindex="-1"></a>    data, metadata <span class="op">=</span> load_geotiff(file_path)</span>
<span id="cb52-1214"><a href="#cb52-1214" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1215"><a href="#cb52-1215" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Preprocess</span></span>
<span id="cb52-1216"><a href="#cb52-1216" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"🔧 Preprocessing..."</span>)</span>
<span id="cb52-1217"><a href="#cb52-1217" aria-hidden="true" tabindex="-1"></a>    norm_data, norm_stats <span class="op">=</span> minmax_normalize(data)</span>
<span id="cb52-1218"><a href="#cb52-1218" aria-hidden="true" tabindex="-1"></a>    cropped_data <span class="op">=</span> crop_to_patches(norm_data, patch_size, stride)</span>
<span id="cb52-1219"><a href="#cb52-1219" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1220"><a href="#cb52-1220" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 3: Extract patches</span></span>
<span id="cb52-1221"><a href="#cb52-1221" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"✂️ Extracting patches..."</span>)</span>
<span id="cb52-1222"><a href="#cb52-1222" aria-hidden="true" tabindex="-1"></a>    patches, coords <span class="op">=</span> extract_patches_with_metadata(cropped_data, patch_size, stride, metadata[<span class="st">'transform'</span>])</span>
<span id="cb52-1223"><a href="#cb52-1223" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1224"><a href="#cb52-1224" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 4: Encode metadata</span></span>
<span id="cb52-1225"><a href="#cb52-1225" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"📊 Encoding metadata..."</span>)</span>
<span id="cb52-1226"><a href="#cb52-1226" aria-hidden="true" tabindex="-1"></a>    encoded_meta <span class="op">=</span> encode_metadata(coords)</span>
<span id="cb52-1227"><a href="#cb52-1227" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1228"><a href="#cb52-1228" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 5: Create tensors</span></span>
<span id="cb52-1229"><a href="#cb52-1229" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"🔢 Creating tensors..."</span>)</span>
<span id="cb52-1230"><a href="#cb52-1230" aria-hidden="true" tabindex="-1"></a>    patch_tensors, meta_tensors <span class="op">=</span> create_tensors(patches, encoded_meta)</span>
<span id="cb52-1231"><a href="#cb52-1231" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1232"><a href="#cb52-1232" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 6: Create dataset and dataloader</span></span>
<span id="cb52-1233"><a href="#cb52-1233" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"📦 Creating DataLoader..."</span>)</span>
<span id="cb52-1234"><a href="#cb52-1234" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> GeospatialDataset(patch_tensors, meta_tensors)</span>
<span id="cb52-1235"><a href="#cb52-1235" aria-hidden="true" tabindex="-1"></a>    dataloader <span class="op">=</span> DataLoader(dataset, batch_size<span class="op">=</span>batch_size, shuffle<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb52-1236"><a href="#cb52-1236" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1237"><a href="#cb52-1237" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 7: Create model and generate embeddings</span></span>
<span id="cb52-1238"><a href="#cb52-1238" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"🧠 Generating embeddings..."</span>)</span>
<span id="cb52-1239"><a href="#cb52-1239" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> SimpleGFMEmbedding(</span>
<span id="cb52-1240"><a href="#cb52-1240" aria-hidden="true" tabindex="-1"></a>        input_channels<span class="op">=</span>data.shape[<span class="dv">0</span>],</span>
<span id="cb52-1241"><a href="#cb52-1241" aria-hidden="true" tabindex="-1"></a>        metadata_features<span class="op">=</span>encoded_meta.shape[<span class="dv">1</span>], </span>
<span id="cb52-1242"><a href="#cb52-1242" aria-hidden="true" tabindex="-1"></a>        embed_dim<span class="op">=</span>embed_dim,</span>
<span id="cb52-1243"><a href="#cb52-1243" aria-hidden="true" tabindex="-1"></a>        patch_size<span class="op">=</span>patch_size</span>
<span id="cb52-1244"><a href="#cb52-1244" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-1245"><a href="#cb52-1245" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb52-1246"><a href="#cb52-1246" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1247"><a href="#cb52-1247" aria-hidden="true" tabindex="-1"></a>    all_embeddings <span class="op">=</span> []</span>
<span id="cb52-1248"><a href="#cb52-1248" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb52-1249"><a href="#cb52-1249" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> patches_batch, meta_batch, _ <span class="kw">in</span> dataloader:</span>
<span id="cb52-1250"><a href="#cb52-1250" aria-hidden="true" tabindex="-1"></a>            embeddings <span class="op">=</span> model(patches_batch, meta_batch)</span>
<span id="cb52-1251"><a href="#cb52-1251" aria-hidden="true" tabindex="-1"></a>            all_embeddings.append(embeddings)</span>
<span id="cb52-1252"><a href="#cb52-1252" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1253"><a href="#cb52-1253" aria-hidden="true" tabindex="-1"></a>    all_embeddings <span class="op">=</span> torch.cat(all_embeddings, dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb52-1254"><a href="#cb52-1254" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✅ Pipeline complete! Generated </span><span class="sc">{</span><span class="bu">len</span>(all_embeddings)<span class="sc">}</span><span class="ss"> embeddings"</span>)</span>
<span id="cb52-1255"><a href="#cb52-1255" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1256"><a href="#cb52-1256" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> all_embeddings</span>
<span id="cb52-1257"><a href="#cb52-1257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1258"><a href="#cb52-1258" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the complete pipeline</span></span>
<span id="cb52-1259"><a href="#cb52-1259" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> geotiff_to_embeddings_pipeline(SAMPLE_PATH)</span>
<span id="cb52-1260"><a href="#cb52-1260" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🎉 Final Result:"</span>)</span>
<span id="cb52-1261"><a href="#cb52-1261" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Embeddings shape: </span><span class="sc">{</span>embeddings<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1262"><a href="#cb52-1262" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Embedding statistics:"</span>)</span>
<span id="cb52-1263"><a href="#cb52-1263" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Mean: </span><span class="sc">{</span>embeddings<span class="sc">.</span>mean()<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb52-1264"><a href="#cb52-1264" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Std: </span><span class="sc">{</span>embeddings<span class="sc">.</span>std()<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb52-1265"><a href="#cb52-1265" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Min: </span><span class="sc">{</span>embeddings<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb52-1266"><a href="#cb52-1266" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Max: </span><span class="sc">{</span>embeddings<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb52-1267"><a href="#cb52-1267" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-1268"><a href="#cb52-1268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1269"><a href="#cb52-1269" aria-hidden="true" tabindex="-1"></a><span class="fu">### 🔍 Verify It: Pipeline Output Analysis</span></span>
<span id="cb52-1270"><a href="#cb52-1270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1273"><a href="#cb52-1273" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-1274"><a href="#cb52-1274" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize embedding similarities</span></span>
<span id="cb52-1275"><a href="#cb52-1275" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"🔍 Analyzing embedding relationships..."</span>)</span>
<span id="cb52-1276"><a href="#cb52-1276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1277"><a href="#cb52-1277" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if we have enough embeddings for analysis</span></span>
<span id="cb52-1278"><a href="#cb52-1278" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(embeddings) <span class="op">&lt;</span> <span class="dv">10</span>:</span>
<span id="cb52-1279"><a href="#cb52-1279" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"⚠️ Only </span><span class="sc">{</span><span class="bu">len</span>(embeddings)<span class="sc">}</span><span class="ss"> embeddings available, using all of them"</span>)</span>
<span id="cb52-1280"><a href="#cb52-1280" aria-hidden="true" tabindex="-1"></a>    sample_size <span class="op">=</span> <span class="bu">len</span>(embeddings)</span>
<span id="cb52-1281"><a href="#cb52-1281" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb52-1282"><a href="#cb52-1282" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Using first 10 of </span><span class="sc">{</span><span class="bu">len</span>(embeddings)<span class="sc">}</span><span class="ss"> embeddings for similarity analysis"</span>)</span>
<span id="cb52-1283"><a href="#cb52-1283" aria-hidden="true" tabindex="-1"></a>    sample_size <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb52-1284"><a href="#cb52-1284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1285"><a href="#cb52-1285" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> sample_size <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb52-1286"><a href="#cb52-1286" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute pairwise cosine similarities</span></span>
<span id="cb52-1287"><a href="#cb52-1287" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> torch.nn.functional <span class="im">import</span> cosine_similarity</span>
<span id="cb52-1288"><a href="#cb52-1288" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1289"><a href="#cb52-1289" aria-hidden="true" tabindex="-1"></a>    sample_embeddings <span class="op">=</span> embeddings[:sample_size]</span>
<span id="cb52-1290"><a href="#cb52-1290" aria-hidden="true" tabindex="-1"></a>    similarity_matrix <span class="op">=</span> torch.zeros(sample_size, sample_size)</span>
<span id="cb52-1291"><a href="#cb52-1291" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1292"><a href="#cb52-1292" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(sample_size):</span>
<span id="cb52-1293"><a href="#cb52-1293" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(sample_size):</span>
<span id="cb52-1294"><a href="#cb52-1294" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">==</span> j:</span>
<span id="cb52-1295"><a href="#cb52-1295" aria-hidden="true" tabindex="-1"></a>                similarity_matrix[i, j] <span class="op">=</span> <span class="fl">1.0</span>  <span class="co"># Perfect self-similarity</span></span>
<span id="cb52-1296"><a href="#cb52-1296" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb52-1297"><a href="#cb52-1297" aria-hidden="true" tabindex="-1"></a>                sim <span class="op">=</span> cosine_similarity(sample_embeddings[i:i<span class="op">+</span><span class="dv">1</span>], sample_embeddings[j:j<span class="op">+</span><span class="dv">1</span>], dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb52-1298"><a href="#cb52-1298" aria-hidden="true" tabindex="-1"></a>                similarity_matrix[i, j] <span class="op">=</span> sim.item()</span>
<span id="cb52-1299"><a href="#cb52-1299" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1300"><a href="#cb52-1300" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot similarity matrix</span></span>
<span id="cb52-1301"><a href="#cb52-1301" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb52-1302"><a href="#cb52-1302" aria-hidden="true" tabindex="-1"></a>    plt.imshow(similarity_matrix.numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>, vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb52-1303"><a href="#cb52-1303" aria-hidden="true" tabindex="-1"></a>    plt.colorbar(label<span class="op">=</span><span class="st">'Cosine Similarity'</span>)</span>
<span id="cb52-1304"><a href="#cb52-1304" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f'Embedding Similarity Matrix (First </span><span class="sc">{</span>sample_size<span class="sc">}</span><span class="ss"> Patches)'</span>)</span>
<span id="cb52-1305"><a href="#cb52-1305" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Patch Index'</span>)</span>
<span id="cb52-1306"><a href="#cb52-1306" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'Patch Index'</span>)</span>
<span id="cb52-1307"><a href="#cb52-1307" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb52-1308"><a href="#cb52-1308" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1309"><a href="#cb52-1309" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Average similarity: </span><span class="sc">{</span>similarity_matrix<span class="sc">.</span>mean()<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb52-1310"><a href="#cb52-1310" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Similarity range: </span><span class="sc">{</span>similarity_matrix<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss"> to </span><span class="sc">{</span>similarity_matrix<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb52-1311"><a href="#cb52-1311" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb52-1312"><a href="#cb52-1312" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"⚠️ Not enough embeddings for similarity analysis"</span>)</span>
<span id="cb52-1313"><a href="#cb52-1313" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-1314"><a href="#cb52-1314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1315"><a href="#cb52-1315" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb52-1316"><a href="#cb52-1316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1317"><a href="#cb52-1317" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusion</span></span>
<span id="cb52-1318"><a href="#cb52-1318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1319"><a href="#cb52-1319" aria-hidden="true" tabindex="-1"></a>🎉 **Congratulations!** You've successfully built a complete pipeline that transforms raw satellite imagery into model-ready embeddings. </span>
<span id="cb52-1320"><a href="#cb52-1320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1321"><a href="#cb52-1321" aria-hidden="true" tabindex="-1"></a><span class="fu">### What You Built:</span></span>
<span id="cb52-1322"><a href="#cb52-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1323"><a href="#cb52-1323" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**GeoTIFF Loader**: Extracts both pixel data and spatial metadata</span>
<span id="cb52-1324"><a href="#cb52-1324" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Preprocessing Functions**: Normalization and spatial cropping  </span>
<span id="cb52-1325"><a href="#cb52-1325" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Patch Extractor**: Creates patches while preserving spatial context</span>
<span id="cb52-1326"><a href="#cb52-1326" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Metadata Encoder**: Transforms coordinates into learned features</span>
<span id="cb52-1327"><a href="#cb52-1327" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**PyTorch Integration**: Dataset, DataLoader, and model components</span>
<span id="cb52-1328"><a href="#cb52-1328" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Embedding Generator**: Simple CNN that produces vector representations</span>
<span id="cb52-1329"><a href="#cb52-1329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1330"><a href="#cb52-1330" aria-hidden="true" tabindex="-1"></a><span class="fu">### Key Insights:</span></span>
<span id="cb52-1331"><a href="#cb52-1331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1332"><a href="#cb52-1332" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Spatial Context Matters**: Each patch carries location information</span>
<span id="cb52-1333"><a href="#cb52-1333" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Preprocessing is Critical**: Normalization ensures stable training  </span>
<span id="cb52-1334"><a href="#cb52-1334" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Modular Design**: Each step can be optimized independently</span>
<span id="cb52-1335"><a href="#cb52-1335" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**End-to-End Testing**: Verify the complete pipeline works</span>
<span id="cb52-1336"><a href="#cb52-1336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1337"><a href="#cb52-1337" aria-hidden="true" tabindex="-1"></a><span class="fu">### What's Next:</span></span>
<span id="cb52-1338"><a href="#cb52-1338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1339"><a href="#cb52-1339" aria-hidden="true" tabindex="-1"></a>In the following sessions, you'll enhance each component:</span>
<span id="cb52-1340"><a href="#cb52-1340" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Week 2**: Advanced attention mechanisms for spatial relationships</span>
<span id="cb52-1341"><a href="#cb52-1341" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Week 3**: Complete GFM architecture with transformer blocks</span>
<span id="cb52-1342"><a href="#cb52-1342" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Week 4**: Pretraining strategies and masked autoencoding</span>
<span id="cb52-1343"><a href="#cb52-1343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1344"><a href="#cb52-1344" aria-hidden="true" tabindex="-1"></a>The pipeline you built today forms the foundation for everything that follows! 🚀</span>
<span id="cb52-1345"><a href="#cb52-1345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1346"><a href="#cb52-1346" aria-hidden="true" tabindex="-1"></a><span class="fu">## Resources</span></span>
<span id="cb52-1347"><a href="#cb52-1347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1348"><a href="#cb52-1348" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">PyTorch DataLoader Documentation</span><span class="co">](https://pytorch.org/docs/stable/data.html)</span></span>
<span id="cb52-1349"><a href="#cb52-1349" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Rasterio User Guide</span><span class="co">](https://rasterio.readthedocs.io/)</span></span>
<span id="cb52-1350"><a href="#cb52-1350" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Geospatial Foundation Model Examples</span><span class="co">](../extras/examples/normalization_comparison.qmd)</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/geog-logo.png" class="img-fluid figure-img" width="250"></p>
<figcaption>Department of Geography logo</figcaption>
</figure>
</div>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This website is built with <a href="https://github.com/environmental-data-science/geog-288kc-geospatial-foundation-models"><i class="fa-brands fa-github" title="the github octocat logo" aria-label="github"></i></a> and <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>